<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tri Stats</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" href="favicon.svg">
  <meta name="theme-color" content="#171717">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=BBH+Bartle&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <style>
    /* ============================================
       DESIGN SYSTEM - Minimal, OpenAI-inspired
       ============================================ */

    :root {
      /* Colors - Light (warm, soft palette) */
      --bg-primary: #ffffff;
      --bg-secondary: #f9f9f9;
      --bg-tertiary: #f3f3f3;
      --bg-elevated: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --text-tertiary: #999999;
      --border-primary: rgba(0,0,0,0.06);
      --border-secondary: rgba(0,0,0,0.1);

      /* Accent - subtle green for performance indicators */
      --accent: #1a1a1a;
      --accent-hover: #333333;
      --accent-subtle: rgba(0,0,0,0.03);
      --accent-green: #10a37f;

      /* Semantic */
      --success: #10a37f;
      --warning: #f59e0b;
      --error: #ef4444;
      --gold: #ca8a04;
      --silver: #71717a;
      --bronze: #c2410c;

      /* Shadows - barely perceptible */
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.02);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.03);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.04);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.06);
      --shadow-elevated: 0 12px 40px rgba(0,0,0,0.08);

      /* Spacing - generous whitespace */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-16: 64px;

      /* Radii - subtle curves */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-2xl: 24px;
      --radius-full: 9999px;

      /* Typography Scale */
      --text-xs: 13px;
      --text-sm: 15px;
      --text-base: 17px;
      --text-lg: 20px;
      --text-xl: 26px;
      --text-2xl: 34px;
      --text-3xl: 44px;
      --text-4xl: 58px;

      /* Transitions */
      --transition-fast: 0.1s ease;
      --transition-base: 0.15s ease;
      --transition-slow: 0.25s ease;
    }

    [data-theme="dark"] {
      --bg-primary: #0d0d0d;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #262626;
      --bg-elevated: #1f1f1f;
      --text-primary: #ececec;
      --text-secondary: #a0a0a0;
      --text-tertiary: #666666;
      --border-primary: rgba(255,255,255,0.06);
      --border-secondary: rgba(255,255,255,0.1);
      --accent: #ececec;
      --accent-hover: #ffffff;
      --accent-subtle: rgba(255,255,255,0.03);
      --shadow-xs: none;
      --shadow-sm: none;
      --shadow-md: 0 4px 16px rgba(0,0,0,0.2);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.3);
      --shadow-elevated: 0 12px 40px rgba(0,0,0,0.4);
    }

    /* Reset */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Base */
    html {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    body {
      font-family: "Inter", sans-serif;
      font-optical-sizing: auto;
      font-size: var(--text-base);
      line-height: 1.7;
      color: var(--text-primary);
      background: var(--bg-primary);
      min-height: 100vh;
      transition: background-color var(--transition-slow), color var(--transition-slow);
    }

    /* Layout */
    .app {
      max-width: 1000px;
      margin: 0 auto;
      padding: var(--space-6) var(--space-8);
      padding-top: calc(56px + var(--space-10));
    }

    /* Navigation - minimal, floating */
    .nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
    }

    [data-theme="dark"] .nav {
      background: rgba(13,13,13,0.85);
    }

    .nav-inner {
      max-width: 1000px;
      margin: 0 auto;
      padding: var(--space-3) var(--space-8);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-6);
    }

    .nav-brand {
      font-family: "BBH Bartle", serif;
      font-size: var(--text-xl);
      font-weight: 400;
      color: var(--text-primary);
      letter-spacing: 0;
      text-decoration: none;
      cursor: pointer;
      transition: opacity var(--transition-fast);
    }

    .nav-brand:hover {
      opacity: 0.6;
    }

    @media (max-width: 768px) {
      .nav-brand {
        font-size: var(--text-lg);
      }
    }

    @media (max-width: 480px) {
      .nav-brand {
        font-size: var(--text-base);
      }
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    /* Theme Toggle */
    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .theme-toggle:hover {
      background: var(--accent-subtle);
    }

    .theme-toggle svg {
      width: 16px;
      height: 16px;
      stroke: var(--text-secondary);
      fill: none;
      stroke-width: 1.5;
      transition: stroke var(--transition-fast);
    }

    .theme-toggle:hover svg {
      stroke: var(--text-primary);
    }

    .theme-toggle .icon-moon {
      display: none;
    }

    [data-theme="dark"] .theme-toggle .icon-sun {
      display: none;
    }

    [data-theme="dark"] .theme-toggle .icon-moon {
      display: block;
    }

    /* Nav Search - Expandable */
    .nav-search {
      position: relative;
      display: flex;
      align-items: center;
    }

    .nav-search-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .nav-search-btn:hover {
      background: var(--accent-subtle);
    }

    .nav-search-btn svg {
      width: 18px;
      height: 18px;
      stroke: var(--text-secondary);
      fill: none;
      stroke-width: 2;
      transition: stroke var(--transition-fast);
    }

    .nav-search-btn:hover svg {
      stroke: var(--text-primary);
    }

    .nav-search-expanded {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      opacity: 0;
      pointer-events: none;
      transition: width var(--transition-base), opacity var(--transition-base);
      z-index: 200;
    }

    .nav-search.is-open .nav-search-expanded {
      width: 320px;
      opacity: 1;
      pointer-events: auto;
    }

    @media (max-width: 480px) {
      .nav-search.is-open .nav-search-expanded {
        position: fixed;
        right: 12px;
        left: 12px;
        width: auto;
        top: 8px;
        transform: none;
      }
    }

    .nav-search.is-open .nav-search-btn {
      display: none;
    }

    .nav-search-input-wrapper {
      display: flex;
      align-items: center;
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }

    .nav-search-input {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      font-family: inherit;
      font-size: var(--text-sm);
      color: var(--text-primary);
      background: transparent;
      border: none;
      outline: none;
      min-width: 0;
    }

    .nav-search-input::placeholder {
      color: var(--text-tertiary);
    }

    .nav-search-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      margin-right: 4px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .nav-search-close:hover {
      background: var(--accent-subtle);
    }

    .nav-search-close svg {
      width: 14px;
      height: 14px;
      stroke: var(--text-tertiary);
      stroke-width: 2;
    }

    /* AI Search Toggle */
    .nav-ai-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      margin-left: 4px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      flex-shrink: 0;
    }

    .nav-ai-toggle svg {
      width: 16px;
      height: 16px;
      stroke: var(--text-tertiary);
      transition: all var(--transition-fast);
    }

    .nav-ai-toggle:hover {
      background: var(--accent-subtle);
    }

    .nav-ai-toggle:hover svg {
      stroke: var(--text-secondary);
    }

    .nav-ai-toggle.is-active {
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
    }

    .nav-ai-toggle.is-active svg {
      stroke: white;
    }

    .nav-ai-toggle.is-active:hover {
      background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
    }

    /* AI mode indicator in search */
    .nav-search-input.ai-mode {
      padding-left: var(--space-3);
    }

    .nav-search-input.ai-mode::placeholder {
      color: #8b5cf6;
    }

    [data-theme="dark"] .nav-search-input.ai-mode::placeholder {
      color: #a78bfa;
    }

    /* AI Response Card */
    .ai-response-card {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%);
      border: 1px solid rgba(139, 92, 246, 0.15);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
    }

    .ai-response-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-3);
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #8b5cf6;
    }

    .ai-response-header svg {
      width: 14px;
      height: 14px;
    }

    .ai-response-text {
      font-size: var(--text-base);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .ai-response-thinking {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      color: var(--text-secondary);
      font-size: var(--text-sm);
    }

    .ai-response-thinking .loading-spinner {
      width: 16px;
      height: 16px;
      border-width: 2px;
      border-top-color: #8b5cf6;
    }

    /* Event Cards */
    .events-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .event-card {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--bg-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .event-card:hover {
      border-color: var(--accent);
      background: var(--bg-secondary);
      transform: translateX(4px);
    }

    .event-card.event-past {
      opacity: 0.6;
    }

    .event-card-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 48px;
      padding: var(--space-2) var(--space-3);
      background: var(--accent);
      border-radius: var(--radius-md);
      color: white;
    }

    .event-card.event-past .event-card-date {
      background: var(--text-tertiary);
    }

    .event-card-day {
      font-size: var(--text-lg);
      font-weight: 700;
      line-height: 1;
    }

    .event-card-month {
      font-size: var(--text-xs);
      text-transform: uppercase;
      font-weight: 500;
      letter-spacing: 0.05em;
    }

    .event-card-info {
      flex: 1;
      min-width: 0;
    }

    .event-card-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-card-location {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .event-card-country {
      padding: 2px 6px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: 500;
    }

    .event-card-arrow {
      color: var(--text-tertiary);
      font-size: var(--text-xl);
      transition: transform 0.15s ease;
    }

    .event-card:hover .event-card-arrow {
      transform: translateX(4px);
      color: var(--accent);
    }

    /* Calendar View */
    .calendar-view {
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
    }

    .calendar-month {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .calendar-month-title {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--text-primary);
      padding-bottom: var(--space-2);
      border-bottom: 2px solid var(--accent);
      margin: 0;
    }

    .nav-search-autocomplete {
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      width: 320px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-elevated);
      overflow: hidden;
      z-index: 1000;
    }

    /* Recent AI Searches */
    .recent-ai-searches {
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      width: 320px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-elevated);
      padding: var(--space-3);
      z-index: 1000;
    }

    .recent-ai-searches-title {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      margin-bottom: var(--space-2);
    }

    .recent-ai-searches-list {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .recent-ai-chip {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: var(--radius-full);
      padding: var(--space-1) var(--space-3);
      font-size: var(--text-xs);
      color: #8b5cf6;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .recent-ai-chip:hover {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(99, 102, 241, 0.2) 100%);
      border-color: rgba(139, 92, 246, 0.4);
    }

    [data-theme="dark"] .recent-ai-chip {
      color: #a78bfa;
    }

    /* Navigation Toolbar */
    .search-toolbar {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: var(--space-4);
      padding: var(--space-4) 0;
      margin-bottom: var(--space-6);
    }

    .search-toolbar .search-wrapper {
      display: none;
    }

    .toolbar-hint {
      display: none;
    }

    .toolbar-hint kbd {
      font-family: 'SF Mono', ui-monospace, monospace;
      font-size: 10px;
      padding: 3px 6px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      color: var(--text-tertiary);
    }

    /* Search - clean, minimal */
    .search-wrapper {
      flex: 1;
      max-width: 400px;
      position: relative;
      z-index: 100;
    }

    .search-box {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      padding-right: 72px;
      font-family: inherit;
      font-size: var(--text-sm);
      color: var(--text-primary);
      background: var(--bg-secondary);
      border: 1px solid transparent;
      border-radius: var(--radius-lg);
      outline: none;
      transition: all var(--transition-base);
    }

    .search-input:hover {
      background: var(--bg-tertiary);
    }

    .search-input:focus {
      background: var(--bg-primary);
      border-color: var(--border-secondary);
      box-shadow: var(--shadow-md);
    }

    .search-input::placeholder {
      color: var(--text-tertiary);
    }

    .search-btn {
      position: absolute;
      right: 4px;
      top: 4px;
      bottom: 4px;
      padding: 0 var(--space-4);
      font-family: inherit;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--bg-primary);
      background: var(--accent);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: opacity var(--transition-fast);
    }

    .search-btn:hover {
      opacity: 0.85;
    }

    /* Quick Actions - ghost buttons */
    .quick-actions {
      display: flex;
      gap: var(--space-1);
    }

    .quick-btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      font-family: inherit;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-decoration: none;
    }

    .quick-btn:hover {
      color: var(--text-primary);
      background: var(--accent-subtle);
    }

    .quick-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Autocomplete - floating dropdown */
    .autocomplete-results {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--bg-elevated);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-elevated);
      overflow: hidden;
      z-index: 1000;
    }

    .autocomplete-item {
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      color: var(--text-primary);
      cursor: pointer;
      transition: background var(--transition-fast);
      outline: none;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .autocomplete-item:hover {
      background: var(--accent-subtle);
    }

    .autocomplete-item.is-active,
    .autocomplete-item:focus {
      background: var(--accent-subtle);
    }

    .autocomplete-type {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      flex-shrink: 0;
    }

    .autocomplete-type.athlete {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .autocomplete-type.event {
      background: rgba(16, 163, 127, 0.1);
      color: #10a37f;
    }

    .autocomplete-event-title {
      flex: 1;
      white-space: normal;
      line-height: 1.3;
    }

    .autocomplete-event-date {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      flex-shrink: 0;
    }

    .autocomplete-loading, .autocomplete-empty {
      padding: var(--space-4);
      text-align: center;
      color: var(--text-tertiary);
      font-size: var(--text-sm);
    }

    .autocomplete-loading::before {
      content: '';
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 1.5px solid var(--border-secondary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: var(--space-2);
      vertical-align: middle;
    }

    /* Photo Grid - Visual Home Display */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: var(--space-3);
    }

    .photo-card {
      display: block;
      position: relative;
      aspect-ratio: 4/3;
      overflow: hidden;
      cursor: pointer;
      background: var(--bg-tertiary);
      text-decoration: none;
      border-radius: var(--radius-xl);
    }

    .photo-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform var(--transition-slow);
    }

    .photo-card:hover img {
      transform: scale(1.03);
    }

    .photo-card-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 60%);
      opacity: 0;
      transition: opacity var(--transition-base);
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: var(--space-4);
      border-radius: var(--radius-xl);
    }

    .photo-card:hover .photo-card-overlay {
      opacity: 1;
    }

    .photo-card-name {
      font-size: var(--text-sm);
      font-weight: 600;
      color: white;
      margin-bottom: 2px;
    }

    .photo-card-country {
      font-size: var(--text-xs);
      color: rgba(255,255,255,0.7);
    }

    .photo-card-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      font-weight: 600;
      color: var(--text-tertiary);
      background: var(--bg-tertiary);
    }

    /* Channel Cards */
    .channel-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
    }

    @media (max-width: 600px) {
      .channel-grid {
        grid-template-columns: 1fr;
      }
    }

    .channel-card {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      text-decoration: none;
      transition: background var(--transition-fast);
    }

    .channel-card:hover {
      background: var(--bg-tertiary);
    }

    .channel-logo {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      overflow: hidden;
      flex-shrink: 0;
    }

    .channel-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .channel-logo-text {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xs);
      font-weight: 700;
      color: #fff;
    }

    .channel-logo-text.wt { background: #0033a0; }
    .channel-logo-text.pto { background: #000; }
    .channel-logo-text.im { background: #e31837; }
    .channel-logo-text.slt { background: #00d4ff; color: #000; }

    .channel-info {
      flex: 1;
      min-width: 0;
    }

    .channel-name {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .channel-desc {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
    }

    .home-section {
      margin-bottom: var(--space-12);
    }

    .home-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-5);
    }

    .home-section-title {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-tertiary);
    }

    .home-section-link {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      text-decoration: none;
      transition: color var(--transition-fast);
    }

    .home-section-link:hover {
      color: var(--text-primary);
    }

    /* Table of Contents Navigation */
    .home-toc {
      position: sticky;
      top: calc(56px + var(--space-4));
      z-index: 10;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-primary);
      padding: var(--space-4) 0;
      margin-bottom: var(--space-8);
      margin-top: calc(-1 * var(--space-6));
    }

    .home-toc-nav {
      display: flex;
      gap: var(--space-4);
      flex-wrap: wrap;
      align-items: center;
    }

    .home-toc-link {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      text-decoration: none;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      font-weight: 500;
    }

    .home-toc-link:hover {
      color: var(--text-primary);
      background: var(--accent-subtle);
    }

    .home-toc-link.active {
      color: var(--accent);
      background: var(--accent-subtle);
    }

    @media (max-width: 640px) {
      .home-toc {
        top: 56px;
        padding: var(--space-3) 0;
        margin-top: calc(-1 * var(--space-4));
      }

      .home-toc-nav {
        gap: var(--space-2);
      }

      .home-toc-link {
        font-size: var(--text-xs);
        padding: var(--space-1) var(--space-2);
      }
    }

    /* Scroll offset for anchor links */
    .home-section {
      scroll-margin-top: calc(56px + var(--space-8) + 60px);
    }

    /* News Articles */
    .news-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .news-item {
      display: flex;
      flex-direction: row;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-primary);
      transition: all var(--transition-fast);
      text-decoration: none;
      color: inherit;
      overflow: hidden;
    }

    .news-item:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-secondary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .news-item-image {
      width: 200px;
      min-width: 200px;
      height: 140px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      background: var(--bg-tertiary);
      flex-shrink: 0;
    }

    .news-item-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
    }

    .news-item-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: var(--space-3);
      margin-bottom: var(--space-2);
    }

    .news-item-title {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.4;
      flex: 1;
    }

    .news-item-date {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .news-item-excerpt {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      line-height: 1.5;
      margin-top: var(--space-2);
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .news-item-link {
      margin-top: var(--space-3);
      font-size: var(--text-xs);
      color: var(--accent);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .news-item:hover .news-item-link {
      color: var(--accent-hover);
    }

    /* Featured first article */
    .news-item:first-child {
      flex-direction: column;
      padding: 0;
      background: transparent;
      border: none;
    }

    .news-item:first-child .news-item-image {
      width: 100%;
      min-width: 100%;
      height: 240px;
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
    }

    .news-item:first-child .news-item-content {
      padding: var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-primary);
    }

    .news-item:first-child:hover .news-item-content {
      background: var(--bg-tertiary);
      border-color: var(--border-secondary);
    }

    .news-item:first-child .news-item-title {
      font-size: var(--text-lg);
    }

    .news-item:first-child .news-item-excerpt {
      -webkit-line-clamp: 4;
      line-clamp: 4;
      font-size: var(--text-base);
    }

    /* Mobile responsive */
    @media (max-width: 640px) {
      .news-item {
        flex-direction: column;
        gap: var(--space-3);
      }

      .news-item-image {
        width: 100%;
        min-width: 100%;
        height: 180px;
      }

      .news-item:first-child .news-item-image {
        height: 200px;
      }

      .news-item:first-child .news-item-title {
        font-size: var(--text-base);
      }
    }

    /* Results Section */
    .results-section {
      padding-top: var(--space-6);
    }

    .section-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: var(--space-8);
    }

    .section-title {
      font-size: var(--text-2xl);
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    .section-meta {
      font-size: var(--text-sm);
      color: var(--text-tertiary);
    }

    .athlete-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-6);
    }

    @media (min-width: 900px) {
      .athlete-list {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    /* Rankings Grid */
    .rankings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-10);
      align-items: start;
    }

    @media (max-width: 768px) {
      .rankings-grid {
        grid-template-columns: 1fr;
      }
    }

    .ranking-column-title {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-tertiary);
      margin-bottom: var(--space-4);
    }

    .ranking-column {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    /* Compact Ranking Items - borderless, clean */
    .ranking-item {
      display: grid;
      grid-template-columns: 32px 56px 1fr auto;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-3) var(--space-2);
      background: transparent;
      cursor: pointer;
      transition: background var(--transition-fast);
      border-radius: var(--radius-lg);
      margin: 0 calc(-1 * var(--space-2));
    }

    .ranking-item:hover {
      background: var(--accent-subtle);
    }

    .ranking-item-rank {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-tertiary);
      text-align: center;
    }

    .ranking-item-rank.top3 {
      color: var(--text-primary);
    }

    .ranking-item-photo {
      width: 56px;
      height: 56px;
      object-fit: cover;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
    }

    .ranking-item-placeholder {
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      color: var(--text-tertiary);
      font-size: var(--text-sm);
      font-weight: 600;
      border-radius: var(--radius-md);
    }

    .ranking-item-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .ranking-item-name {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ranking-item-country {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      font-weight: 400;
    }

    .ranking-item-flag {
      height: 12px;
      border-radius: 2px;
    }

    .ranking-item-arrow {
      color: var(--text-tertiary);
      font-size: var(--text-sm);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .ranking-item:hover .ranking-item-arrow {
      opacity: 1;
    }

    /* Back Button for Detail View */
    .back-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      height: 32px;
      padding: 0 var(--space-3);
      font-family: inherit;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      margin-bottom: var(--space-6);
      margin-left: calc(-1 * var(--space-3));
      transition: all var(--transition-fast);
    }

    .back-btn:hover {
      color: var(--text-primary);
      background: var(--accent-subtle);
    }

    /* Athlete Cards - Clean, minimal profile style */
    .athlete-card {
      background: var(--bg-primary);
      overflow: hidden;
      margin-bottom: var(--space-8);
    }

    .athlete-hero {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: var(--space-8);
      padding: var(--space-8) 0;
    }

    .athlete-photo {
      position: relative;
    }

    .athlete-avatar {
      width: 180px;
      height: 220px;
      object-fit: cover;
      background: var(--bg-tertiary);
      border-radius: var(--radius-xl);
    }

    .athlete-placeholder {
      width: 180px;
      height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-secondary);
      color: var(--text-tertiary);
      font-size: var(--text-3xl);
      font-weight: 600;
      border-radius: var(--radius-xl);
    }

    .athlete-rank {
      position: absolute;
      top: var(--space-3);
      left: var(--space-3);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      font-size: var(--text-xs);
      font-weight: 600;
      color: white;
      background: var(--accent);
      border-radius: var(--radius-md);
    }

    .athlete-rank.gold {
      background: var(--gold);
    }

    .athlete-rank.silver {
      background: var(--silver);
    }

    .athlete-rank.bronze {
      background: var(--bronze);
    }

    .athlete-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .athlete-header {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-1);
    }

    .athlete-name {
      font-size: var(--text-3xl);
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .athlete-flag {
      height: 20px;
      border-radius: 2px;
    }

    .athlete-country {
      font-size: var(--text-base);
      font-weight: 400;
      color: var(--text-secondary);
      margin-bottom: var(--space-6);
    }

    .athlete-stats {
      display: flex;
      gap: var(--space-8);
      margin-bottom: var(--space-6);
    }

    .athlete-stat {
      display: flex;
      flex-direction: column;
    }

    .athlete-stat-label {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--text-tertiary);
      margin-bottom: 2px;
    }

    .athlete-stat-value {
      font-size: var(--text-lg);
      font-weight: 500;
      color: var(--text-primary);
    }

    .athlete-actions {
      display: flex;
      gap: var(--space-2);
    }

    .athlete-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      height: 36px;
      padding: 0 var(--space-4);
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--bg-primary);
      background: var(--accent);
      border: none;
      border-radius: var(--radius-md);
      text-decoration: none;
      transition: opacity var(--transition-fast);
      white-space: normal;
      min-width: 0;
    }

    .athlete-link:hover {
      opacity: 0.85;
    }

    .athlete-link-secondary {
      color: var(--text-secondary);
      background: var(--bg-secondary);
    }

    .athlete-link-secondary:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
      opacity: 1;
    }

    .athlete-link-icon {
      color: var(--text-secondary);
      background: var(--bg-secondary);
      padding: var(--space-2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .athlete-link-icon:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
      opacity: 1;
    }

    .athlete-link-icon svg {
      display: block;
    }

    /* Athlete Body - Results & Gallery */
    .athlete-body {
      padding: var(--space-8) 0;
      border-top: 1px solid var(--border-primary);
      margin-top: var(--space-4);
    }

    .athlete-section {
      margin-bottom: var(--space-10);
    }

    .athlete-section:last-child {
      margin-bottom: 0;
    }

    .athlete-section-title {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-tertiary);
      margin-bottom: var(--space-4);
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: var(--space-2);
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-3) var(--space-4);
      background: transparent;
      border-radius: var(--radius-md);
      text-decoration: none;
      color: var(--text-primary);
      transition: background var(--transition-fast);
    }

    .result-item:hover {
      background: var(--accent-subtle);
    }

    .result-item.clickable {
      cursor: pointer;
    }

    .result-event {
      font-size: var(--text-sm);
      font-weight: 500;
    }

    .result-year {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    .result-position {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--text-secondary);
      min-width: 40px;
      text-align: right;
    }

    .result-position.gold {
      color: var(--gold);
    }

    .result-position.silver {
      color: var(--silver);
    }

    .result-position.bronze {
      color: var(--bronze);
    }

    .result-position.top3 {
      color: var(--text-primary);
    }

    /* Image Gallery */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: var(--space-2);
    }

    .gallery-grid a,
    .gallery-grid .gallery-item {
      aspect-ratio: 1;
      overflow: hidden;
      border-radius: var(--radius-md);
      cursor: pointer;
    }

    .gallery-grid img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform var(--transition-slow);
    }

    .gallery-grid a:hover img,
    .gallery-grid .gallery-item:hover img {
      transform: scale(1.05);
    }

    /* Lightbox */
    .lightbox-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }

    .lightbox-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lightbox-image {
      max-width: 100%;
      max-height: 85vh;
      object-fit: contain;
      border-radius: var(--radius-md);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .lightbox-close {
      position: absolute;
      top: var(--space-4);
      right: var(--space-4);
      width: 44px;
      height: 44px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: var(--text-xl);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s ease;
      z-index: 2001;
    }

    .lightbox-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: var(--text-xl);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s ease;
      z-index: 2001;
    }

    .lightbox-nav:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .lightbox-nav:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .lightbox-prev {
      left: var(--space-4);
    }

    .lightbox-next {
      right: var(--space-4);
    }

    .lightbox-counter {
      position: absolute;
      bottom: var(--space-4);
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255, 255, 255, 0.7);
      font-size: var(--text-sm);
      font-weight: 500;
    }

    /* Video Grid */
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--space-4);
    }

    .video-item {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border-primary);
      transition: all var(--transition-fast);
    }

    .video-item:hover {
      border-color: var(--border-secondary);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    @media (max-width: 640px) {
      .video-grid {
        grid-template-columns: 1fr;
        gap: var(--space-3);
      }

      .lightbox-nav {
        width: 40px;
        height: 40px;
        font-size: var(--text-lg);
      }

      .lightbox-prev {
        left: var(--space-2);
      }

      .lightbox-next {
        right: var(--space-2);
      }
    }

    /* Responsive */
    @media (max-width: 640px) {
      .athlete-hero {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .athlete-photo {
        display: flex;
        justify-content: center;
      }

      .athlete-avatar, .athlete-placeholder {
        width: 160px;
        height: 200px;
      }

      .athlete-header {
        justify-content: center;
      }

      .athlete-name {
        font-size: var(--text-xl);
      }

      .athlete-actions {
        justify-content: center;
      }
    }

    /* Loading */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-16) 0;
      color: var(--text-tertiary);
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-secondary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-bottom: var(--space-4);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error */
    .error-message {
      padding: var(--space-4) var(--space-5);
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: var(--radius-md);
      color: #dc2626;
      font-size: var(--text-sm);
    }

    [data-theme="dark"] .error-message {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-12) 0;
      color: var(--text-tertiary);
    }

    /* Focus styles for accessibility */
    .quick-btn:focus, .search-btn:focus, .athlete-link:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .app {
        padding: var(--space-4);
        padding-top: calc(56px + var(--space-6));
      }

      .nav-inner {
        padding: var(--space-3) var(--space-4);
      }

      .search-toolbar {
        flex-wrap: wrap;
        gap: var(--space-3);
      }

      .search-wrapper {
        flex: 1 1 100%;
        max-width: none;
        order: 1;
      }

      .quick-actions {
        order: 2;
      }

      .toolbar-hint {
        order: 3;
        margin-left: auto;
      }

      .athlete-hero {
        grid-template-columns: 1fr;
        text-align: center;
        gap: var(--space-5);
      }

      .athlete-photo {
        display: flex;
        justify-content: center;
      }

      .athlete-avatar, .athlete-placeholder {
        width: 140px;
        height: 170px;
      }

      .athlete-name {
        font-size: var(--text-2xl);
      }

      .athlete-stats {
        justify-content: center;
      }

      .athlete-actions {
        justify-content: center;
        flex-wrap: wrap;
        gap: var(--space-2);
      }

      .athlete-link {
        white-space: normal;
        min-width: 0;
        height: auto;
        min-height: 36px;
        padding: var(--space-2) var(--space-3);
        line-height: 1.4;
        text-align: center;
      }
    }

    /* Performance: use will-change sparingly */
    .photo-card img,
    .gallery-grid img {
      will-change: transform;
    }

    /* Performance: contain for layout thrashing */
    .ranking-item,
    .result-item {
      contain: layout style;
    }

    /* ============================================
       NEW FEATURES - Favorites, Charts, Comparison
       ============================================ */

    /* Favorite Button */
    .favorite-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: var(--bg-secondary);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .favorite-btn:hover {
      background: var(--bg-tertiary);
    }

    .favorite-btn svg {
      width: 16px;
      height: 16px;
      stroke: var(--text-tertiary);
      fill: none;
      transition: all var(--transition-fast);
    }

    .favorite-btn:hover svg {
      stroke: var(--text-secondary);
    }

    .favorite-btn.is-favorite svg {
      stroke: var(--warning);
      fill: var(--warning);
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: var(--space-8);
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: var(--bg-primary);
      padding: var(--space-3) var(--space-5);
      font-size: var(--text-sm);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-elevated);
      z-index: 1000;
      animation: toastIn 0.2s ease, toastOut 0.2s ease 2.7s forwards;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateX(-50%) translateY(10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    @keyframes toastOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Event Card */
    .event-card {
      background: var(--bg-primary);
      margin-bottom: var(--space-8);
    }

    .event-header {
      padding: var(--space-8) 0;
      border-bottom: 1px solid var(--border-primary);
    }

    .event-title {
      font-size: var(--text-2xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-2);
    }

    .event-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      color: var(--text-secondary);
      font-size: var(--text-sm);
    }

    .event-meta-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .event-programs {
      padding: var(--space-6) 0;
    }

    .event-programs-title {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      margin-bottom: var(--space-4);
    }

    .event-program-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .event-program-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .event-program-item:hover {
      background: var(--bg-tertiary);
    }

    .event-program-info {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .event-program-name {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-primary);
    }

    .event-program-badge {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      background: rgba(16, 163, 127, 0.1);
      color: #10a37f;
    }

    .event-program-date {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
    }

    .event-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      text-decoration: none;
      padding: var(--space-2) var(--space-4);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      margin-top: var(--space-4);
    }

    .event-link:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    /* Chart Container */
    .chart-type-selector {
      display: flex;
      gap: var(--space-1);
      align-items: center;
    }

    .chart-type-btn {
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: inherit;
    }

    .chart-type-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--border-secondary);
    }

    .chart-type-btn.active {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }

    .chart-container {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-top: var(--space-4);
      position: relative;
      overflow: visible;
    }

    .chart-container canvas {
      font-family: "Google Sans", sans-serif !important;
      cursor: pointer;
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      justify-content: center;
    }

    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-xs);
      color: var(--text-tertiary);
    }

    .chart-legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* Chart tooltip for race details */
    .chart-race-tooltip {
      position: absolute;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      padding: var(--space-4);
      min-width: 220px;
      z-index: 100;
      pointer-events: auto;
      animation: fadeIn 0.15s ease;
    }

    .chart-race-tooltip-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-2);
      line-height: 1.3;
    }

    .chart-race-tooltip-meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-3);
    }

    .chart-race-tooltip-position {
      font-size: var(--text-xl);
      font-weight: 700;
    }

    .chart-race-tooltip-position.gold { color: #f59e0b; }
    .chart-race-tooltip-position.silver { color: #6b7280; }
    .chart-race-tooltip-position.bronze { color: #ea580c; }

    .chart-race-tooltip-date {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
    }

    .chart-race-tooltip-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--text-secondary);
      text-decoration: none;
      padding: var(--space-2) var(--space-3);
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      transition: all 0.15s ease;
    }

    .chart-race-tooltip-link:hover {
      color: var(--text-primary);
      background: var(--border-primary);
    }

    /* Race Details Modal */
    .race-details-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
      animation: fadeIn 0.15s ease;
    }

    .race-details-modal {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-elevated);
      width: 100%;
      max-width: 480px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: modalSlideIn 0.2s ease;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.96) translateY(8px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .race-details-header {
      padding: var(--space-5) var(--space-6);
      border-bottom: 1px solid var(--border-primary);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--space-4);
    }

    .race-details-title {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .race-details-meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-top: var(--space-2);
    }

    .race-details-date {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .race-details-close {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-md);
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: var(--text-lg);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all var(--transition-fast);
    }

    .race-details-close:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .race-details-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-4) var(--space-6);
    }

    .race-details-subtitle {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      margin-bottom: var(--space-3);
    }

    .race-details-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .race-details-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      transition: background var(--transition-fast);
    }

    .race-details-item:hover {
      background: var(--bg-secondary);
    }

    .race-details-item.current-athlete {
      background: var(--accent-subtle);
      border: 1px solid var(--border-primary);
    }

    .race-details-position {
      width: 32px;
      font-size: var(--text-base);
      font-weight: 700;
      text-align: center;
      flex-shrink: 0;
    }

    .race-details-position.gold { color: #f59e0b; }
    .race-details-position.silver { color: #6b7280; }
    .race-details-position.bronze { color: #ea580c; }

    .race-details-athlete {
      flex: 1;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      min-width: 0;
    }

    .race-details-athlete-name {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    .race-details-athlete-name:hover {
      text-decoration: underline;
    }

    .race-details-flag {
      width: 18px;
      height: 14px;
      object-fit: cover;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .race-details-time {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
      flex-shrink: 0;
    }

    .race-details-footer {
      padding: var(--space-4) var(--space-6);
      border-top: 1px solid var(--border-primary);
      display: flex;
      justify-content: flex-end;
    }

    .race-details-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-secondary);
      text-decoration: none;
      padding: var(--space-2) var(--space-4);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    .race-details-link:hover {
      color: var(--text-primary);
      background: var(--border-secondary);
    }

    .race-details-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-8);
      color: var(--text-secondary);
    }

    .race-details-error {
      text-align: center;
      padding: var(--space-6);
      color: var(--text-secondary);
      font-size: var(--text-sm);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Keyboard Shortcuts Modal */
    .shortcuts-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
      animation: fadeIn 0.15s ease;
    }

    .shortcuts-content {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-elevated);
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      animation: modalSlideIn 0.2s ease;
    }

    .shortcuts-header {
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--border-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .shortcuts-header h3 {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .shortcuts-close {
      width: 28px;
      height: 28px;
      border-radius: var(--radius-md);
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: var(--text-lg);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }

    .shortcuts-close:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .shortcuts-grid {
      padding: var(--space-4) var(--space-5);
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .shortcut-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
    }

    .shortcut-item kbd {
      font-family: 'SF Mono', ui-monospace, monospace;
      font-size: var(--text-xs);
      padding: 4px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      min-width: 28px;
      text-align: center;
    }

    .shortcut-item span {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    /* Trend Summary */
    .trend-summary {
      display: flex;
      align-items: center;
      gap: var(--space-6);
      padding: var(--space-4);
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
    }

    .trend-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: var(--space-3);
      min-width: 80px;
    }

    .trend-indicator.improving { color: #22c55e; }
    .trend-indicator.declining { color: #ef4444; }
    .trend-indicator.stable { color: var(--text-secondary); }

    .trend-icon {
      font-size: var(--text-xl);
      font-weight: bold;
      line-height: 1;
    }

    .trend-label {
      font-size: var(--text-xs);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: var(--space-1);
    }

    .trend-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-4);
      flex: 1;
    }

    .trend-stat {
      display: flex;
      flex-direction: column;
    }

    .trend-stat-label {
      font-size: var(--text-xs);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
    }

    .trend-stat-value {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Comparison Modal */
    .comparison-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.15s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .comparison-modal {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      width: 100%;
      max-width: 480px;
      margin: var(--space-4);
      animation: slideUp 0.2s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .comparison-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4);
      border-bottom: 1px solid var(--border-primary);
    }

    .comparison-modal-title {
      font-size: var(--text-sm);
      font-weight: 600;
    }

    .comparison-modal-close {
      background: transparent;
      border: none;
      font-size: var(--text-xl);
      color: var(--text-secondary);
      cursor: pointer;
      line-height: 1;
      padding: 0;
    }

    .comparison-modal-close:hover {
      color: var(--text-primary);
    }

    .comparison-modal-body {
      padding: var(--space-4);
    }

    .comparison-modal-athlete {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--bg-secondary);
      margin-bottom: var(--space-4);
    }

    .comparison-modal-athlete-photo {
      width: 48px;
      height: 48px;
      object-fit: cover;
      background: var(--bg-tertiary);
    }

    .comparison-modal-athlete-placeholder {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      color: var(--text-tertiary);
      font-size: var(--text-sm);
      font-weight: 600;
    }

    .comparison-modal-athlete-info {
      flex: 1;
    }

    .comparison-modal-athlete-name {
      font-size: var(--text-sm);
      font-weight: 500;
    }

    .comparison-modal-athlete-country {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .comparison-modal-search {
      position: relative;
    }

    .comparison-modal-search input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      font-family: inherit;
      font-size: var(--text-sm);
      color: var(--text-primary);
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      outline: none;
    }

    .comparison-modal-search input:focus {
      border-color: var(--text-primary);
    }

    .comparison-modal-results {
      max-height: 240px;
      overflow-y: auto;
      border: 1px solid var(--border-primary);
      border-top: none;
    }

    .comparison-modal-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      border-bottom: 1px solid var(--border-primary);
      transition: background 0.1s;
    }

    .comparison-modal-item:last-child {
      border-bottom: none;
    }

    .comparison-modal-item:hover {
      background: var(--bg-tertiary);
    }

    .comparison-modal-item-photo {
      width: 36px;
      height: 36px;
      object-fit: cover;
      background: var(--bg-tertiary);
    }

    .comparison-modal-item-placeholder {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      color: var(--text-tertiary);
      font-size: var(--text-xs);
      font-weight: 600;
    }

    .comparison-modal-item-info {
      flex: 1;
    }

    .comparison-modal-item-name {
      font-size: var(--text-sm);
      font-weight: 500;
    }

    .comparison-modal-item-country {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .comparison-modal-loading {
      padding: var(--space-4);
      text-align: center;
      color: var(--text-tertiary);
      font-size: var(--text-sm);
    }

    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: var(--space-4);
      align-items: start;
      margin-bottom: var(--space-6);
    }

    .comparison-vs {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--text-tertiary);
      padding: var(--space-8) var(--space-4);
    }

    .comparison-card {
      position: relative;
      overflow: hidden;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      text-align: center;
    }

    .comparison-card-photo {
      width: 120px;
      height: 150px;
      object-fit: cover;
      margin: 0 auto var(--space-3);
      background: var(--bg-tertiary);
    }

    .comparison-card-name {
      display: block;
      font-size: var(--text-lg);
      font-weight: 600;
      margin-bottom: var(--space-1);
      text-decoration: none;
      color: var(--text-primary);
      transition: color var(--transition-fast);
    }

    .comparison-card-name:hover {
      color: var(--accent-green);
    }

    .comparison-card-country {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      margin-bottom: var(--space-3);
    }

    .comparison-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-2);
      text-align: left;
    }

    .comparison-stat-label {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      text-transform: uppercase;
    }

    .comparison-stat-value {
      font-size: var(--text-sm);
      font-weight: 500;
    }

    .comparison-card-color {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .comparison-flag {
      width: 16px;
      height: 12px;
      object-fit: cover;
      border-radius: 2px;
      margin-right: 4px;
      vertical-align: middle;
    }

    .comparison-rank {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--accent-green);
      margin-bottom: var(--space-3);
    }

    .comparison-profile-link {
      display: inline-block;
      margin-top: var(--space-3);
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      text-decoration: none;
      transition: color var(--transition-fast);
    }

    .comparison-profile-link:hover {
      color: var(--text-primary);
    }

    .comparison-results-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-4);
    }

    .comparison-results-column {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .comparison-results-header {
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 3px solid;
      background: var(--bg-tertiary);
    }

    .comparison-result-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--border-primary);
    }

    .comparison-result-row:last-child {
      border-bottom: none;
    }

    .comparison-result-row.clickable {
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .comparison-result-row.clickable:hover {
      background: var(--accent-subtle);
    }

    .comparison-result-info {
      min-width: 0;
      flex: 1;
    }

    .comparison-result-event {
      font-size: var(--text-sm);
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .comparison-result-date {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
    }

    .comparison-result-position {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-secondary);
      flex-shrink: 0;
      margin-left: var(--space-3);
    }

    .comparison-result-position.gold { color: #ca8a04; }
    .comparison-result-position.silver { color: #71717a; }
    .comparison-result-position.bronze { color: #c2410c; }

    .comparison-no-results {
      padding: var(--space-4);
      text-align: center;
      color: var(--text-tertiary);
      font-size: var(--text-sm);
    }

    /* Mobile: comparison features */
    @media (max-width: 768px) {
      .comparison-grid {
        grid-template-columns: 1fr;
      }

      .comparison-vs {
        padding: var(--space-4);
      }

      .comparison-results-grid {
        grid-template-columns: 1fr;
      }

      .trend-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .trend-summary {
        flex-direction: column;
        text-align: center;
      }
    }

  </style>
</head>
<body tabindex="-1">
  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-inner">
      <a href="#" class="nav-brand" onclick="fetchTopRankings(); return false;">Tri Stats</a>
      <div class="nav-actions">
        <div class="nav-search" id="nav-search">
          <button class="nav-search-btn" onclick="openNavSearch()" aria-label="Search">
            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          </button>
          <div class="nav-search-expanded">
            <div class="nav-search-input-wrapper">
              <button class="nav-ai-toggle" id="nav-ai-toggle" onclick="toggleAISearch()" aria-label="Toggle AI search" title="AI Search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L13.09 8.26L19 9L13.09 9.74L12 16L10.91 9.74L5 9L10.91 8.26L12 2Z"/>
                  <path d="M5 18L5.54 20.46L8 21L5.54 21.54L5 24L4.46 21.54L2 21L4.46 20.46L5 18Z"/>
                  <path d="M19 16L19.36 17.64L21 18L19.36 18.36L19 20L18.64 18.36L17 18L18.64 17.64L19 16Z"/>
                </svg>
              </button>
              <input
                type="text"
                id="navSearchInput"
                class="nav-search-input"
                placeholder="Search athletes or events..."
                autocomplete="off"
              />
              <button class="nav-search-close" onclick="closeNavSearch()" aria-label="Close search">
                <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>
            <div id="nav-autocomplete-results" class="nav-search-autocomplete" style="display: none;"></div>
            <div id="recent-ai-searches" class="recent-ai-searches" style="display: none;"></div>
          </div>
        </div>
        <button class="quick-btn" onclick="showFavorites()" aria-label="View favorites">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        </button>
        <button class="quick-btn shortcuts-btn" onclick="toggleShortcutsHelp()" aria-label="Keyboard shortcuts">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="10" x2="6" y2="10"/><line x1="10" y1="10" x2="10" y2="10"/><line x1="14" y1="10" x2="14" y2="10"/><line x1="18" y1="10" x2="18" y2="10"/><line x1="8" y1="14" x2="16" y2="14"/></svg>
        </button>
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
          <svg class="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
          <svg class="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        </button>
      </div>
    </div>
  </nav>

  <div class="app">
    <div class="search-toolbar">
      <div class="search-wrapper">
        <div class="search-box">
          <input
            type="text"
            id="athleteName"
            class="search-input"
            placeholder="Search athletes or events..."
            autocomplete="off"
          />
          <button class="search-btn" onclick="searchAthlete()">Search</button>
          <div id="autocomplete-results" class="autocomplete-results" role="listbox" aria-label="Athlete suggestions"></div>
        </div>
      </div>
      <div class="quick-actions">
        <button class="quick-btn" onclick="fetchTopRankings()">Rankings</button>
        <button class="quick-btn" onclick="showRandomAthlete()">Random</button>
        <button class="quick-btn" onclick="showHomePage()">Featured Content</button>
      </div>
      <div class="toolbar-hint">
        <kbd id="keyboard-hint"></kbd>
      </div>
    </div>

    <main id="results"></main>
  </div>

  <script>
    // API calls go through our serverless proxy (see /api/triathlon.js)
    // This keeps the API key secure on the server side
    const API_BASE = '/api/triathlon';

    // ============================================
    // Race Split Data Utilities
    // ============================================

    // Cache for split data per race
    const splitDataCache = {};

    /**
     * Parse time string (HH:MM:SS or MM:SS) to seconds
     */
    function parseTimeToSeconds(timeStr) {
        if (!timeStr || typeof timeStr !== 'string') return null;
        const parts = timeStr.trim().split(':').map(Number);
        if (parts.length === 3) {
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
        } else if (parts.length === 2) {
            return parts[0] * 60 + parts[1];
        }
        return null;
    }

    /**
     * Format seconds to MM:SS or HH:MM:SS
     */
    function formatSecondsToTime(seconds) {
        if (seconds === null || seconds === undefined) return '';
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        if (hrs > 0) {
            return `${hrs}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        return `${mins}:${String(secs).padStart(2, '0')}`;
    }

    /**
     * Extract split data from API result object
     * Handles various field name variations
     */
    function extractSplitData(result) {
        const splits = {
            swim_time: null,
            bike_time: null,
            run_time: null,
            t1_time: null,
            t2_time: null,
            swim_seconds: null,
            bike_seconds: null,
            run_seconds: null,
            t1_seconds: null,
            t2_seconds: null,
            swim_position: null,
            bike_position: null,
            run_position: null,
            total_time: result.total_time || null,
            total_seconds: null
        };

        // Try various field name patterns
        const fieldMappings = {
            swim: ['swim_time', 'swim', 'swimTime', 'swim_time_formatted'],
            bike: ['bike_time', 'bike', 'bikeTime', 'bike_time_formatted'],
            run: ['run_time', 'run', 'runTime', 'run_time_formatted'],
            t1: ['t1_time', 't1', 'transition1', 'transition_1'],
            t2: ['t2_time', 't2', 'transition2', 'transition_2']
        };

        // Extract times
        Object.keys(fieldMappings).forEach(discipline => {
            const fields = fieldMappings[discipline];
            for (const field of fields) {
                if (result[field]) {
                    const timeKey = `${discipline}_time`;
                    splits[timeKey] = result[field];
                    const seconds = parseTimeToSeconds(result[field]);
                    if (seconds !== null) {
                        splits[`${discipline}_seconds`] = seconds;
                    }
                    break;
                }
            }
        });

        // Extract positions
        if (result.swim_position) splits.swim_position = parseInt(result.swim_position);
        if (result.bike_position) splits.bike_position = parseInt(result.bike_position);
        if (result.run_position) splits.run_position = parseInt(result.run_position);

        // Calculate total seconds if we have total_time
        if (result.total_time) {
            splits.total_seconds = parseTimeToSeconds(result.total_time);
        }

        return splits;
    }

    /**
     * Enhance result object with split data and calculated metrics
     */
    function enhanceResultWithSplits(result, allResults = []) {
        const splits = extractSplitData(result);
        const enhanced = { ...result, ...splits };

        // Calculate relative performance (% of winner's time)
        if (allResults.length > 0) {
            const winner = allResults[0];
            const winnerSplits = extractSplitData(winner);

            if (winnerSplits.swim_seconds && splits.swim_seconds) {
                enhanced.relative_swim = (splits.swim_seconds / winnerSplits.swim_seconds) * 100;
            }
            if (winnerSplits.bike_seconds && splits.bike_seconds) {
                enhanced.relative_bike = (splits.bike_seconds / winnerSplits.bike_seconds) * 100;
            }
            if (winnerSplits.run_seconds && splits.run_seconds) {
                enhanced.relative_run = (splits.run_seconds / winnerSplits.run_seconds) * 100;
            }
            if (winnerSplits.total_seconds && splits.total_seconds) {
                enhanced.relative_total = (splits.total_seconds / winnerSplits.total_seconds) * 100;
            }
        }

        // Calculate discipline ranks (position within race for each discipline)
        if (allResults.length > 0) {
            const disciplineRanks = { swim: null, bike: null, run: null };
            
            // Sort by swim time
            const swimSorted = [...allResults]
                .map(r => ({ ...r, splits: extractSplitData(r) }))
                .filter(r => r.splits.swim_seconds !== null)
                .sort((a, b) => a.splits.swim_seconds - b.splits.swim_seconds);
            const swimRank = swimSorted.findIndex(r => r.athlete_id === result.athlete_id);
            if (swimRank >= 0) disciplineRanks.swim = swimRank + 1;

            // Sort by bike time
            const bikeSorted = [...allResults]
                .map(r => ({ ...r, splits: extractSplitData(r) }))
                .filter(r => r.splits.bike_seconds !== null)
                .sort((a, b) => a.splits.bike_seconds - b.splits.bike_seconds);
            const bikeRank = bikeSorted.findIndex(r => r.athlete_id === result.athlete_id);
            if (bikeRank >= 0) disciplineRanks.bike = bikeRank + 1;

            // Sort by run time
            const runSorted = [...allResults]
                .map(r => ({ ...r, splits: extractSplitData(r) }))
                .filter(r => r.splits.run_seconds !== null)
                .sort((a, b) => a.splits.run_seconds - b.splits.run_seconds);
            const runRank = runSorted.findIndex(r => r.athlete_id === result.athlete_id);
            if (runRank >= 0) disciplineRanks.run = runRank + 1;

            enhanced.discipline_ranks = disciplineRanks;
        }

        return enhanced;
    }

    /**
     * Log API response structure for debugging
     */
    function logApiStructure(data, context = '') {
        if (data && data.data && data.data.results && data.data.results.length > 0) {
            const firstResult = data.data.results[0];
            console.log(`API Structure ${context}:`, {
                availableFields: Object.keys(firstResult),
                sampleResult: firstResult,
                hasSwim: !!firstResult.swim_time || !!firstResult.swim,
                hasBike: !!firstResult.bike_time || !!firstResult.bike,
                hasRun: !!firstResult.run_time || !!firstResult.run
            });
        }
    }

    /**
     * Calculate discipline strength analysis from athlete results
     */
    function calculateDisciplineStrength(results) {
        if (!results || results.length === 0) return null;

        const disciplines = ['swim', 'bike', 'run'];
        const stats = {
            swim: { ranks: [], relative: [], count: 0 },
            bike: { ranks: [], relative: [], count: 0 },
            run: { ranks: [], relative: [], count: 0 }
        };

        // Collect discipline data
        results.forEach(result => {
            disciplines.forEach(discipline => {
                if (result.discipline_ranks && result.discipline_ranks[discipline] !== null) {
                    stats[discipline].ranks.push(result.discipline_ranks[discipline]);
                    stats[discipline].count++;
                }
                if (result[`relative_${discipline}`] !== null && result[`relative_${discipline}`] !== undefined) {
                    stats[discipline].relative.push(result[`relative_${discipline}`]);
                }
            });
        });

        // Calculate averages
        const analysis = {};
        disciplines.forEach(discipline => {
            const data = stats[discipline];
            if (data.count > 0) {
                const avgRank = data.ranks.reduce((a, b) => a + b, 0) / data.ranks.length;
                const avgRelative = data.relative.length > 0 
                    ? data.relative.reduce((a, b) => a + b, 0) / data.relative.length 
                    : null;
                
                analysis[discipline] = {
                    avgRank: avgRank,
                    avgRelative: avgRelative,
                    count: data.count,
                    bestRank: Math.min(...data.ranks),
                    worstRank: Math.max(...data.ranks)
                };
            }
        });

        // Determine strongest and weakest disciplines
        const disciplinesWithData = Object.keys(analysis);
        if (disciplinesWithData.length === 0) return null;

        // Sort by average rank (lower is better)
        const sorted = disciplinesWithData.sort((a, b) => analysis[a].avgRank - analysis[b].avgRank);
        
        return {
            strongest: sorted[0],
            weakest: sorted[sorted.length - 1],
            disciplines: analysis,
            hasData: disciplinesWithData.length > 0
        };
    }

    /**
     * Get discipline strength badge HTML
     */
    function getDisciplineStrengthBadge(strength) {
        if (!strength || !strength.hasData) return '';

        const disciplineNames = { swim: 'Swim', bike: 'Bike', run: 'Run' };
        const disciplineIcons = { swim: '', bike: '', run: '' };
        const disciplineColors = { swim: '#3b82f6', bike: '#10b981', run: '#ef4444' };

        const strongest = strength.strongest;
        const avgRank = strength.disciplines[strongest].avgRank.toFixed(1);

        return `
            <div class="discipline-strength-badge" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-secondary); border-radius: var(--radius-md); font-size: var(--text-xs); margin-top: var(--space-2);">
                <span style="font-size: var(--text-sm);">${disciplineIcons[strongest]}</span>
                <span style="color: var(--text-secondary);">Strongest:</span>
                <span style="color: ${disciplineColors[strongest]}; font-weight: 600;">${disciplineNames[strongest]}</span>
                <span style="color: var(--text-tertiary);">(Avg Rank: ${avgRank})</span>
            </div>
        `;
    }

    /**
     * Enhance results with split data from cache or API
     * This is async and non-blocking - will enhance when data becomes available
     */
    async function enhanceResultsWithSplitData(athleteId, results) {
        if (!results || results.length === 0) return results;

        const enhanced = await Promise.all(results.map(async (result) => {
            // Check if we already have split data
            if (result.swim_seconds !== null && result.swim_seconds !== undefined) {
                return result; // Already enhanced
            }

            // Check cache first
            if (result.event_id && result.prog_id) {
                const cacheKey = `${result.event_id}_${result.prog_id}`;
                if (splitDataCache[cacheKey]) {
                    const cached = splitDataCache[cacheKey];
                    const athleteResult = cached.allResults.find(r => 
                        r.athlete_id == athleteId || 
                        (r.athlete_title && result.athlete_title && r.athlete_title === result.athlete_title)
                    );
                    if (athleteResult) {
                        return { ...result, ...extractSplitData(athleteResult) };
                    }
                }
            }

            return result; // Return original if no enhancement available
        }));

        return enhanced;
    }

    /**
     * Calculate statistical insights from results
     */
    function calculateStatisticalInsights(results) {
        if (!results || results.length === 0) return null;

        const disciplines = ['swim', 'bike', 'run'];
        const insights = {
            disciplines: {},
            trends: {},
            consistency: {},
            correlations: {}
        };

        disciplines.forEach(discipline => {
            const times = results
                .map(r => r[`${discipline}_seconds`])
                .filter(t => t !== null && t !== undefined);
            
            if (times.length === 0) return;

            const sorted = [...times].sort((a, b) => a - b);
            const avg = sorted.reduce((a, b) => a + b, 0) / sorted.length;
            const best = sorted[0];
            const worst = sorted[sorted.length - 1];
            
            // Calculate standard deviation and coefficient of variation
            const variance = sorted.reduce((sum, t) => sum + Math.pow(t - avg, 2), 0) / sorted.length;
            const stdDev = Math.sqrt(variance);
            const cv = (stdDev / avg) * 100; // Coefficient of variation (%)

            // Calculate trend (slope) - simple linear regression
            const dates = results
                .map((r, idx) => ({ date: new Date(r.event_date).getTime(), time: r[`${discipline}_seconds`] }))
                .filter(d => d.time !== null && d.time !== undefined)
                .sort((a, b) => a.date - b.date);
            
            let trend = null;
            if (dates.length >= 2) {
                const n = dates.length;
                const sumX = dates.reduce((s, d) => s + d.date, 0);
                const sumY = dates.reduce((s, d) => s + d.time, 0);
                const sumXY = dates.reduce((s, d) => s + d.date * d.time, 0);
                const sumX2 = dates.reduce((s, d) => s + d.date * d.date, 0);
                
                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                // Convert slope to seconds per year (approximate)
                const slopePerYear = slope * (365.25 * 24 * 60 * 60 * 1000);
                trend = {
                    slope: slopePerYear,
                    direction: slopePerYear < -10 ? 'improving' : slopePerYear > 10 ? 'declining' : 'stable',
                    magnitude: Math.abs(slopePerYear)
                };
            }

            insights.disciplines[discipline] = {
                avg: avg,
                best: best,
                worst: worst,
                count: times.length,
                avgFormatted: formatSecondsToTime(avg),
                bestFormatted: formatSecondsToTime(best),
                worstFormatted: formatSecondsToTime(worst)
            };

            insights.consistency[discipline] = {
                stdDev: stdDev,
                cv: cv,
                stdDevFormatted: formatSecondsToTime(stdDev)
            };

            if (trend) {
                insights.trends[discipline] = trend;
            }
        });

        // Calculate correlations between disciplines
        const swimTimes = results.map(r => r.swim_seconds).filter(t => t !== null);
        const bikeTimes = results.map(r => r.bike_seconds).filter(t => t !== null);
        const runTimes = results.map(r => r.run_seconds).filter(t => t !== null);
        const positions = results.map(r => parseInt(r.position)).filter(p => !isNaN(p));

        const calculateCorrelation = (x, y) => {
            if (x.length !== y.length || x.length < 2) return null;
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
            
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            return denominator === 0 ? null : numerator / denominator;
        };

        if (swimTimes.length === bikeTimes.length && swimTimes.length > 1) {
            insights.correlations.swim_bike = calculateCorrelation(swimTimes, bikeTimes);
        }
        if (swimTimes.length === runTimes.length && swimTimes.length > 1) {
            insights.correlations.swim_run = calculateCorrelation(swimTimes, runTimes);
        }
        if (bikeTimes.length === runTimes.length && bikeTimes.length > 1) {
            insights.correlations.bike_run = calculateCorrelation(bikeTimes, runTimes);
        }

        return insights;
    }

    /**
     * Generate statistical insights panel HTML
     */
    function generateStatisticalInsightsPanel(insights) {
        if (!insights) return '';

        const disciplineNames = { swim: 'Swim', bike: 'Bike', run: 'Run' };
        const disciplineColors = { swim: '#3b82f6', bike: '#10b981', run: '#ef4444' };

        let html = '<div class="statistical-insights-panel" style="margin-top: var(--space-6); padding: var(--space-6); background: var(--bg-secondary); border-radius: var(--radius-lg); border: 1px solid var(--border-primary);">';
        html += '<div class="athlete-section-title" style="margin-bottom: var(--space-4);">Statistical Insights</div>';

        // Discipline averages and best/worst
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">';
        Object.keys(insights.disciplines).forEach(discipline => {
            const data = insights.disciplines[discipline];
            html += `
                <div style="padding: var(--space-4); background: var(--bg-primary); border-radius: var(--radius-md); border-left: 3px solid ${disciplineColors[discipline]};">
                    <div style="font-size: var(--text-sm); font-weight: 600; color: ${disciplineColors[discipline]}; margin-bottom: var(--space-3);">${disciplineNames[discipline]}</div>
                    <div style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: var(--space-2);">
                        <span>Avg:</span> <span style="color: var(--text-primary); font-weight: 500;">${data.avgFormatted}</span>
                    </div>
                    <div style="font-size: var(--text-xs); color: var(--text-secondary);">
                        <span>Best:</span> <span style="color: var(--text-primary); font-weight: 500;">${data.bestFormatted}</span>
                        <span style="margin-left: var(--space-3);">Worst:</span> <span style="color: var(--text-primary); font-weight: 500;">${data.worstFormatted}</span>
                    </div>
                </div>
            `;
        });
        html += '</div>';

        // Trends
        if (Object.keys(insights.trends).length > 0) {
            html += '<div style="margin-bottom: var(--space-4);"><div style="font-size: var(--text-sm); font-weight: 600; margin-bottom: var(--space-2);">Performance Trends</div>';
            Object.keys(insights.trends).forEach(discipline => {
                const trend = insights.trends[discipline];
                const directionIcon = trend.direction === 'improving' ? '' : trend.direction === 'declining' ? '' : '';
                const directionColor = trend.direction === 'improving' ? '#10b981' : trend.direction === 'declining' ? '#ef4444' : '#6b7280';
                html += `
                    <div style="padding: var(--space-2); font-size: var(--text-xs); color: var(--text-secondary);">
                        <span style="margin-right: var(--space-2);">${directionIcon}</span>
                        <span style="color: ${disciplineColors[discipline]}; font-weight: 500;">${disciplineNames[discipline]}:</span>
                        <span style="color: ${directionColor};">${trend.direction}</span>
                        ${trend.magnitude > 10 ? `<span style="color: var(--text-tertiary);">(${Math.abs(trend.slope).toFixed(0)}s/year)</span>` : ''}
                    </div>
                `;
            });
            html += '</div>';
        }

        // Consistency
        if (Object.keys(insights.consistency).length > 0) {
            html += '<div style="margin-bottom: var(--space-4);"><div style="font-size: var(--text-sm); font-weight: 600; margin-bottom: var(--space-2);">Consistency</div>';
            Object.keys(insights.consistency).forEach(discipline => {
                const consistency = insights.consistency[discipline];
                html += `
                    <div style="padding: var(--space-2); font-size: var(--text-xs); color: var(--text-secondary);">
                        <span style="color: ${disciplineColors[discipline]}; font-weight: 500;">${disciplineNames[discipline]}:</span>
                        <span>Std Dev: ${consistency.stdDevFormatted}</span>
                        <span style="margin-left: var(--space-3);">CV: ${consistency.cv.toFixed(1)}%</span>
                    </div>
                `;
            });
            html += '</div>';
        }

        html += '</div>';
        return html;
    }

    // Lazy load Chart.js only when needed
    let chartJsLoaded = false;
    let chartJsLoading = null;

    async function loadChartJs() {
      if (chartJsLoaded) return Promise.resolve();
      if (chartJsLoading) return chartJsLoading;

      chartJsLoading = new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
        script.onload = () => {
          chartJsLoaded = true;
          resolve();
        };
        script.onerror = reject;
        document.head.appendChild(script);
      });

      return chartJsLoading;
    }

    // World Triathlon Championship Series rankings (IDs 15/16 for current WTCS)
    const RANKING_IDS = { male: 15, female: 16 };

    // Store current rankings data for navigation
    let currentRankingsData = null;

    // Store raw ranking IDs for progressive loading
    let rankingIds = { men: [], women: [] };
    let rankingsLoaded = 0;
    const RANKINGS_PER_PAGE = 10;

    // Cache for chart results toggle
    let extendedResultsCache = {};
    let recentResultsCache = {};
    const RANKINGS_MAX = 30;

    // Cache for athlete details to avoid redundant API calls
    const athleteCache = new Map();

    // General API cache with TTL and LRU eviction
    const apiCache = {
      data: new Map(),
      accessOrder: [], // Track access order for LRU
      TTL: 5 * 60 * 1000, // 5 minutes default
      MAX_SIZE: 100, // Maximum cache entries

      get(key) {
        const entry = this.data.get(key);
        if (!entry) return null;
        if (Date.now() > entry.expires) {
          this.data.delete(key);
          const index = this.accessOrder.indexOf(key);
          if (index > -1) this.accessOrder.splice(index, 1);
          return null;
        }
        // Update access order (move to end)
        const index = this.accessOrder.indexOf(key);
        if (index > -1) this.accessOrder.splice(index, 1);
        this.accessOrder.push(key);
        return entry.value;
      },

      set(key, value, ttl = this.TTL) {
        // Evict oldest if at max size
        if (this.data.size >= this.MAX_SIZE && !this.data.has(key)) {
          const oldestKey = this.accessOrder.shift();
          if (oldestKey) this.data.delete(oldestKey);
        }
        
        this.data.set(key, {
          value,
          expires: Date.now() + ttl
        });
        
        // Update access order
        const index = this.accessOrder.indexOf(key);
        if (index > -1) this.accessOrder.splice(index, 1);
        this.accessOrder.push(key);
      },

      clear() {
        this.data.clear();
        this.accessOrder = [];
      }
    };

    // Request deduplication - track in-flight requests
    const inFlightRequests = new Map();

    // Cached fetch wrapper with request deduplication
    async function cachedFetch(url, options = {}) {
      const cacheKey = url;
      
      // Check cache first
      const cached = apiCache.get(cacheKey);
      if (cached) {
        return { ok: true, json: async () => cached, fromCache: true };
      }

      // Check if request is already in flight
      if (inFlightRequests.has(cacheKey)) {
        return inFlightRequests.get(cacheKey);
      }

      // Create new request promise
      const requestPromise = (async () => {
        try {
          const response = await fetch(url, options);
          if (response.ok) {
            const data = await response.json();
            apiCache.set(cacheKey, data);
            return { ok: true, json: async () => data, fromCache: false };
          }
          return response;
        } finally {
          // Remove from in-flight map when done
          inFlightRequests.delete(cacheKey);
        }
      })();

      // Store in-flight request
      inFlightRequests.set(cacheKey, requestPromise);
      return requestPromise;
    }

    // Comparison state
    let comparisonState = {
      athlete1: null,
      athlete2: null,
      mode: 'idle' // 'idle' | 'selecting' | 'comparing'
    };

    // Favorites Manager (localStorage with try/catch for private browsing)
    const favoritesManager = (() => {
      const STORAGE_KEY = 'triathlon_favorites';

      const getFavorites = () => {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch { return []; }
      };

      const saveFavorites = (favorites) => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(favorites));
        } catch { /* ignore in private browsing */ }
      };

      return {
        getFavorites,
        addFavorite: (id) => {
          const favorites = getFavorites();
          if (!favorites.includes(id)) {
            favorites.push(id);
            saveFavorites(favorites);
          }
        },
        removeFavorite: (id) => {
          const favorites = getFavorites().filter(f => f !== id);
          saveFavorites(favorites);
        },
        isFavorite: (id) => getFavorites().includes(id),
        toggle: (id) => {
          const favorites = getFavorites();
          if (favorites.includes(id)) {
            favoritesManager.removeFavorite(id);
            return false;
          } else {
            favoritesManager.addFavorite(id);
            return true;
          }
        }
      };
    })();

    // Utility: Check if mobile device/screen
    function isMobile() {
      return window.innerWidth < 768;
    }

    // Toast notification
    function showToast(message) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // --- THEME TOGGLE LOGIC ---
    const themeToggle = document.getElementById('theme-toggle');
    const currentTheme = localStorage.getItem('theme');

    if (currentTheme) {
        document.documentElement.setAttribute('data-theme', currentTheme);
    }

    function switchTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const newTheme = isDark ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }

    themeToggle.addEventListener('click', switchTheme);

    // --- KEYBOARD SHORTCUTS ---
    // Detect OS for shortcut display
    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
    const modKey = isMac ? '' : 'Ctrl';
    const keyboardHint = document.getElementById('keyboard-hint');
    if (keyboardHint) {
      keyboardHint.textContent = isMac ? 'K' : 'Ctrl+K';
    }

    // Check if user is typing in an input field
    function isTyping() {
      const active = document.activeElement;
      return active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable);
    }

    // Helper to ensure input focus is cleared for keyboard shortcuts
    function clearInputFocus() {
      closeNavSearch();
      const active = document.activeElement;
      if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) {
        active.blur();
      }
      // Move focus to body so keyboard shortcuts continue to work
      document.body.focus();
    }

    // Global keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // K / Ctrl+K - Search
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openNavSearch();
        return;
      }

      // Skip single-key shortcuts if typing
      if (isTyping()) return;

      // / or ? - Handle slash key
      if (e.key === '/' || e.key === '?') {
        e.preventDefault();
        if (e.shiftKey || e.key === '?') {
          // ? (Shift+/) - Show keyboard shortcuts help
          toggleShortcutsHelp();
        } else {
          // / - Focus search
          openNavSearch();
        }
        return;
      }

      // D - Toggle dark/light mode
      if (e.key === 'd' || e.key === 'D') {
        e.preventDefault();
        switchTheme();
        return;
      }

      // F - Favorites
      if (e.key === 'f' || e.key === 'F') {
        e.preventDefault();
        clearInputFocus();
        showFavorites();
        return;
      }

      // H - Home/Rankings
      if (e.key === 'h' || e.key === 'H') {
        e.preventDefault();
        clearInputFocus();
        fetchTopRankings();
        return;
      }

      // C - Featured Content
      if (e.key === 'c' || e.key === 'C') {
        e.preventDefault();
        clearInputFocus();
        showHomePage();
        return;
      }

      // A - Toggle AI Search
      if (e.key === 'a' || e.key === 'A') {
        e.preventDefault();
        openNavSearch();
        setTimeout(() => toggleAISearch(), 200);
        return;
      }

      // Escape - Close any open modal/search
      if (e.key === 'Escape') {
        closeShortcutsHelp();
      }
    });

    // Shortcuts help modal
    function toggleShortcutsHelp() {
      const existing = document.getElementById('shortcuts-modal');
      if (existing) {
        existing.remove();
        return;
      }
      showShortcutsHelp();
    }

    function showShortcutsHelp() {
      const modal = document.createElement('div');
      modal.id = 'shortcuts-modal';
      modal.className = 'shortcuts-modal';
      modal.innerHTML = `
        <div class="shortcuts-content">
          <div class="shortcuts-header">
            <h3>Keyboard Shortcuts</h3>
            <button class="shortcuts-close" onclick="closeShortcutsHelp()"></button>
          </div>
          <div class="shortcuts-grid">
            <div class="shortcut-item">
              <kbd>${modKey}K</kbd> or <kbd>/</kbd>
              <span>Search</span>
            </div>
            <div class="shortcut-item">
              <kbd>H</kbd>
              <span>Home / Rankings</span>
            </div>
            <div class="shortcut-item">
              <kbd>F</kbd>
              <span>Favorites</span>
            </div>
            <div class="shortcut-item">
              <kbd>C</kbd>
              <span>Featured Content</span>
            </div>
            <div class="shortcut-item">
              <kbd>A</kbd>
              <span>AI Search</span>
            </div>
            <div class="shortcut-item">
              <kbd>D</kbd>
              <span>Toggle Dark Mode</span>
            </div>
            <div class="shortcut-item">
              <kbd>?</kbd>
              <span>Show Shortcuts</span>
            </div>
            <div class="shortcut-item">
              <kbd>Esc</kbd>
              <span>Close / Cancel</span>
            </div>
          </div>
        </div>
      `;
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeShortcutsHelp();
      });
      document.body.appendChild(modal);
    }

    function closeShortcutsHelp() {
      const modal = document.getElementById('shortcuts-modal');
      if (modal) modal.remove();
    }


    // --- UTILITY: Debounce function to limit API calls while typing ---
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // --- NAV SEARCH FUNCTIONS ---
    function openNavSearch() {
      const navSearch = document.getElementById('nav-search');
      navSearch.classList.add('is-open');
      setTimeout(() => {
        document.getElementById('navSearchInput').focus();
      }, 150);
    }

    function closeNavSearch() {
      const navSearch = document.getElementById('nav-search');
      navSearch.classList.remove('is-open');
      document.getElementById('navSearchInput').value = '';
      document.getElementById('nav-autocomplete-results').style.display = 'none';
      navSelectedIndex = -1;
      // Restore focus to body so keyboard shortcuts work
      document.body.focus();
    }

    // --- AI SEARCH MODE ---
    let aiSearchEnabled = false;
    const RECENT_AI_SEARCHES_KEY = 'recentAISearches';
    const MAX_RECENT_SEARCHES = 5;

    function getRecentAISearches() {
      try {
        return JSON.parse(localStorage.getItem(RECENT_AI_SEARCHES_KEY)) || [];
      } catch {
        return [];
      }
    }

    function saveAISearch(query) {
      const searches = getRecentAISearches();
      // Remove if already exists
      const filtered = searches.filter(s => s.toLowerCase() !== query.toLowerCase());
      // Add to front
      filtered.unshift(query);
      // Keep only last N
      const trimmed = filtered.slice(0, MAX_RECENT_SEARCHES);
      localStorage.setItem(RECENT_AI_SEARCHES_KEY, JSON.stringify(trimmed));
    }

    function showRecentAISearches() {
      const container = document.getElementById('recent-ai-searches');
      const searches = getRecentAISearches();

      if (searches.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.innerHTML = `
        <div class="recent-ai-searches-title">Recent Searches</div>
        <div class="recent-ai-searches-list">
          ${searches.map(s => `<button class="recent-ai-chip" onclick="runRecentAISearch('${s.replace(/'/g, "\\'")}')">${s}</button>`).join('')}
        </div>
      `;
      container.style.display = 'block';
    }

    function hideRecentAISearches() {
      document.getElementById('recent-ai-searches').style.display = 'none';
    }

    window.runRecentAISearch = function(query) {
      document.getElementById('navSearchInput').value = query;
      hideRecentAISearches();
      handleAISearch(query);
    };

    function toggleAISearch() {
      aiSearchEnabled = !aiSearchEnabled;
      const toggle = document.getElementById('nav-ai-toggle');
      const input = document.getElementById('navSearchInput');
      const autocomplete = document.getElementById('nav-autocomplete-results');

      if (aiSearchEnabled) {
        toggle.classList.add('is-active');
        input.classList.add('ai-mode');
        input.placeholder = 'Ask anything about triathlon...';
        autocomplete.style.display = 'none';
        showRecentAISearches();
        showToast('AI search enabled');
      } else {
        toggle.classList.remove('is-active');
        input.classList.remove('ai-mode');
        input.placeholder = 'Search athletes or events...';
        hideRecentAISearches();
        showToast('AI search disabled');
      }
      input.focus();
    }

    async function handleAISearch(query) {
      if (!query.trim()) return;

      closeNavSearch();
      currentRankingsData = null;
      const resultsDiv = document.getElementById('results');

      // Show loading state
      resultsDiv.innerHTML = `
        <section class="results-section">
          <div class="ai-response-card">
            <div class="ai-response-thinking">
              <div class="loading-spinner"></div>
              <span>Thinking...</span>
            </div>
          </div>
        </section>`;

      try {
        const response = await fetch('/api/claude', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        const data = await response.json();

        if (!response.ok || data.error) {
          // API returned an error - show debug info if available
          let errorMsg = data.details || data.error || 'Unknown error';
          if (data.debug) {
            console.log('Debug info:', data.debug);
            errorMsg += ` | Debug: relevantEnvVars=[${data.debug.relevantEnvVars?.join(', ') || 'none'}]`;
          }
          throw new Error(errorMsg);
        }

        // Save successful search to recent searches
        saveAISearch(query);

        // Build AI response card HTML
        const aiResponseHtml = `
          <div class="ai-response-card">
            <div class="ai-response-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L13.09 8.26L19 9L13.09 9.74L12 16L10.91 9.74L5 9L10.91 8.26L12 2Z"/>
                <path d="M5 18L5.54 20.46L8 21L5.54 21.54L5 24L4.46 21.54L2 21L4.46 20.46L5 18Z"/>
              </svg>
              AI Response
            </div>
            <div class="ai-response-text">${data.answer || data.explanation || ''}</div>
          </div>`;

        // Handle the different action types
        switch (data.action) {
          case 'search_athlete':
            // Show AI response with loading, then append athlete results
            resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="loading-state"><div class="loading-spinner"></div></div></section>`;
            await searchAthleteByNameWithAI(data.params?.query || query, aiResponseHtml);
            break;

          case 'search_event':
            resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="loading-state"><div class="loading-spinner"></div></div></section>`;
            await searchEventByNameWithAI(data.params?.query || query, aiResponseHtml);
            break;

          case 'get_rankings':
            resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="loading-state"><div class="loading-spinner"></div></div></section>`;
            // Store AI response, fetch rankings, then prepend it
            window.pendingAIResponse = aiResponseHtml;
            await fetchTopRankings();
            break;

          case 'show_favorites':
            resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="loading-state"><div class="loading-spinner"></div></div></section>`;
            window.pendingAIResponse = aiResponseHtml;
            await showFavorites();
            break;

          case 'compare_athletes':
            resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="loading-state"><div class="loading-spinner"></div></div></section>`;
            window.pendingAIResponse = aiResponseHtml;
            await compareAthletesByName(data.params?.athlete1, data.params?.athlete2);
            break;

          case 'get_upcoming_events':
            resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="loading-state"><div class="loading-spinner"></div></div></section>`;
            await fetchUpcomingEvents(data.params?.category || 'all', data.params?.limit || 5, aiResponseHtml);
            break;

          case 'get_event_calendar':
            resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="loading-state"><div class="loading-spinner"></div></div></section>`;
            await fetchEventCalendar(data.params?.year || new Date().getFullYear(), data.params?.category || 'all', aiResponseHtml);
            break;

          case 'answer':
          default:
            // Display the answer directly (no additional data to show)
            resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}</section>`;
            break;
        }

      } catch (error) {
        console.error('AI search error:', error);
        let errorMsg = 'Sorry, I couldn\'t process that request.';

        // Try to get more details from the error
        if (error.message) {
          errorMsg += ` (${error.message})`;
        }

        resultsDiv.innerHTML = `
          <section class="results-section">
            <div class="ai-response-card">
              <div class="ai-response-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L13.09 8.26L19 9L13.09 9.74L12 16L10.91 9.74L5 9L10.91 8.26L12 2Z"/>
                  <path d="M5 18L5.54 20.46L8 21L5.54 21.54L5 24L4.46 21.54L2 21L4.46 20.46L5 18Z"/>
                </svg>
                AI Response
              </div>
              <div class="ai-response-text">${errorMsg}</div>
              <div style="margin-top: var(--space-4); font-size: var(--text-xs); color: var(--text-tertiary);">
                Make sure ANTHROPIC_API_KEY is set in Vercel environment variables, or run with <code>vercel dev</code> locally.
              </div>
            </div>
          </section>`;
      }
    }

    function showAIResponse(text) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `
        <section class="results-section">
          <div class="ai-response-card">
            <div class="ai-response-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L13.09 8.26L19 9L13.09 9.74L12 16L10.91 9.74L5 9L10.91 8.26L12 2Z"/>
                <path d="M5 18L5.54 20.46L8 21L5.54 21.54L5 24L4.46 21.54L2 21L4.46 20.46L5 18Z"/>
              </svg>
              AI Response
            </div>
            <div class="ai-response-text">${text}</div>
          </div>
          <div class="loading-state">
            <div class="loading-spinner"></div>
          </div>
        </section>`;
    }

    // Helper to search athlete by name with AI response card preserved
    async function searchAthleteByNameWithAI(name, aiResponseHtml) {
      const resultsDiv = document.getElementById('results');

      try {
        const searchResponse = await fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(name)}&per_page=5`);
        if (!searchResponse.ok) throw new Error('Search failed');

        const searchData = await searchResponse.json();
        const athletes = searchData.data || [];

        if (athletes.length === 0) {
          resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="empty-state">No athletes found matching "${name}".</div></section>`;
          return;
        }

        // Get details for top results
        const athleteDetails = await Promise.all(
          athletes.slice(0, 3).map(a => getAthleteDetails(a.athlete_id))
        );

        const validAthletes = athleteDetails.filter(a => a);
        if (validAthletes.length === 1) {
          // Show AI response then athlete detail
          window.pendingAIResponse = aiResponseHtml;
          showAthleteDetail(validAthletes[0]);
        } else if (validAthletes.length > 1) {
          window.pendingAIResponse = aiResponseHtml;
          displayAthletes(validAthletes, `Results for "${name}"`);
        }
      } catch (error) {
        resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="error-message">Failed to search for athletes. Please try again.</div></section>`;
      }
    }

    // Helper to search event by name with AI response card preserved
    async function searchEventByNameWithAI(name, aiResponseHtml) {
      const resultsDiv = document.getElementById('results');

      try {
        const twoYearsAgo = new Date();
        twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
        const startDateStr = twoYearsAgo.toISOString().split('T')[0];

        const searchResponse = await fetch(`${API_BASE}?endpoint=/search/events&query=${encodeURIComponent(name)}&start_date=${startDateStr}&per_page=5`);
        if (!searchResponse.ok) throw new Error('Search failed');

        const searchData = await searchResponse.json();
        const events = searchData.data || [];

        if (events.length === 0) {
          resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="empty-state">No events found matching "${name}".</div></section>`;
          return;
        }

        // Show the most recent matching event
        window.pendingAIResponse = aiResponseHtml;
        const sortedEvents = events.sort((a, b) => new Date(b.event_date || 0) - new Date(a.event_date || 0));
        showEventDetail(sortedEvents[0].event_id);
      } catch (error) {
        resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="error-message">Failed to search for events. Please try again.</div></section>`;
      }
    }

    // Category ID mapping for World Triathlon API
    const EVENT_CATEGORIES = {
      wtcs: 351,        // World Triathlon Championship Series
      world_cup: 352,   // World Triathlon Cup
      all: null         // No filter - get all major events
    };

    // Helper to fetch upcoming events
    async function fetchUpcomingEvents(category, limit, aiResponseHtml) {
      const resultsDiv = document.getElementById('results');

      try {
        const today = new Date().toISOString().split('T')[0];
        const oneYearFromNow = new Date();
        oneYearFromNow.setFullYear(oneYearFromNow.getFullYear() + 1);
        const endDate = oneYearFromNow.toISOString().split('T')[0];

        let url = `${API_BASE}?endpoint=/events&start_date=${today}&end_date=${endDate}&per_page=${Math.min(limit * 3, 50)}`;

        const categoryId = EVENT_CATEGORIES[category];
        if (categoryId) {
          url += `&category_id=${categoryId}`;
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch events');

        const data = await response.json();
        let events = data.data || [];

        // Sort by date and take the requested limit
        events = events
          .filter(e => e.event_date)
          .sort((a, b) => new Date(a.event_date) - new Date(b.event_date))
          .slice(0, limit);

        if (events.length === 0) {
          resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="empty-state">No upcoming events found.</div></section>`;
          return;
        }

        // Build the events display
        const eventsHtml = events.map(event => createEventCard(event)).join('');
        const categoryLabel = category === 'wtcs' ? 'WTCS' : category === 'world_cup' ? 'World Cup' : 'Triathlon';

        resultsDiv.innerHTML = `
          <section class="results-section">
            ${aiResponseHtml}
            <div class="section-header">
              <h2 class="section-title">Upcoming ${categoryLabel} Events</h2>
              <span class="section-meta">${events.length} event${events.length !== 1 ? 's' : ''}</span>
            </div>
            <div class="events-list">
              ${eventsHtml}
            </div>
          </section>`;

      } catch (error) {
        console.error('Fetch upcoming events error:', error);
        resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="error-message">Failed to load upcoming events. Please try again.</div></section>`;
      }
    }

    // Helper to fetch event calendar for a year
    async function fetchEventCalendar(year, category, aiResponseHtml) {
      const resultsDiv = document.getElementById('results');

      try {
        const startDate = `${year}-01-01`;
        const endDate = `${year}-12-31`;

        let url = `${API_BASE}?endpoint=/events&start_date=${startDate}&end_date=${endDate}&per_page=100`;

        const categoryId = EVENT_CATEGORIES[category];
        if (categoryId) {
          url += `&category_id=${categoryId}`;
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch events');

        const data = await response.json();
        let events = data.data || [];

        // Sort by date
        events = events
          .filter(e => e.event_date)
          .sort((a, b) => new Date(a.event_date) - new Date(b.event_date));

        if (events.length === 0) {
          resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="empty-state">No events found for ${year}.</div></section>`;
          return;
        }

        // Group events by month
        const eventsByMonth = {};
        events.forEach(event => {
          const date = new Date(event.event_date);
          const monthKey = date.toLocaleString('en-US', { month: 'long' });
          if (!eventsByMonth[monthKey]) {
            eventsByMonth[monthKey] = [];
          }
          eventsByMonth[monthKey].push(event);
        });

        // Build the calendar display
        const monthsHtml = Object.entries(eventsByMonth).map(([month, monthEvents]) => `
          <div class="calendar-month">
            <h3 class="calendar-month-title">${month}</h3>
            <div class="events-list">
              ${monthEvents.map(event => createEventCard(event)).join('')}
            </div>
          </div>
        `).join('');

        const categoryLabel = category === 'wtcs' ? 'WTCS' : category === 'world_cup' ? 'World Cup' : 'Triathlon';

        resultsDiv.innerHTML = `
          <section class="results-section">
            ${aiResponseHtml}
            <div class="section-header">
              <h2 class="section-title">${year} ${categoryLabel} Calendar</h2>
              <span class="section-meta">${events.length} event${events.length !== 1 ? 's' : ''}</span>
            </div>
            <div class="calendar-view">
              ${monthsHtml}
            </div>
          </section>`;

      } catch (error) {
        console.error('Fetch event calendar error:', error);
        resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="error-message">Failed to load calendar. Please try again.</div></section>`;
      }
    }

    // Helper to create an event card
    function createEventCard(event) {
      const eventDate = new Date(event.event_date);
      const dateStr = eventDate.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
      const isPast = eventDate < new Date();

      return `
        <div class="event-card ${isPast ? 'event-past' : ''}" onclick="showEventDetail(${event.event_id})">
          <div class="event-card-date">
            <span class="event-card-day">${eventDate.getDate()}</span>
            <span class="event-card-month">${eventDate.toLocaleString('en-US', { month: 'short' })}</span>
          </div>
          <div class="event-card-info">
            <div class="event-card-title">${event.event_title}</div>
            <div class="event-card-location">
              ${event.event_venue ? `<span>${event.event_venue}</span>` : ''}
              ${event.event_country_noc ? `<span class="event-card-country">${event.event_country_noc}</span>` : ''}
            </div>
          </div>
          <span class="event-card-arrow"></span>
        </div>`;
    }

    // Helper to compare two athletes by name
    async function compareAthletesByName(name1, name2) {
      const resultsDiv = document.getElementById('results');

      try {
        // Search for both athletes in parallel
        const [search1, search2] = await Promise.all([
          fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(name1)}&per_page=1`),
          fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(name2)}&per_page=1`)
        ]);

        if (!search1.ok || !search2.ok) throw new Error('Search failed');

        const [data1, data2] = await Promise.all([search1.json(), search2.json()]);
        const athletes1 = data1.data || [];
        const athletes2 = data2.data || [];

        if (athletes1.length === 0 || athletes2.length === 0) {
          const aiResponseHtml = window.pendingAIResponse || '';
          window.pendingAIResponse = null;
          resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="empty-state">Could not find one or both athletes. Try different names.</div></section>`;
          return;
        }

        // Get full details for both
        const [athlete1, athlete2] = await Promise.all([
          getAthleteDetails(athletes1[0].athlete_id),
          getAthleteDetails(athletes2[0].athlete_id)
        ]);

        if (!athlete1 || !athlete2) throw new Error('Could not load athlete details');

        // Set up comparison state and show
        comparisonState.athlete1 = athlete1;
        comparisonState.athlete2 = athlete2;
        comparisonState.mode = 'comparing';
        showComparison();
      } catch (error) {
        const aiResponseHtml = window.pendingAIResponse || '';
        window.pendingAIResponse = null;
        resultsDiv.innerHTML = `<section class="results-section">${aiResponseHtml}<div class="error-message">Failed to compare athletes. Please try again.</div></section>`;
      }
    }

    // --- SETUP EVENT LISTENERS ---
    const searchInput = document.getElementById('athleteName');
    const navSearchInput = document.getElementById('navSearchInput');
    let selectedIndex = -1;
    let navSelectedIndex = -1;

    // Old search input (hidden) - keep for backward compatibility
    if (searchInput) {
      searchInput.addEventListener('keydown', function(event) {
        const autocompleteResults = document.getElementById('autocomplete-results');
        const items = autocompleteResults.querySelectorAll('.autocomplete-item');
        
        if (event.key === 'ArrowDown') {
            event.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection(items);
        } else if (event.key === 'ArrowUp') {
            event.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(items);
        } else if (event.key === 'Enter') {
            event.preventDefault();
            if (selectedIndex >= 0 && items[selectedIndex]) {
                items[selectedIndex].click();
            } else {
                autocompleteResults.style.display = 'none';
                searchAthlete();
            }
        } else if (event.key === 'Escape') {
            autocompleteResults.style.display = 'none';
            selectedIndex = -1;
        }
    });

    function updateSelection(items) {
        items.forEach((item, index) => {
            const isActive = index === selectedIndex;
            item.classList.toggle('is-active', isActive);
            item.setAttribute('aria-selected', isActive ? 'true' : 'false');
            if (isActive) {
                item.scrollIntoView({ block: 'nearest' });
            }
        });
    }

      searchInput.addEventListener('input', debounce(handleAutocomplete, 300));
    }

    // Nav search keyboard navigation
    navSearchInput.addEventListener('keydown', function(event) {
      const autocompleteResults = document.getElementById('nav-autocomplete-results');
      const items = autocompleteResults.querySelectorAll('.autocomplete-item');

      if (event.key === 'ArrowDown') {
        event.preventDefault();
        navSelectedIndex = Math.min(navSelectedIndex + 1, items.length - 1);
        updateNavSelection(items);
      } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        navSelectedIndex = Math.max(navSelectedIndex - 1, -1);
        updateNavSelection(items);
      } else if (event.key === 'Enter') {
        event.preventDefault();
        // Check if AI mode is enabled
        if (aiSearchEnabled) {
          handleAISearch(navSearchInput.value);
        } else if (navSelectedIndex >= 0 && items[navSelectedIndex]) {
          items[navSelectedIndex].click();
        }
      } else if (event.key === 'Escape') {
        closeNavSearch();
      }
    });

    function updateNavSelection(items) {
      items.forEach((item, index) => {
        const isActive = index === navSelectedIndex;
        item.classList.toggle('is-active', isActive);
        if (isActive) {
          item.scrollIntoView({ block: 'nearest' });
        }
      });
    }

    // Only show autocomplete when not in AI mode
    navSearchInput.addEventListener('input', debounce(function() {
      if (!aiSearchEnabled) {
        handleNavAutocomplete();
      } else {
        // Hide recent searches when user starts typing in AI mode
        hideRecentAISearches();
      }
    }, 300));

    // Hide/show recent searches based on input in AI mode
    navSearchInput.addEventListener('input', function() {
      if (aiSearchEnabled) {
        if (this.value.length > 0) {
          hideRecentAISearches();
        } else {
          showRecentAISearches();
        }
      }
    });

    document.addEventListener('click', function(event) {
      const searchBox = document.querySelector('.search-box');
      const navSearch = document.getElementById('nav-search');
      const autocompleteResults = document.getElementById('autocomplete-results');
      const recentSearches = document.getElementById('recent-ai-searches');
      if (searchBox && autocompleteResults && !searchBox.contains(event.target)) {
        autocompleteResults.style.display = 'none';
      }
      if (navSearch && !navSearch.contains(event.target)) {
        closeNavSearch();
        // Also hide recent AI searches when clicking outside
        if (recentSearches) {
          recentSearches.style.display = 'none';
        }
      }
    });

    // --- Nav autocomplete handler ---
    async function handleNavAutocomplete() {
      const query = navSearchInput.value;
      const autocompleteResults = document.getElementById('nav-autocomplete-results');

      if (query.length < 2) {
        autocompleteResults.style.display = 'none';
        return;
      }

      autocompleteResults.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
      autocompleteResults.style.display = 'block';

      const twoYearsAgo = new Date();
      twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
      const startDateStr = twoYearsAgo.toISOString().split('T')[0];

      const [athleteResponse, eventResponse] = await Promise.all([
        fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(query)}&per_page=4`),
        fetch(`${API_BASE}?endpoint=/search/events&query=${encodeURIComponent(query)}&start_date=${startDateStr}&per_page=10`)
      ]);

      const athleteData = athleteResponse.ok ? await athleteResponse.json() : { data: [] };
      const eventData = eventResponse.ok ? await eventResponse.json() : { data: [] };

      const athletes = athleteData.data || [];
      const events = eventData.data || [];

      if (athletes.length === 0 && events.length === 0) {
        autocompleteResults.innerHTML = '<div class="autocomplete-empty">No results found</div>';
        return;
      }

      autocompleteResults.innerHTML = '';
      navSelectedIndex = -1;

      athletes.forEach(athlete => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.innerHTML = `<span class="autocomplete-type athlete">Athlete</span>${athlete.athlete_title}`;
        item.onclick = async () => {
          closeNavSearch();
          currentRankingsData = null;
          const resultsDiv = document.getElementById('results');
          resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading athlete...</div>';
          const details = await getAthleteDetails(athlete.athlete_id);
          if (details) {
            showAthleteDetail(details);
          } else {
            resultsDiv.innerHTML = '<div class="error-message">Unable to load athlete details.</div>';
          }
        };
        autocompleteResults.appendChild(item);
      });

      const recentEvents = [...events]
        .sort((a, b) => new Date(b.event_date || 0) - new Date(a.event_date || 0))
        .slice(0, 3);

      recentEvents.forEach(event => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        const eventDate = event.event_date ? new Date(event.event_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
        item.innerHTML = `<span class="autocomplete-type event">Event</span><span class="autocomplete-event-title">${event.event_title}</span>${eventDate ? `<span class="autocomplete-event-date">${eventDate}</span>` : ''}`;
        item.onclick = async () => {
          closeNavSearch();
          currentRankingsData = null;
          showEventDetail(event.event_id);
        };
        autocompleteResults.appendChild(item);
      });

      autocompleteResults.style.display = 'block';
    }

    // --- Autocomplete handler (searches athletes and events) ---
    async function handleAutocomplete() {
      const query = searchInput.value;
      const autocompleteResults = document.getElementById('autocomplete-results');

      if (query.length < 2) {
        autocompleteResults.style.display = 'none';
        return;
      }

      // Show loading state
      autocompleteResults.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
      autocompleteResults.style.display = 'block';

      // Fetch athletes and events in parallel (filter events to last 2 years via API)
      const twoYearsAgo = new Date();
      twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
      const startDateStr = twoYearsAgo.toISOString().split('T')[0];

      const [athleteResponse, eventResponse] = await Promise.all([
        fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(query)}&per_page=4`),
        fetch(`${API_BASE}?endpoint=/search/events&query=${encodeURIComponent(query)}&start_date=${startDateStr}&per_page=10`)
      ]);

      const athleteData = athleteResponse.ok ? await athleteResponse.json() : { data: [] };
      const eventData = eventResponse.ok ? await eventResponse.json() : { data: [] };

      const athletes = athleteData.data || [];
      const events = eventData.data || [];

      if (athletes.length === 0 && events.length === 0) {
        autocompleteResults.innerHTML = '<div class="autocomplete-empty">No results found</div>';
        return;
      }

      autocompleteResults.innerHTML = '';
      selectedIndex = -1;

      // Add athletes
      athletes.forEach(athlete => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.innerHTML = `<span class="autocomplete-type athlete">Athlete</span>${athlete.athlete_title}`;
        item.setAttribute('role', 'option');
        item.setAttribute('data-athlete-id', athlete.athlete_id);
        item.tabIndex = -1;
        item.onclick = async () => {
          searchInput.value = athlete.athlete_title;
          autocompleteResults.style.display = 'none';
          selectedIndex = -1;
          currentRankingsData = null;
          const resultsDiv = document.getElementById('results');
          resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading athlete...</div>';
          const details = await getAthleteDetails(athlete.athlete_id);
          if (details) {
            showAthleteDetail(details);
          } else {
            resultsDiv.innerHTML = '<div class="error-message">Unable to load athlete details.</div>';
          }
        };
        autocompleteResults.appendChild(item);
      });

      // Sort events by recency and take top 3
      const recentEvents = [...events]
        .sort((a, b) => new Date(b.event_date || 0) - new Date(a.event_date || 0))
        .slice(0, 3);

      // Add events
      recentEvents.forEach(event => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        const eventDate = event.event_date ? new Date(event.event_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
        item.innerHTML = `<span class="autocomplete-type event">Event</span><span class="autocomplete-event-title">${event.event_title}</span>${eventDate ? `<span class="autocomplete-event-date">${eventDate}</span>` : ''}`;
        item.setAttribute('role', 'option');
        item.setAttribute('data-event-id', event.event_id);
        item.tabIndex = -1;
        item.onclick = async () => {
          searchInput.value = event.event_title;
          autocompleteResults.style.display = 'none';
          selectedIndex = -1;
          currentRankingsData = null;
          showEventDetail(event.event_id);
        };
        autocompleteResults.appendChild(item);
      });

      autocompleteResults.style.display = 'block';
    }

    // --- Function to create initials from name for placeholders ---
    function getInitials(name) {
      if (!name) return '';
      return name
        .split(' ')
        .map(word => word[0])
        .join('')
        .toUpperCase();
    }
    
    // --- Fetches full details for a single athlete (with caching) ---
    async function getAthleteDetails(athleteId) {
      // Return cached data if available
      if (athleteCache.has(athleteId)) {
        return athleteCache.get(athleteId);
      }

      const response = await fetch(`${API_BASE}?endpoint=/athletes/${athleteId}`);
      if (!response.ok) return null;
      const data = await response.json();

      // Cache the result for future use
      athleteCache.set(athleteId, data.data);
      return data.data;
    }

    // --- UPDATED: Renders athlete cards with premium design ---
    function displayAthletes(athleteData, title = "Search Results") {
        const resultsDiv = document.getElementById('results');

        // Helper to get rank class
        const getRankClass = (rank) => {
            if (rank === 1) return 'athlete-rank gold';
            if (rank === 2) return 'athlete-rank silver';
            if (rank === 3) return 'athlete-rank bronze';
            return 'athlete-rank';
        };

        // Function to generate the HTML for a single athlete card
        const createAthleteCardHtml = (athlete, rank = null) => {
            const hasValidImage = athlete.athlete_profile_image && athlete.athlete_profile_image.startsWith('http');
            const imageHtml = hasValidImage ?
                `<img class="athlete-avatar" src="${athlete.athlete_profile_image}" alt="${athlete.athlete_full_name}" onerror="this.onerror=null; this.outerHTML='<div class=\\'athlete-placeholder\\'>${getInitials(athlete.athlete_full_name)}</div>'">` :
                `<div class="athlete-placeholder">${getInitials(athlete.athlete_full_name)}</div>`;

            const rankHtml = rank ? `<div class="${getRankClass(rank)}">${rank}</div>` : '';

            // Calculate age from year of birth
            const currentYear = new Date().getFullYear();
            const age = athlete.athlete_yob ? currentYear - parseInt(athlete.athlete_yob) : null;

            // Build results HTML
            const resultsHtml = (athlete.latest_results && athlete.latest_results.length > 0) ?
                `<div class="athlete-section">
                    <div class="athlete-section-title">Recent Results</div>
                    <div class="results-grid">${athlete.latest_results.slice(0, 6).map(result => {
                        const year = result.event_date ? new Date(result.event_date).getFullYear() : '';
                        const eventTitle = result.event_title || 'Race';
                        const position = parseInt(result.position) || 0;
                        const positionClass = position <= 3 ? 'result-position top3' : 'result-position';
                        const resultUrl = result.result_listing || '#';
                        return `<a href="${resultUrl}" target="_blank" class="result-item">
                            <div>
                                <div class="result-event">${eventTitle}</div>
                                <div class="result-year">${year}</div>
                            </div>
                            <div class="${positionClass}">${position > 0 ? '#' + position : ''}</div>
                        </a>`;
                    }).join('')}</div>
                </div>` : '';

            // Build gallery HTML
            // Store images for lightbox
            const galleryImages = athlete.latest_images ? athlete.latest_images.slice(0, 8).map(img => ({
                thumbnail: img.thumbnail || img.image_url || '',
                full: img.image_url || img.thumbnail || ''
            })).filter(img => img.thumbnail) : [];

            const galleryHtml = galleryImages.length > 0 ?
                `<div class="athlete-section">
                    <div class="athlete-section-title">Photos</div>
                    <div class="gallery-grid" id="athlete-gallery">${galleryImages.map((img, index) =>
                        `<div class="gallery-item" onclick="openLightbox(${index})"><img src="${img.thumbnail}" alt="" loading="lazy" onerror="this.parentElement.style.display='none'"></div>`
                    ).join('')}</div>
                </div>` : '';

            // Store gallery data globally for lightbox
            window.currentGalleryImages = galleryImages;

            // Check if we have any body content
            const hasBodyContent = resultsHtml || galleryHtml;

            return `
              <article class="athlete-card">
                <div class="athlete-hero">
                  <div class="athlete-photo">
                    ${imageHtml}
                    ${rankHtml}
                  </div>
                  <div class="athlete-info">
                    <div class="athlete-header">
                      <span class="athlete-name">${athlete.athlete_full_name}</span>
                      <img class="athlete-flag" src="${athlete.athlete_flag || ''}" alt="" onerror="this.style.display='none'">
                    </div>
                    <div class="athlete-country">${athlete.athlete_country_name || ''}</div>
                    <div class="athlete-stats">
                      ${age ? `<div class="athlete-stat"><span class="athlete-stat-label">Age</span><span class="athlete-stat-value">${age}</span></div>` : ''}
                      ${athlete.race_wins ? `<div class="athlete-stat"><span class="athlete-stat-label">Wins</span><span class="athlete-stat-value">${athlete.race_wins}</span></div>` : ''}
                      ${athlete.race_podiums ? `<div class="athlete-stat"><span class="athlete-stat-label">Podiums</span><span class="athlete-stat-value">${athlete.race_podiums}</span></div>` : ''}
                    </div>
                    <div class="athlete-actions">
                      <a href="${athlete.athlete_listing}" class="athlete-link" target="_blank">View on triathlon.org</a>
                      <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(athlete.athlete_full_name + ' triathlon')}" class="athlete-link athlete-link-secondary" target="_blank" rel="noopener">Videos </a>
                    </div>
                  </div>
                </div>
                ${hasBodyContent ? `<div class="athlete-body">${resultsHtml}${galleryHtml}</div>` : ''}
              </article>`;
        };

        // Determine count for meta
        let count = 0;
        if (Array.isArray(athleteData)) {
            count = athleteData.filter(a => a).length;
        } else if (athleteData.men && athleteData.women) {
            count = athleteData.men.filter(a => a).length + athleteData.women.filter(a => a).length;
        }

        // Check for pending AI response to prepend
        const aiResponseHtml = window.pendingAIResponse || '';
        window.pendingAIResponse = null; // Clear after using

        let contentHtml = `
          <section class="results-section">
            ${aiResponseHtml}
            <div class="section-header">
              <h2 class="section-title">${title}</h2>
              <span class="section-meta">${count} athlete${count !== 1 ? 's' : ''}</span>
            </div>`;

        // Check if we need to render columns or a single list
        if (Array.isArray(athleteData)) {
            const cardsHtml = athleteData.filter(a => a).map(a => createAthleteCardHtml(a)).join('');
            contentHtml += `<div class="athlete-list">${cardsHtml}</div>`;
        } else if (typeof athleteData === 'object' && athleteData.men && athleteData.women) {
            const menHtml = athleteData.men.filter(a => a).map((a, i) => createAthleteCardHtml(a, i + 1)).join('');
            const womenHtml = athleteData.women.filter(a => a).map((a, i) => createAthleteCardHtml(a, i + 1)).join('');
            contentHtml += `
              <div class="rankings-grid">
                <div class="ranking-column">
                  <div class="ranking-column-title">Men</div>
                  ${menHtml}
                </div>
                <div class="ranking-column">
                  <div class="ranking-column-title">Women</div>
                  ${womenHtml}
                </div>
              </div>`;
        }

        contentHtml += '</section>';

        resultsDiv.innerHTML = contentHtml;
        if (!resultsDiv.innerHTML.includes('athlete-card')) {
            resultsDiv.innerHTML = '<div class="empty-state">No matching athletes found.</div>';
        }

        // Smooth scroll to results
        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- Show event detail view ---
    async function showEventDetail(eventId) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading event...</div>';

        try {
            // Fetch event details and programs in parallel
            const [eventResponse, programsResponse] = await Promise.all([
                fetch(`${API_BASE}?endpoint=/events/${eventId}`),
                fetch(`${API_BASE}?endpoint=/events/${eventId}/programs`)
            ]);

            if (!eventResponse.ok) {
                resultsDiv.innerHTML = '<div class="error-message">Unable to load event details.</div>';
                return;
            }

            const eventData = await eventResponse.json();
            const programsData = programsResponse.ok ? await programsResponse.json() : { data: [] };

            const event = eventData.data;
            const programs = (programsData.data || []).filter(p => p.results && p.is_race);

            // Format date
            const startDate = event.event_date ? new Date(event.event_date) : null;
            const endDate = event.event_finish_date ? new Date(event.event_finish_date) : null;
            let dateStr = '';
            if (startDate) {
                dateStr = startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                if (endDate && endDate.getTime() !== startDate.getTime()) {
                    dateStr += ' - ' + endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                }
            }

            // Build programs HTML
            const programsHtml = programs.length > 0 ? `
                <div class="event-programs">
                    <div class="event-programs-title">Race Results</div>
                    <div class="event-program-list">
                        ${programs.map(p => {
                            const progDate = p.prog_date ? new Date(p.prog_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                            const progDateISO = p.prog_date || event.event_date || '';
                            return `
                                <div class="event-program-item" onclick="showProgramResults(${event.event_id}, ${p.prog_id}, '${(p.prog_name || '').replace(/'/g, "\\'")}', '${progDateISO}')">
                                    <div class="event-program-info">
                                        <span class="event-program-name">${p.prog_name || 'Race'}</span>
                                        <span class="event-program-badge">Results</span>
                                    </div>
                                    <span class="event-program-date">${progDate}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : '<div class="event-programs"><p style="color: var(--text-tertiary); font-size: var(--text-sm);">No race results available for this event.</p></div>';

            // Check for pending AI response to prepend
            const aiResponseHtml = window.pendingAIResponse || '';
            window.pendingAIResponse = null; // Clear after using

            resultsDiv.innerHTML = `
                <section class="results-section">
                    ${aiResponseHtml}
                    <article class="event-card">
                        <div class="event-header">
                            <h1 class="event-title">${event.event_title}</h1>
                            <div class="event-meta">
                                ${dateStr ? `<span class="event-meta-item">${dateStr}</span>` : ''}
                                ${event.event_venue ? `<span class="event-meta-item">${event.event_venue}, ${event.event_country || ''}</span>` : ''}
                            </div>
                            ${event.event_listing ? `<a href="${event.event_listing}" target="_blank" class="event-link">View on triathlon.org </a>` : ''}
                        </div>
                        ${programsHtml}
                    </article>
                </section>
            `;

            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

        } catch (error) {
            console.error('Failed to load event:', error);
            resultsDiv.innerHTML = '<div class="error-message">Unable to load event details.</div>';
        }
    }

    // --- Show program results in modal ---
    window.showProgramResults = async function(eventId, progId, progName, eventDate) {
        // Reuse the race details modal
        const result = {
            event_id: eventId,
            prog_id: progId,
            prog_name: progName,
            event_title: progName,
            event_date: eventDate || new Date().toISOString(),
            result_listing: `https://www.triathlon.org/results`
        };

        showRaceDetailsModal(result);

        try {
            const cacheKey = `${eventId}_${progId}`;
            
            // Check cache first
            if (splitDataCache[cacheKey]) {
                const cached = splitDataCache[cacheKey];
                const sortedResults = cached.allResults
                    .filter(r => r.position && !isNaN(parseInt(r.position)))
                    .sort((a, b) => parseInt(a.position) - parseInt(b.position))
                    .slice(0, 10);
                if (sortedResults.length > 0) {
                    updateRaceDetailsModal(result, sortedResults);
                } else {
                    updateRaceDetailsModal(result, cached.allResults.slice(0, 10));
                }
                return;
            }

            const response = await fetch(`${API_BASE}?endpoint=/events/${eventId}/programs/${progId}/results`);
            const data = await response.json();

            // Log API structure for debugging
            logApiStructure(data, `for program ${eventId}/${progId}`);

            if (data.data && data.data.results && Array.isArray(data.data.results)) {
                const allResults = data.data.results;
                
                // Enhance all results with split data
                const enhancedResults = allResults.map(r => enhanceResultWithSplits(r, allResults));
                
                // Cache the enhanced results
                splitDataCache[cacheKey] = {
                    allResults: enhancedResults,
                    timestamp: Date.now()
                };

                const sortedResults = enhancedResults
                    .filter(r => r.position && !isNaN(parseInt(r.position)))
                    .sort((a, b) => parseInt(a.position) - parseInt(b.position))
                    .slice(0, 10);

                if (sortedResults.length > 0) {
                    updateRaceDetailsModal(result, sortedResults);
                } else {
                    updateRaceDetailsModal(result, enhancedResults.slice(0, 10));
                }
            } else {
                showRaceDetailsError(result);
            }
        } catch (error) {
            console.error('Failed to fetch program results:', error);
            showRaceDetailsError(result);
        }
    };

    // --- Show athlete detail view with back button ---
    function showAthleteDetail(athlete, rank = null) {
        const resultsDiv = document.getElementById('results');

        // Update URL for sharing
        const newUrl = `?athlete=${athlete.athlete_id}`;
        history.pushState({ athleteId: athlete.athlete_id }, '', newUrl);

        // Helper to get rank class
        const getRankClass = (rank) => {
            if (rank === 1) return 'athlete-rank gold';
            if (rank === 2) return 'athlete-rank silver';
            if (rank === 3) return 'athlete-rank bronze';
            return 'athlete-rank';
        };

        const hasValidImage = athlete.athlete_profile_image && athlete.athlete_profile_image.startsWith('http');
        const imageHtml = hasValidImage ?
            `<img class="athlete-avatar" src="${athlete.athlete_profile_image}" alt="${athlete.athlete_full_name}" onerror="this.onerror=null; this.outerHTML='<div class=\\'athlete-placeholder\\'>${getInitials(athlete.athlete_full_name)}</div>'">` :
            `<div class="athlete-placeholder">${getInitials(athlete.athlete_full_name)}</div>`;

        const rankHtml = rank ? `<div class="${getRankClass(rank)}">${rank}</div>` : '';

        // Calculate age
        const currentYear = new Date().getFullYear();
        const age = athlete.athlete_yob ? currentYear - parseInt(athlete.athlete_yob) : null;

        // Favorite button
        const isFav = favoritesManager.isFavorite(athlete.athlete_id);
        const favoriteBtn = `
            <button class="favorite-btn ${isFav ? 'is-favorite' : ''}" onclick="toggleFavorite(${athlete.athlete_id}, this)" aria-label="Toggle favorite">
                <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            </button>`;

        // Compare button
        const compareBtn = `
            <span class="compare-btn-wrapper">
                <button class="athlete-link athlete-link-secondary" onclick="startComparison(${athlete.athlete_id})">Compare</button>
            </span>`;

        // Share and copy buttons
        const shareBtn = `<button class="athlete-link athlete-link-secondary" onclick="shareAthlete(${athlete.athlete_id}, '${athlete.athlete_full_name.replace(/'/g, "\\'")}')">Share</button>`;
        const copyBtn = `<button class="athlete-link athlete-link-icon" onclick="copyAthleteLink(${athlete.athlete_id})" title="Copy link to clipboard"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>`;

        // Build results HTML
        const getPositionClass = (pos) => {
            if (pos === 1) return 'result-position gold';
            if (pos === 2) return 'result-position silver';
            if (pos === 3) return 'result-position bronze';
            return 'result-position';
        };

        // Store results for click handling
        window.currentAthleteResults = athlete.latest_results || [];

        const resultsHtml = (athlete.latest_results && athlete.latest_results.length > 0) ?
            `<div class="athlete-section">
                <div class="athlete-section-title">Recent Results</div>
                <div class="results-grid">${athlete.latest_results.slice(0, 6).map((result, idx) => {
                    const year = result.event_date ? new Date(result.event_date).getFullYear() : '';
                    const eventTitle = result.event_title || 'Race';
                    const position = parseInt(result.position) || 0;
                    const positionClass = getPositionClass(position);
                    const isTeamRelay = result.prog_name && (result.prog_name.toLowerCase().includes('relay') || result.prog_name.toLowerCase().includes('team') || result.prog_name.toLowerCase().includes('mixed'));
                    const clickHandler = isTeamRelay ? '' : `onclick="showAthleteResultDetails(${idx})"`;
                    return `<div class="result-item ${isTeamRelay ? '' : 'clickable'}" ${clickHandler}>
                        <div>
                            <div class="result-event">${eventTitle}</div>
                            <div class="result-year">${year}</div>
                        </div>
                        <div class="${positionClass}">${position > 0 ? '#' + position : ''}</div>
                    </div>`;
                }).join('')}</div>
            </div>` : '';

        // Chart HTML - shows recent race finishes with split analysis
        const chartHtml = (athlete.latest_results && athlete.latest_results.length >= 2) ?
            `<div class="athlete-section">
                <div class="athlete-section-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-2);">
                    <span>Performance Analysis</span>
                    <div class="chart-type-selector" style="display: flex; gap: var(--space-1); flex-wrap: wrap;">
                        <button class="chart-type-btn active" data-chart-type="position" onclick="switchChartType('position')" style="font-size: var(--text-xs); padding: 4px 8px;">Position</button>
                        <button class="chart-type-btn" data-chart-type="swim" onclick="switchChartType('swim')" style="font-size: var(--text-xs); padding: 4px 8px;">Swim</button>
                        <button class="chart-type-btn" data-chart-type="bike" onclick="switchChartType('bike')" style="font-size: var(--text-xs); padding: 4px 8px;">Bike</button>
                        <button class="chart-type-btn" data-chart-type="run" onclick="switchChartType('run')" style="font-size: var(--text-xs); padding: 4px 8px;">Run</button>
                        <button class="chart-type-btn" data-chart-type="relative" onclick="switchChartType('relative')" style="font-size: var(--text-xs); padding: 4px 8px;">Relative</button>
                    </div>
                </div>
                <div class="chart-container">
                    <div style="height: 280px;">
                        <canvas id="results-chart"></canvas>
                    </div>
                    <div class="chart-legend" id="chart-legend">
                        <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #f59e0b;"></span> 1st</div>
                        <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #6b7280;"></span> 2nd</div>
                        <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #ea580c;"></span> 3rd</div>
                        <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #10b981;"></span> Top 5</div>
                        <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #3b82f6;"></span> Top 10</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: var(--space-3);">
                    <button id="load-more-results-btn" class="athlete-link athlete-link-secondary" onclick="toggleResultsView(${athlete.athlete_id})" style="font-size: var(--text-xs); height: 32px;" data-view="recent">
                        Load Full Race History
                    </button>
                </div>
            </div>` : '';

        // Build gallery HTML
        // Store images for lightbox
        const galleryImages = athlete.latest_images ? athlete.latest_images.slice(0, 8).map(img => ({
            thumbnail: img.thumbnail || img.image_url || '',
            full: img.image_url || img.thumbnail || ''
        })).filter(img => img.thumbnail) : [];

        const galleryHtml = galleryImages.length > 0 ?
            `<div class="athlete-section">
                <div class="athlete-section-title">Photos</div>
                <div class="gallery-grid" id="athlete-gallery">${galleryImages.map((img, index) =>
                    `<div class="gallery-item" onclick="openLightbox(${index})"><img src="${img.thumbnail}" alt="" loading="lazy" onerror="this.parentElement.style.display='none'"></div>`
                ).join('')}</div>
            </div>` : '';

        // Store gallery data globally for lightbox
        window.currentGalleryImages = galleryImages;

        // Statistical insights panel (will be populated async when split data is available)
        const insightsHtml = '<div id="statistical-insights-container"></div>';

        const hasBodyContent = resultsHtml || chartHtml || galleryHtml || insightsHtml;

        // Show back button only if we came from rankings
        const backBtnHtml = currentRankingsData ?
            `<button class="back-btn" onclick="displayRankings()"> Back to Rankings</button>` : '';

        // Check for pending AI response to prepend
        const aiResponseHtml = window.pendingAIResponse || '';
        window.pendingAIResponse = null; // Clear after using

        resultsDiv.innerHTML = `
            <section class="results-section">
                ${aiResponseHtml}
                ${backBtnHtml}
                <article class="athlete-card">
                    <div class="athlete-hero">
                        <div class="athlete-photo">
                            ${imageHtml}
                            ${rankHtml}
                        </div>
                        <div class="athlete-info">
                            <div class="athlete-header">
                                <span class="athlete-name">${athlete.athlete_full_name}</span>
                                <img class="athlete-flag" src="${athlete.athlete_flag || ''}" alt="" onerror="this.style.display='none'">
                                ${favoriteBtn}
                            </div>
                            <div class="athlete-country">${athlete.athlete_country_name || ''}</div>
                            <div class="athlete-stats">
                                ${age ? `<div class="athlete-stat"><span class="athlete-stat-label">Age</span><span class="athlete-stat-value">${age}</span></div>` : ''}
                                ${athlete.race_wins ? `<div class="athlete-stat"><span class="athlete-stat-label">Wins</span><span class="athlete-stat-value">${athlete.race_wins}</span></div>` : ''}
                                ${athlete.race_podiums ? `<div class="athlete-stat"><span class="athlete-stat-label">Podiums</span><span class="athlete-stat-value">${athlete.race_podiums}</span></div>` : ''}
                                ${athlete.world_rank ? `<div class="athlete-stat"><span class="athlete-stat-label">World Rank</span><span class="athlete-stat-value">#${athlete.world_rank}</span></div>` : ''}
                            </div>
                            <div id="discipline-strength-container"></div>
                            <div class="athlete-actions">
                                <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(athlete.athlete_full_name + ' triathlon')}" class="athlete-link athlete-link-secondary" target="_blank" rel="noopener">Videos </a>
                                ${copyBtn}
                                ${shareBtn}
                                ${compareBtn}
                            </div>
                        </div>
                    </div>
                    ${hasBodyContent ? `<div class="athlete-body">${chartHtml}${insightsHtml}${resultsHtml}${galleryHtml}<div style="margin-top: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--border-primary); text-align: center;"><a href="${athlete.athlete_listing}" class="athlete-link" target="_blank">View on triathlon.org</a></div></div>` : `<div class="athlete-body" style="padding: var(--space-8) 0; border-top: 1px solid var(--border-primary); text-align: center;"><a href="${athlete.athlete_listing}" class="athlete-link" target="_blank">View on triathlon.org</a></div>`}
                </article>
            </section>`;

        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Render chart after DOM update
        if (athlete.latest_results && athlete.latest_results.length >= 2) {
            // Cache recent results for toggle functionality
            recentResultsCache[athlete.athlete_id] = athlete.latest_results;
            setTimeout(() => renderResultsChart(athlete.latest_results), 0);
            
            // Calculate and display discipline strength (async - will update when split data is available)
            setTimeout(() => {
                const strength = calculateDisciplineStrength(athlete.latest_results);
                const container = document.getElementById('discipline-strength-container');
                if (container && strength && strength.hasData) {
                    container.innerHTML = getDisciplineStrengthBadge(strength);
                }
            }, 100);
        }
        
        // Try to enhance results with split data (async, non-blocking)
        if (athlete.latest_results && athlete.latest_results.length > 0) {
            enhanceResultsWithSplitData(athlete.athlete_id, athlete.latest_results).then(enhancedResults => {
                if (enhancedResults && enhancedResults.length > 0) {
                    // Recalculate discipline strength with enhanced data
                    const strength = calculateDisciplineStrength(enhancedResults);
                    const container = document.getElementById('discipline-strength-container');
                    if (container && strength && strength.hasData) {
                        container.innerHTML = getDisciplineStrengthBadge(strength);
                    }
                    
                    // Calculate and display statistical insights
                    const insights = calculateStatisticalInsights(enhancedResults);
                    const insightsContainer = document.getElementById('statistical-insights-container');
                    if (insightsContainer && insights) {
                        insightsContainer.innerHTML = generateStatisticalInsightsPanel(insights);
                    }
                    
                    // Update chart if split data is now available
                    if (currentChartResults.length > 0) {
                        // Merge enhanced data back into current results
                        const updatedResults = currentChartResults.map(r => {
                            const enhanced = enhancedResults.find(e => 
                                e.event_id === r.event_id && e.prog_id === r.prog_id
                            );
                            return enhanced || r;
                        });
                        currentChartResults = updatedResults;
                        renderResultsChart(updatedResults, currentChartType);
                    }
                }
            }).catch(err => {
                console.log('Could not enhance results with split data:', err);
            });
        }
    }

    // --- Display rankings using compact rows ---
    function displayRankings() {
        if (!currentRankingsData) return;

        const resultsDiv = document.getElementById('results');
        const { men, women, title } = currentRankingsData;

        const count = men.filter(a => a).length + women.filter(a => a).length;

        // Function to generate compact ranking item
        const createRankingItem = (athlete, rank) => {
            const hasValidImage = athlete.athlete_profile_image && athlete.athlete_profile_image.startsWith('http');
            const photoHtml = hasValidImage ?
                `<img class="ranking-item-photo" src="${athlete.athlete_profile_image}" alt="" onerror="this.onerror=null; this.outerHTML='<div class=\\'ranking-item-placeholder\\'>${getInitials(athlete.athlete_full_name)}</div>'">` :
                `<div class="ranking-item-placeholder">${getInitials(athlete.athlete_full_name)}</div>`;

            const rankClass = rank <= 3 ? 'ranking-item-rank top3' : 'ranking-item-rank';
            const athleteIndex = rank - 1;
            const gender = men.includes(athlete) ? 'men' : 'women';

            return `
                <div class="ranking-item" onclick="showAthleteFromRankings('${gender}', ${athleteIndex}, ${rank})">
                    <span class="${rankClass}">${rank}</span>
                    ${photoHtml}
                    <div class="ranking-item-info">
                        <span class="ranking-item-name">${athlete.athlete_full_name}</span>
                        <div class="ranking-item-country">
                            <img class="ranking-item-flag" src="${athlete.athlete_flag || ''}" alt="" onerror="this.style.display='none'">
                            <span>${athlete.athlete_country_name || ''}</span>
                        </div>
                    </div>
                    <span class="ranking-item-arrow"></span>
                </div>`;
        };

        const menHtml = men.filter(a => a).map((a, i) => createRankingItem(a, i + 1)).join('');
        const womenHtml = women.filter(a => a).map((a, i) => createRankingItem(a, i + 1)).join('');

        // Show "Load more" button if there are more rankings to load
        const hasMore = rankingsLoaded < RANKINGS_MAX;
        const loadMoreHtml = hasMore ? `
            <div style="text-align: center; margin-top: var(--space-6);">
                <button id="load-more-btn" class="quick-btn" onclick="loadMoreRankings()" style="padding: var(--space-3) var(--space-6);">
                    Load More (${rankingsLoaded}/${RANKINGS_MAX})
                </button>
            </div>
        ` : '';

        // Check for pending AI response to prepend
        const aiResponseHtml = window.pendingAIResponse || '';
        window.pendingAIResponse = null; // Clear after using

        resultsDiv.innerHTML = `
            <section class="results-section">
                ${aiResponseHtml}
                <div class="section-header">
                    <h2 class="section-title">${title}</h2>
                    <span class="section-meta">Showing ${count} of ${RANKINGS_MAX * 2} athletes</span>
                </div>
                <div class="rankings-grid">
                    <div class="ranking-column">
                        <div class="ranking-column-title">Men</div>
                        ${menHtml}
                    </div>
                    <div class="ranking-column">
                        <div class="ranking-column-title">Women</div>
                        ${womenHtml}
                    </div>
                </div>
                ${loadMoreHtml}
                <div style="margin-top: var(--space-12); padding-top: var(--space-8); border-top: 1px solid var(--border-primary);">
                    <div class="home-section-header" style="margin-bottom: var(--space-4);">
                        <span class="home-section-title">Other Rankings</span>
                    </div>
                    <div style="display: flex; gap: var(--space-3); flex-wrap: wrap;">
                        <a href="https://proseries.ironman.com/standings/2025" target="_blank" rel="noopener" class="quick-btn">Ironman Pro Series </a>
                        <a href="https://stats.protriathletes.org/rankings" target="_blank" rel="noopener" class="quick-btn">PTO Rankings </a>
                    </div>
                </div>
            </section>`;
    }

    // --- Show athlete from rankings data ---
    window.showAthleteFromRankings = function(gender, index, rank) {
        if (!currentRankingsData) return;
        const athlete = currentRankingsData[gender][index];
        if (athlete) {
            showAthleteDetail(athlete, rank);
        }
    }

    // Navigate to athlete page from photo grid
    window.navigateToAthlete = async function(athleteId) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <span>Loading athlete...</span>
            </div>`;

        const athlete = await getAthleteDetails(athleteId);
        if (athlete) {
            showAthleteDetail(athlete);
        } else {
            resultsDiv.innerHTML = '<div class="error-message">Could not load athlete profile.</div>';
        }
    }

    // --- Lightbox gallery functions ---
    let currentLightboxIndex = 0;

    window.openLightbox = function(index) {
        if (!window.currentGalleryImages || window.currentGalleryImages.length === 0) return;

        currentLightboxIndex = index;
        const images = window.currentGalleryImages;
        const image = images[index];

        const overlay = document.createElement('div');
        overlay.className = 'lightbox-overlay';
        overlay.id = 'lightbox-overlay';
        overlay.innerHTML = `
            <button class="lightbox-close" onclick="closeLightbox()" aria-label="Close">&times;</button>
            <button class="lightbox-nav lightbox-prev" onclick="navigateLightbox(-1)" aria-label="Previous" ${index === 0 ? 'disabled' : ''}></button>
            <div class="lightbox-content">
                <img class="lightbox-image" src="${image.full}" alt="" id="lightbox-image">
            </div>
            <button class="lightbox-nav lightbox-next" onclick="navigateLightbox(1)" aria-label="Next" ${index === images.length - 1 ? 'disabled' : ''}></button>
            <div class="lightbox-counter"><span id="lightbox-current">${index + 1}</span> / ${images.length}</div>
        `;

        document.body.appendChild(overlay);
        document.body.style.overflow = 'hidden';

        // Close on overlay click (not on image or buttons)
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeLightbox();
        });

        // Keyboard navigation
        document.addEventListener('keydown', handleLightboxKeydown);
    }

    window.closeLightbox = function() {
        const overlay = document.getElementById('lightbox-overlay');
        if (overlay) {
            overlay.remove();
            document.body.style.overflow = '';
            document.removeEventListener('keydown', handleLightboxKeydown);
        }
    }

    window.navigateLightbox = function(direction) {
        const images = window.currentGalleryImages;
        if (!images) return;

        const newIndex = currentLightboxIndex + direction;
        if (newIndex < 0 || newIndex >= images.length) return;

        currentLightboxIndex = newIndex;
        const image = images[newIndex];

        // Update image
        const imgEl = document.getElementById('lightbox-image');
        if (imgEl) imgEl.src = image.full;

        // Update counter
        const counterEl = document.getElementById('lightbox-current');
        if (counterEl) counterEl.textContent = newIndex + 1;

        // Update button states
        const prevBtn = document.querySelector('.lightbox-prev');
        const nextBtn = document.querySelector('.lightbox-next');
        if (prevBtn) prevBtn.disabled = newIndex === 0;
        if (nextBtn) nextBtn.disabled = newIndex === images.length - 1;
    }

    function handleLightboxKeydown(e) {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') navigateLightbox(-1);
        if (e.key === 'ArrowRight') navigateLightbox(1);
    }

    // Open lightbox for photo grid with athlete navigation option
    window.openPhotoGridLightbox = function(index) {
        if (!window.currentPhotoGridImages || window.currentPhotoGridImages.length === 0) return;

        currentLightboxIndex = index;
        const photos = window.currentPhotoGridImages;
        const photo = photos[index];

        const overlay = document.createElement('div');
        overlay.className = 'lightbox-overlay';
        overlay.id = 'lightbox-overlay';
        overlay.innerHTML = `
            <button class="lightbox-close" onclick="closeLightbox()" aria-label="Close">&times;</button>
            <button class="lightbox-nav lightbox-prev" onclick="navigatePhotoGridLightbox(-1)" aria-label="Previous" ${index === 0 ? 'disabled' : ''}></button>
            <div class="lightbox-content">
                <img class="lightbox-image" src="${photo.full}" alt="Race photo - ${photo.athleteName}" id="lightbox-image">
                <div class="lightbox-actions" style="position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); display: flex; gap: var(--space-3); z-index: 2002;">
                    <button class="athlete-link" onclick="closeLightbox(); navigateToAthlete(${photo.athleteId});" style="background: var(--accent); color: var(--bg-primary); padding: var(--space-2) var(--space-4); border-radius: var(--radius-md); border: none; cursor: pointer; font-weight: 500; font-size: var(--text-sm);">
                        View ${photo.athleteName}'s Profile 
                    </button>
                </div>
            </div>
            <button class="lightbox-nav lightbox-next" onclick="navigatePhotoGridLightbox(1)" aria-label="Next" ${index === photos.length - 1 ? 'disabled' : ''}></button>
            <div class="lightbox-counter"><span id="lightbox-current">${index + 1}</span> / ${photos.length}</div>
        `;

        document.body.appendChild(overlay);
        document.body.style.overflow = 'hidden';

        // Close on overlay click (not on image or buttons)
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeLightbox();
        });

        // Keyboard navigation
        document.addEventListener('keydown', handlePhotoGridLightboxKeydown);
    }

    window.navigatePhotoGridLightbox = function(direction) {
        const photos = window.currentPhotoGridImages;
        if (!photos) return;

        const newIndex = currentLightboxIndex + direction;
        if (newIndex < 0 || newIndex >= photos.length) return;

        currentLightboxIndex = newIndex;
        const photo = photos[newIndex];

        // Update image
        const imgEl = document.getElementById('lightbox-image');
        if (imgEl) {
            imgEl.src = photo.full;
            imgEl.alt = `Race photo - ${photo.athleteName}`;
        }

        // Update counter
        const counterEl = document.getElementById('lightbox-current');
        if (counterEl) counterEl.textContent = newIndex + 1;

        // Update button states
        const prevBtn = document.querySelector('.lightbox-prev');
        const nextBtn = document.querySelector('.lightbox-next');
        if (prevBtn) prevBtn.disabled = newIndex === 0;
        if (nextBtn) nextBtn.disabled = newIndex === photos.length - 1;

        // Update action button
        const actionBtn = document.querySelector('.lightbox-actions button');
        if (actionBtn) {
            actionBtn.onclick = () => {
                closeLightbox();
                navigateToAthlete(photo.athleteId);
            };
            actionBtn.textContent = `View ${photo.athleteName}'s Profile `;
        }
    }

    function handlePhotoGridLightboxKeydown(e) {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') navigatePhotoGridLightbox(-1);
        if (e.key === 'ArrowRight') navigatePhotoGridLightbox(1);
    }

    // --- Main search function ---
    window.searchAthlete = async function() {
      const name = document.getElementById('athleteName').value;
      if (!name.trim()) return;

      // Clear rankings context when doing a search
      currentRankingsData = null;

      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Searching athletes...</div>';

      const searchResponse = await fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(name)}`);

      if (!searchResponse.ok) {
        resultsDiv.innerHTML = `<div class="error-message">Error fetching athlete data. Please try again later.</div>`;
        return;
      }

      const searchData = await searchResponse.json();
      const athleteIds = (searchData.data || []).map(item => item.athlete_id);

      if (athleteIds.length === 0) {
        resultsDiv.innerHTML = '<div class="empty-state">No athletes found matching your search.</div>';
        return;
      }

      const athleteDetails = await Promise.all(
        athleteIds.map(id => getAthleteDetails(id))
      );

      // Use detailed view for single result, grid for multiple
      const validAthletes = athleteDetails.filter(a => a);
      if (validAthletes.length === 1) {
        showAthleteDetail(validAthletes[0]);
      } else {
        displayAthletes(validAthletes, `Search Results for "${name}"`);
      }
    }

    // --- Fetches top ranked athletes for both genders ---
    window.fetchTopRankings = async function() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Fetching top rankings...</div>';

      try {
        const [menResponse, womenResponse] = await Promise.all([
          cachedFetch(`${API_BASE}?endpoint=/rankings/${RANKING_IDS.male}`),
          cachedFetch(`${API_BASE}?endpoint=/rankings/${RANKING_IDS.female}`)
        ]);

        if (!menResponse.ok || !womenResponse.ok) {
            throw new Error('Unable to load rankings. Please try again later.');
        }

        const menData = await menResponse.json();
        const womenData = await womenResponse.json();

        // Store all ranking IDs for progressive loading
        rankingIds.men = (menData.data?.rankings?.slice(0, RANKINGS_MAX) || []).map(a => a.athlete_id);
        rankingIds.women = (womenData.data?.rankings?.slice(0, RANKINGS_MAX) || []).map(a => a.athlete_id);
        rankingsLoaded = 0;

        // Initialize rankings data
        currentRankingsData = {
            men: [],
            women: [],
            title: "WTCS Rankings"
        };

        // Load first batch
        await loadMoreRankings();

        // Clear any input focus after loading
        setTimeout(() => {
          const active = document.activeElement;
          if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) {
            active.blur();
          }
          document.body.focus();
        }, 100);

      } catch (error) {
          resultsDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
      }
    }

    // --- Load more rankings progressively ---
    window.loadMoreRankings = async function() {
      const resultsDiv = document.getElementById('results');
      const start = rankingsLoaded;
      const end = Math.min(rankingsLoaded + RANKINGS_PER_PAGE, RANKINGS_MAX);

      // Show loading indicator on button if it exists
      const loadMoreBtn = document.getElementById('load-more-btn');
      if (loadMoreBtn) {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'Loading...';
      }

      try {
        const menIdsToLoad = rankingIds.men.slice(start, end);
        const womenIdsToLoad = rankingIds.women.slice(start, end);

        const [menDetails, womenDetails] = await Promise.all([
            Promise.all(menIdsToLoad.map(id => getAthleteDetails(id))),
            Promise.all(womenIdsToLoad.map(id => getAthleteDetails(id)))
        ]);

        // Append to existing data
        currentRankingsData.men.push(...menDetails);
        currentRankingsData.women.push(...womenDetails);
        rankingsLoaded = end;

        // Update display
        displayRankings();

      } catch (error) {
        if (loadMoreBtn) {
          loadMoreBtn.disabled = false;
          loadMoreBtn.textContent = 'Load More';
        }
      }
    }

    // --- Random Athlete ---
    window.showRandomAthlete = async function() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Finding a random athlete...</div>';

      try {
        // Fetch rankings to get pool of athletes (cached)
        const [menResponse, womenResponse] = await Promise.all([
          cachedFetch(`${API_BASE}?endpoint=/rankings/${RANKING_IDS.male}`),
          cachedFetch(`${API_BASE}?endpoint=/rankings/${RANKING_IDS.female}`)
        ]);

        if (!menResponse.ok || !womenResponse.ok) {
          throw new Error('Unable to load rankings');
        }

        const menData = await menResponse.json();
        const womenData = await womenResponse.json();

        const menRankings = menData.data?.rankings || [];
        const womenRankings = womenData.data?.rankings || [];
        const allAthletes = [...menRankings, ...womenRankings];

        if (allAthletes.length === 0) {
          throw new Error('No athletes available');
        }

        // Pick a random athlete
        const randomIndex = Math.floor(Math.random() * allAthletes.length);
        const randomAthlete = allAthletes[randomIndex];

        // Get full details and show
        const athleteDetails = await getAthleteDetails(randomAthlete.athlete_id);
        if (athleteDetails) {
          showAthleteDetail(athleteDetails);
        } else {
          throw new Error('Could not load athlete details');
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error-message">${error.message || 'Failed to find random athlete'}</div>`;
      }
    };

    // --- Fetch News Articles ---
    async function fetchNewsArticles(limit = 10) {
        try {
            // Try different possible endpoints for news in parallel
            const endpoints = ['/news', '/articles', '/content/news'];
            
            // Try all endpoints in parallel for faster response
            const results = await Promise.allSettled(
                endpoints.map(endpoint => 
                    cachedFetch(`${API_BASE}?endpoint=${endpoint}&per_page=${limit}`)
                )
            );
            
            // Find first successful response with valid articles
            for (const result of results) {
                if (result.status === 'fulfilled') {
                    const response = result.value;
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Check if data structure matches expected format
                        let articles = null;
                        if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                            articles = data.data;
                        } else if (Array.isArray(data) && data.length > 0) {
                            articles = data;
                        } else if (data.articles && Array.isArray(data.articles)) {
                            articles = data.articles;
                        }
                        
                        if (articles && articles.length > 0) {
                            return articles.slice(0, limit);
                        }
                    }
                }
            }
            return null;
        } catch (error) {
            console.error('Failed to fetch news:', error);
            return null;
        }
    }

    // --- Home Page Function ---
    window.showHomePage = async function() {
        // Clear rankings context when going home
        currentRankingsData = null;

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading featured content...</div>';

        try {
            // Fetch athlete data for photos and news in parallel (cached)
            const [menResponse, womenResponse, newsArticles] = await Promise.all([
              cachedFetch(`${API_BASE}?endpoint=/rankings/${RANKING_IDS.male}`),
              cachedFetch(`${API_BASE}?endpoint=/rankings/${RANKING_IDS.female}`),
              fetchNewsArticles(10)
            ]);

            if (!menResponse.ok || !womenResponse.ok) {
                throw new Error('Unable to load athlete data. Please try again later.');
            }

            const menData = await menResponse.json();
            const womenData = await womenResponse.json();

            const menRankings = menData.data?.rankings || [];
            const womenRankings = womenData.data?.rankings || [];

            // Get a random selection of ranked athletes to pull action photos from
            const allRanked = [...menRankings, ...womenRankings];
            const shuffledAthletes = allRanked.sort(() => 0.5 - Math.random()).slice(0, 12);

            const athleteDetails = await Promise.all(
                shuffledAthletes.map(a => getAthleteDetails(a.athlete_id))
            );

            // Collect action photos from athletes' latest_images
            const actionPhotos = [];
            athleteDetails.forEach(athlete => {
                if (athlete && athlete.latest_images && athlete.latest_images.length > 0) {
                    // Take 1-2 images per athlete for variety
                    const images = athlete.latest_images.slice(0, 2);
                    images.forEach(img => {
                        if (img.image_url || img.thumbnail) {
                            actionPhotos.push({
                                url: img.image_url || img.thumbnail,
                                thumbnail: img.thumbnail || img.image_url,
                                athleteName: athlete.athlete_full_name,
                                athleteCountry: athlete.athlete_country_name || '',
                                athleteId: athlete.athlete_id
                            });
                        }
                    });
                }
            });

            // Shuffle action photos for a fresh look each time
            const shuffledPhotos = actionPhotos.sort(() => 0.5 - Math.random()).slice(0, 12);

            // Store photos for lightbox with athlete info
            window.currentPhotoGridImages = shuffledPhotos.map(photo => ({
                thumbnail: photo.thumbnail,
                full: photo.url,
                athleteId: photo.athleteId,
                athleteName: photo.athleteName,
                athleteCountry: photo.athleteCountry
            }));

            // Build photo grid HTML with action shots - open lightbox first
            const photoGridHtml = shuffledPhotos.length > 0
                ? shuffledPhotos.map((photo, index) => `
                    <div class="photo-card" onclick="openPhotoGridLightbox(${index})" style="cursor: pointer;">
                        <img src="${photo.thumbnail}" alt="Race photo - ${photo.athleteName}" loading="lazy" onerror="this.parentElement.style.display='none'">
                        <div class="photo-card-overlay">
                            <div class="photo-card-name">${photo.athleteName}</div>
                            <div class="photo-card-country">${photo.athleteCountry}</div>
                        </div>
                    </div>
                `).join('')
                : '<p style="color: var(--text-secondary); padding: var(--space-4);">No recent race images available</p>';

            // Fetch YouTube videos for Watch section
            let watchSectionHtml = '';
            try {
                const youtubeResponse = await fetch('/api/youtube?action=channelVideos&maxResults=6');
                if (youtubeResponse.ok) {
                    const youtubeData = await youtubeResponse.json();
                    const videos = youtubeData.items || [];
                    
                    if (videos.length > 0) {
                        // Group videos by channel and take first 2 per channel, limit to 6 total
                        const videosByChannel = {};
                        videos.forEach(video => {
                            const channelName = video.channelName || 'Triathlon';
                            if (!videosByChannel[channelName]) {
                                videosByChannel[channelName] = [];
                            }
                            if (videosByChannel[channelName].length < 2) {
                                videosByChannel[channelName].push(video);
                            }
                        });

                        const videoItems = Object.values(videosByChannel).flat().slice(0, 6);
                        
                        watchSectionHtml = `
                            <div class="video-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                                ${videoItems.map(video => {
                                    const videoId = video.id?.videoId || video.snippet?.resourceId?.videoId || '';
                                    const title = video.snippet?.title || 'Video';
                                    const channelTitle = video.snippet?.channelTitle || video.channelName || '';
                                    
                                    if (!videoId) return '';
                                    
                                    return `
                                        <div class="video-item" style="background: var(--bg-secondary); border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border-primary); transition: all var(--transition-fast);">
                                            <div style="position: relative; padding-bottom: 56.25%; background: var(--bg-tertiary);">
                                                <iframe 
                                                    width="100%" 
                                                    height="100%" 
                                                    src="https://www.youtube.com/embed/${videoId}" 
                                                    title="${title}"
                                                    frameborder="0" 
                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                    allowfullscreen
                                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                                    loading="lazy">
                                                </iframe>
                                            </div>
                                            <div style="padding: var(--space-3);">
                                                <div style="font-size: var(--text-sm); font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-1); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${title}</div>
                                                <div style="font-size: var(--text-xs); color: var(--text-tertiary);">${channelTitle}</div>
                                            </div>
                                        </div>
                                    `;
                                }).filter(v => v).join('')}
                            </div>
                            <div class="channel-grid">
                                <a class="channel-card" href="https://www.youtube.com/@worldtriathlon" target="_blank" rel="noopener">
                                    <div class="channel-logo"><div class="channel-logo-text wt">WT</div></div>
                                    <div class="channel-info">
                                        <div class="channel-name">World Triathlon</div>
                                        <div class="channel-desc">Official Olympic triathlon coverage</div>
                                    </div>
                                </a>
                                <a class="channel-card" href="https://www.youtube.com/@T100Triathlon" target="_blank" rel="noopener">
                                    <div class="channel-logo"><div class="channel-logo-text pto">T100</div></div>
                                    <div class="channel-info">
                                        <div class="channel-name">T100 / PTO</div>
                                        <div class="channel-desc">Professional Triathletes Organisation</div>
                                    </div>
                                </a>
                                <a class="channel-card" href="https://www.youtube.com/@ironmantriathlon" target="_blank" rel="noopener">
                                    <div class="channel-logo"><div class="channel-logo-text im">M</div></div>
                                    <div class="channel-info">
                                        <div class="channel-name">Ironman</div>
                                        <div class="channel-desc">Long-distance triathlon racing</div>
                                    </div>
                                </a>
                                <a class="channel-card" href="https://www.youtube.com/@supertri" target="_blank" rel="noopener">
                                    <div class="channel-logo"><div class="channel-logo-text slt">SLT</div></div>
                                    <div class="channel-info">
                                        <div class="channel-name">Super League Triathlon</div>
                                        <div class="channel-desc">Fast-paced short course racing</div>
                                    </div>
                                </a>
                            </div>
                        `;
                    } else {
                        // Fallback to channel cards only
                        watchSectionHtml = `
                            <div class="channel-grid">
                                <a class="channel-card" href="https://www.youtube.com/@worldtriathlon" target="_blank" rel="noopener">
                                    <div class="channel-logo"><div class="channel-logo-text wt">WT</div></div>
                                    <div class="channel-info">
                                        <div class="channel-name">World Triathlon</div>
                                        <div class="channel-desc">Official Olympic triathlon coverage</div>
                                    </div>
                                </a>
                                <a class="channel-card" href="https://www.youtube.com/@T100Triathlon" target="_blank" rel="noopener">
                                    <div class="channel-logo"><div class="channel-logo-text pto">T100</div></div>
                                    <div class="channel-info">
                                        <div class="channel-name">T100 / PTO</div>
                                        <div class="channel-desc">Professional Triathletes Organisation</div>
                                    </div>
                                </a>
                                <a class="channel-card" href="https://www.youtube.com/@ironmantriathlon" target="_blank" rel="noopener">
                                    <div class="channel-logo"><div class="channel-logo-text im">M</div></div>
                                    <div class="channel-info">
                                        <div class="channel-name">Ironman</div>
                                        <div class="channel-desc">Long-distance triathlon racing</div>
                                    </div>
                                </a>
                                <a class="channel-card" href="https://www.youtube.com/@supertri" target="_blank" rel="noopener">
                                    <div class="channel-logo"><div class="channel-logo-text slt">SLT</div></div>
                                    <div class="channel-info">
                                        <div class="channel-name">Super League Triathlon</div>
                                        <div class="channel-desc">Fast-paced short course racing</div>
                                    </div>
                                </a>
                            </div>
                        `;
                    }
                } else {
                    // Fallback if API fails
                    watchSectionHtml = `
                        <div class="channel-grid">
                            <a class="channel-card" href="https://www.youtube.com/@worldtriathlon" target="_blank" rel="noopener">
                                <div class="channel-logo"><div class="channel-logo-text wt">WT</div></div>
                                <div class="channel-info">
                                    <div class="channel-name">World Triathlon</div>
                                    <div class="channel-desc">Official Olympic triathlon coverage</div>
                                </div>
                            </a>
                            <a class="channel-card" href="https://www.youtube.com/@T100Triathlon" target="_blank" rel="noopener">
                                <div class="channel-logo"><div class="channel-logo-text pto">T100</div></div>
                                <div class="channel-info">
                                    <div class="channel-name">T100 / PTO</div>
                                    <div class="channel-desc">Professional Triathletes Organisation</div>
                                </div>
                            </a>
                            <a class="channel-card" href="https://www.youtube.com/@ironmantriathlon" target="_blank" rel="noopener">
                                <div class="channel-logo"><div class="channel-logo-text im">M</div></div>
                                <div class="channel-info">
                                    <div class="channel-name">Ironman</div>
                                    <div class="channel-desc">Long-distance triathlon racing</div>
                                </div>
                            </a>
                            <a class="channel-card" href="https://www.youtube.com/@supertri" target="_blank" rel="noopener">
                                <div class="channel-logo"><div class="channel-logo-text slt">SLT</div></div>
                                <div class="channel-info">
                                    <div class="channel-name">Super League Triathlon</div>
                                    <div class="channel-desc">Fast-paced short course racing</div>
                                </div>
                            </a>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to fetch YouTube videos:', error);
                // Fallback to channel cards
                watchSectionHtml = `
                    <div class="channel-grid">
                        <a class="channel-card" href="https://www.youtube.com/@worldtriathlon" target="_blank" rel="noopener">
                            <div class="channel-logo"><div class="channel-logo-text wt">WT</div></div>
                            <div class="channel-info">
                                <div class="channel-name">World Triathlon</div>
                                <div class="channel-desc">Official Olympic triathlon coverage</div>
                            </div>
                        </a>
                        <a class="channel-card" href="https://www.youtube.com/@T100Triathlon" target="_blank" rel="noopener">
                            <div class="channel-logo"><div class="channel-logo-text pto">T100</div></div>
                            <div class="channel-info">
                                <div class="channel-name">T100 / PTO</div>
                                <div class="channel-desc">Professional Triathletes Organisation</div>
                            </div>
                        </a>
                        <a class="channel-card" href="https://www.youtube.com/@ironmantriathlon" target="_blank" rel="noopener">
                            <div class="channel-logo"><div class="channel-logo-text im">M</div></div>
                            <div class="channel-info">
                                <div class="channel-name">Ironman</div>
                                <div class="channel-desc">Long-distance triathlon racing</div>
                            </div>
                        </a>
                        <a class="channel-card" href="https://www.youtube.com/@supertri" target="_blank" rel="noopener">
                            <div class="channel-logo"><div class="channel-logo-text slt">SLT</div></div>
                            <div class="channel-info">
                                <div class="channel-name">Super League Triathlon</div>
                                <div class="channel-desc">Fast-paced short course racing</div>
                            </div>
                        </a>
                    </div>
                `;
            }

            // Build news section HTML
            const newsSectionHtml = newsArticles && newsArticles.length > 0 ? `
                <div class="news-list">
                    ${newsArticles.map((article, index) => {
                        // Use World Triathlon API field names
                        const title = article.news_title || 
                                     article.title || 
                                     article.headline || 
                                     article.name || 
                                     'Untitled';
                        
                        const excerpt = article.news_excerpt || 
                                       article.excerpt || 
                                       article.summary || 
                                       article.description || 
                                       '';
                        
                        const date = article.news_entry_date || 
                                    article.published_date || 
                                    article.date || 
                                    article.created_at ||
                                    '';
                        
                        const link = article.news_url || 
                                    article.url || 
                                    article.link || 
                                    article.permalink || 
                                    `https://www.triathlon.org/news/${article.news_slug || article.news_id || ''}`;
                        
                        // World Triathlon API uses these image fields (in priority order)
                        const imageUrl = article.news_multipurpose_image || 
                                        article.news_tab_image || 
                                        article.news_thumbnail ||
                                        article.image || 
                                        article.image_url || 
                                        article.thumbnail || 
                                        '';
                        
                        // Format date safely
                        let formattedDate = '';
                        if (date) {
                            try {
                                const dateObj = new Date(date);
                                if (!isNaN(dateObj.getTime())) {
                                    formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                }
                            } catch (e) {
                                // Invalid date, leave empty
                            }
                        }
                        
                        // Build image HTML
                        const imageHtml = imageUrl && imageUrl.startsWith('http') ? 
                            `<img src="${imageUrl}" alt="${title}" class="news-item-image" loading="lazy" onerror="this.style.display='none'">` : 
                            '';
                        
                        return `
                            <a href="${link}" target="_blank" rel="noopener" class="news-item">
                                ${imageHtml}
                                <div class="news-item-content">
                                    <div class="news-item-header">
                                        <div class="news-item-title">${title}</div>
                                        ${formattedDate ? `<div class="news-item-date">${formattedDate}</div>` : ''}
                                    </div>
                                    ${excerpt ? `<div class="news-item-excerpt">${excerpt}</div>` : ''}
                                    <div class="news-item-link">Read more </div>
                                </div>
                            </a>
                        `;
                    }).join('')}
                </div>
            ` : `
                <p style="color: var(--text-secondary); font-size: var(--text-sm);">Visit World Triathlon for the latest race results, athlete stories, and event coverage.</p>
            `;

            resultsDiv.innerHTML = `
                <div class="home-toc">
                    <nav class="home-toc-nav">
                        <a href="#home-news" class="home-toc-link" onclick="scrollToSection('home-news'); return false;">News</a>
                        <a href="#home-watch" class="home-toc-link" onclick="scrollToSection('home-watch'); return false;">Watch</a>
                        <a href="#home-photos" class="home-toc-link" onclick="scrollToSection('home-photos'); return false;">Photos</a>
                    </nav>
                </div>
                <section id="home-news" class="home-section">
                    <div class="home-section-header">
                        <span class="home-section-title">Latest News</span>
                        <a href="https://triathlon.org/news" target="_blank" rel="noopener" class="home-section-link">triathlon.org/news </a>
                    </div>
                    ${newsSectionHtml}
                </section>
                <section id="home-watch" class="home-section">
                    <div class="home-section-header">
                        <span class="home-section-title">Watch</span>
                    </div>
                    ${watchSectionHtml}
                </section>
                <section id="home-photos" class="home-section">
                    <div class="home-section-header">
                        <span class="home-section-title">Race Photos</span>
                        <a href="#" class="home-section-link" onclick="showHomePage(); return false;">Refresh </a>
                    </div>
                    <div class="photo-grid">${photoGridHtml}</div>
                </section>
            `;

            // Setup scroll spy for active navigation
            setupHomeScrollSpy();

            // Clear any input focus after loading
            setTimeout(() => {
              const active = document.activeElement;
              if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) {
                active.blur();
              }
              document.body.focus();
            }, 100);
        } catch (error) {
            resultsDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
        }
    }

    // Scroll to section function
    window.scrollToSection = function(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            const tocHeight = document.querySelector('.home-toc')?.offsetHeight || 0;
            const navHeight = 56; // Navigation bar height
            const offset = tocHeight + navHeight + 20; // Extra spacing
            
            const sectionTop = section.getBoundingClientRect().top + window.pageYOffset - offset;
            window.scrollTo({
                top: sectionTop,
                behavior: 'smooth'
            });
            
            // Update active link
            document.querySelectorAll('.home-toc-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${sectionId}`) {
                    link.classList.add('active');
                }
            });
        }
    };

    // Setup scroll spy to highlight active section
    function setupHomeScrollSpy() {
        const sections = ['home-news', 'home-watch', 'home-photos'];
        const tocLinks = document.querySelectorAll('.home-toc-link');
        
        if (tocLinks.length === 0) return;
        
        const updateActiveLink = () => {
            const tocHeight = document.querySelector('.home-toc')?.offsetHeight || 0;
            const navHeight = 56;
            const scrollOffset = window.pageYOffset + navHeight + tocHeight + 100;
            
            let activeSection = sections[0];
            
            for (let i = sections.length - 1; i >= 0; i--) {
                const section = document.getElementById(sections[i]);
                if (section) {
                    const sectionTop = section.getBoundingClientRect().top + window.pageYOffset;
                    if (sectionTop <= scrollOffset) {
                        activeSection = sections[i];
                        break;
                    }
                }
            }
            
            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${activeSection}`) {
                    link.classList.add('active');
                }
            });
        };
        
        // Update on scroll
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateActiveLink, 10);
        }, { passive: true });
        
        // Initial update
        updateActiveLink();
    }

    // Helper to search and display a single athlete by name
    async function searchAndDisplayAthlete(name) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading athlete...</div>';
        try {
            const response = await fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(name)}&per_page=1`);
            if (!response.ok) throw new Error('Search failed');
            const data = await response.json();
            if (data.data && data.data.length > 0) {
                const details = await getAthleteDetails(data.data[0].athlete_id);
                if (details) {
                    displayAthletes([details], details.athlete_full_name);
                    return;
                }
            }
            resultsDiv.innerHTML = '<div class="error-message">Athlete not found</div>';
        } catch (error) {
            resultsDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
        }
    }

    // --- Toggle favorite ---
    window.toggleFavorite = function(athleteId, btnElement) {
        const isNowFavorite = favoritesManager.toggle(athleteId);
        btnElement.classList.toggle('is-favorite', isNowFavorite);
        showToast(isNowFavorite ? 'Added to favorites' : 'Removed from favorites');
    };

    // --- Show favorites (consistent with rankings view) ---
    window.showFavorites = async function() {
        const favoriteIds = favoritesManager.getFavorites();
        const resultsDiv = document.getElementById('results');

        // Clear URL
        history.pushState({}, '', '?view=favorites');

        if (favoriteIds.length === 0) {
            // Check for pending AI response to prepend
            const aiResponseHtml = window.pendingAIResponse || '';
            window.pendingAIResponse = null; // Clear after using

            resultsDiv.innerHTML = `
                <section class="results-section">
                    ${aiResponseHtml}
                    <div class="section-header">
                        <h2 class="section-title">Favorites</h2>
                    </div>
                    <div class="empty-state">No favorites yet. Click the star on any athlete to save them.</div>
                </section>`;
            return;
        }

        resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading favorites...</div>';

        const athletes = await Promise.all(favoriteIds.map(id => getAthleteDetails(id)));
        const validAthletes = athletes.filter(a => a);

        if (validAthletes.length === 0) {
            resultsDiv.innerHTML = '<div class="empty-state">No favorites found.</div>';
            return;
        }

        // Store for navigation
        window.favoritesData = validAthletes;

        // Create compact list view like rankings
        const createFavoriteItem = (athlete, index) => {
            const hasValidImage = athlete.athlete_profile_image && athlete.athlete_profile_image.startsWith('http');
            const photoHtml = hasValidImage ?
                `<img class="ranking-item-photo" src="${athlete.athlete_profile_image}" alt="" onerror="this.onerror=null; this.outerHTML='<div class=\\'ranking-item-placeholder\\'>${getInitials(athlete.athlete_full_name)}</div>'">` :
                `<div class="ranking-item-placeholder">${getInitials(athlete.athlete_full_name)}</div>`;

            return `
                <div class="ranking-item" onclick="showAthleteFromFavorites(${index})">
                    <span class="ranking-item-rank" style="color: #f59e0b;"></span>
                    ${photoHtml}
                    <div class="ranking-item-info">
                        <span class="ranking-item-name">${athlete.athlete_full_name}</span>
                        <div class="ranking-item-country">
                            <img class="ranking-item-flag" src="${athlete.athlete_flag || ''}" alt="" onerror="this.style.display='none'">
                            <span>${athlete.athlete_country_name || ''}</span>
                        </div>
                    </div>
                    <span class="ranking-item-arrow"></span>
                </div>`;
        };

        const favoritesHtml = validAthletes.map((a, i) => createFavoriteItem(a, i)).join('');

        // Check for pending AI response to prepend
        const aiResponseHtml = window.pendingAIResponse || '';
        window.pendingAIResponse = null; // Clear after using

        resultsDiv.innerHTML = `
            <section class="results-section">
                ${aiResponseHtml}
                <div class="section-header">
                    <h2 class="section-title">Favorites</h2>
                    <span class="section-meta">${validAthletes.length} athlete${validAthletes.length !== 1 ? 's' : ''}</span>
                </div>
                <div class="ranking-column" style="max-width: 600px;">
                    ${favoritesHtml}
                </div>
            </section>`;

        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Clear any input focus after scrolling
        setTimeout(() => {
          const active = document.activeElement;
          if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) {
            active.blur();
          }
          document.body.focus();
        }, 100);
    };

    // --- Show athlete from favorites data ---
    window.showAthleteFromFavorites = function(index) {
        if (!window.favoritesData || !window.favoritesData[index]) return;
        showAthleteDetail(window.favoritesData[index]);
    };

    // --- Share athlete ---
    window.shareAthlete = function(athleteId, athleteName) {
        const url = `${window.location.origin}${window.location.pathname}?athlete=${athleteId}`;
        if (navigator.share) {
            navigator.share({ url, title: `${athleteName} - Tri Stats` });
        } else {
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard');
            });
        }
    };

    // --- Copy athlete link ---
    window.copyAthleteLink = function(athleteId) {
        const url = `${window.location.origin}${window.location.pathname}?athlete=${athleteId}`;
        navigator.clipboard.writeText(url).then(() => {
            showToast('Link copied to clipboard');
        }).catch(() => {
            showToast('Failed to copy link');
        });
    };

    // --- Analyze trend ---
    function analyzeTrend(results) {
        if (!results || results.length < 4) return null;

        const sorted = [...results]
            .filter(r => r.event_date && r.position)
            .sort((a, b) => new Date(a.event_date) - new Date(b.event_date))
            .map(r => parseInt(r.position));

        if (sorted.length < 4) return null;

        // Split into halves
        const mid = Math.floor(sorted.length / 2);
        const firstHalf = sorted.slice(0, mid);
        const secondHalf = sorted.slice(mid);

        const avgFirst = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
        const avgSecond = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;

        // Calculate linear regression slope
        const n = sorted.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        sorted.forEach((pos, i) => {
            sumX += i;
            sumY += pos;
            sumXY += i * pos;
            sumX2 += i * i;
        });
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);

        return {
            avgFirst: avgFirst.toFixed(1),
            avgSecond: avgSecond.toFixed(1),
            slope,
            trend: slope < -0.3 ? 'improving' : slope > 0.3 ? 'declining' : 'stable',
            bestFinish: Math.min(...sorted),
            avgFinish: (sorted.reduce((a, b) => a + b, 0) / sorted.length).toFixed(1)
        };
    }

    // --- Render results chart with colors and click interactivity ---
    let currentChart = null;
    let chartResults = [];
    let currentChartType = 'position'; // 'position', 'swim', 'bike', 'run', 'relative'
    let currentChartResults = []; // Store results for chart type switching

    // Switch chart type
    window.switchChartType = function(type) {
        currentChartType = type;
        
        // Update button states
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-chart-type') === type);
        });
        
        // Re-render chart with new type
        if (currentChartResults.length > 0) {
            renderResultsChart(currentChartResults, type);
        }
    };

    async function renderResultsChart(results, chartType = null) {
        const ctx = document.getElementById('results-chart');
        if (!ctx || results.length < 2) return;

        // Use provided chart type or current global type
        const type = chartType || currentChartType;
        currentChartType = type;

        // Load Chart.js if not already loaded
        await loadChartJs();

        // Destroy previous chart if exists
        if (currentChart) {
            currentChart.destroy();
        }

        // Sort by date ascending
        const sortedResults = [...results]
            .filter(r => r.event_date && r.position)
            .sort((a, b) => new Date(a.event_date) - new Date(b.event_date));

        if (sortedResults.length < 2) return;

        // Store for click handler and type switching
        chartResults = sortedResults;
        currentChartResults = sortedResults;

        // Get theme colors
        const styles = getComputedStyle(document.documentElement);
        const textColor = styles.getPropertyValue('--text-primary').trim();
        const textSecondary = styles.getPropertyValue('--text-secondary').trim();
        const borderColor = styles.getPropertyValue('--border-primary').trim();
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

        // Position-based colors
        const getPositionColor = (pos) => {
            if (pos === 1) return '#f59e0b'; // Gold
            if (pos === 2) return '#6b7280'; // Silver
            if (pos === 3) return '#ea580c'; // Bronze
            if (pos <= 5) return '#10b981'; // Green for top 5
            if (pos <= 10) return '#3b82f6'; // Blue for top 10
            return isDark ? '#a3a3a3' : '#525252'; // Default
        };

        const labels = sortedResults.map(r => {
            const date = new Date(r.event_date);
            return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        });

        // Prepare data based on chart type
        let chartData, yAxisConfig, chartTitle, pointColors, datasets;
        const positions = sortedResults.map(r => parseInt(r.position));
        const pointColorsByPosition = positions.map(pos => getPositionColor(pos));

        if (type === 'position') {
            // Position chart (existing)
            chartData = positions;
            chartTitle = 'Finish Position';
            pointColors = pointColorsByPosition;
            yAxisConfig = {
                reverse: true,
                min: 0,
                grace: '5%',
                title: {
                    display: true,
                    text: 'Finish Position',
                    color: textSecondary,
                    font: { size: 12, family: 'Plus Jakarta Sans', weight: 600 },
                    padding: { bottom: 8 }
                },
                ticks: {
                    color: textSecondary,
                    font: { size: 11, family: 'Plus Jakarta Sans', weight: 500 },
                    padding: 12,
                    stepSize: 1,
                    callback: (value) => value >= 1 ? '#' + value : ''
                }
            };
            datasets = [{
                    label: 'Finish Position',
                data: chartData,
                    borderColor: '#10b981',
                    backgroundColor: 'transparent',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 8,
                    pointHoverRadius: 11,
                    pointBackgroundColor: pointColors,
                    pointBorderColor: isDark ? '#171717' : '#ffffff',
                    pointBorderWidth: 2,
                    borderWidth: 2.5
            }];
        } else if (type === 'swim' || type === 'bike' || type === 'run') {
            // Discipline time charts
            const discipline = type;
            const disciplineNames = { swim: 'Swim', bike: 'Bike', run: 'Run' };
            const disciplineColors = { swim: '#3b82f6', bike: '#10b981', run: '#ef4444' };
            
            chartData = sortedResults.map(r => {
                const seconds = r[`${discipline}_seconds`];
                return seconds !== null && seconds !== undefined ? seconds : null;
            });
            
            // Filter out null values for valid data points
            const validData = chartData.filter(v => v !== null);
            if (validData.length === 0) {
                // No split data available - show message
                const legendEl = document.getElementById('chart-legend');
                if (legendEl) {
                    legendEl.innerHTML = '<div style="color: var(--text-tertiary); font-size: var(--text-sm); text-align: center; padding: var(--space-4);">Split data not available for this athlete</div>';
                }
                return;
            }
            
            chartTitle = `${disciplineNames[discipline]} Time`;
            pointColors = chartData.map((val, idx) => val !== null ? getPositionColor(positions[idx]) : 'transparent');
            
            yAxisConfig = {
                reverse: false,
                beginAtZero: false,
                title: {
                    display: true,
                    text: 'Time (minutes)',
                    color: textSecondary,
                    font: { size: 12, family: 'Plus Jakarta Sans', weight: 600 },
                    padding: { bottom: 8 }
                },
                ticks: {
                    color: textSecondary,
                    font: { size: 11, family: 'Plus Jakarta Sans', weight: 500 },
                    padding: 12,
                    callback: (value) => {
                        const mins = Math.floor(value / 60);
                        const secs = Math.floor(value % 60);
                        return `${mins}:${String(secs).padStart(2, '0')}`;
                    }
                }
            };
            
            datasets = [{
                label: chartTitle,
                data: chartData,
                borderColor: disciplineColors[discipline],
                backgroundColor: 'transparent',
                fill: false,
                tension: 0.3,
                pointRadius: 8,
                pointHoverRadius: 11,
                pointBackgroundColor: pointColors,
                pointBorderColor: isDark ? '#171717' : '#ffffff',
                pointBorderWidth: 2,
                borderWidth: 2.5,
                spanGaps: true
            }];
        } else if (type === 'relative') {
            // Relative performance chart (% of winner)
            const swimData = sortedResults.map(r => r.relative_swim || null);
            const bikeData = sortedResults.map(r => r.relative_bike || null);
            const runData = sortedResults.map(r => r.relative_run || null);
            
            // Check if we have any relative data
            const hasData = swimData.some(v => v !== null) || bikeData.some(v => v !== null) || runData.some(v => v !== null);
            if (!hasData) {
                const legendEl = document.getElementById('chart-legend');
                if (legendEl) {
                    legendEl.innerHTML = '<div style="color: var(--text-tertiary); font-size: var(--text-sm); text-align: center; padding: var(--space-4);">Relative performance data not available</div>';
                }
                return;
            }
            
            chartTitle = 'Relative Performance';
            yAxisConfig = {
                reverse: false,
                beginAtZero: false,
                min: 95,
                max: 110,
                        title: {
                            display: true,
                    text: '% of Winner Time',
                            color: textSecondary,
                            font: { size: 12, family: 'Plus Jakarta Sans', weight: 600 },
                            padding: { bottom: 8 }
                        },
                        ticks: {
                            color: textSecondary,
                            font: { size: 11, family: 'Plus Jakarta Sans', weight: 500 },
                            padding: 12,
                    callback: (value) => value.toFixed(0) + '%'
                }
            };
            
            datasets = [];
            if (swimData.some(v => v !== null)) {
                datasets.push({
                    label: 'Swim',
                    data: swimData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 6,
                    pointHoverRadius: 9,
                    pointBackgroundColor: pointColorsByPosition,
                    pointBorderColor: isDark ? '#171717' : '#ffffff',
                    pointBorderWidth: 2,
                    borderWidth: 2,
                    spanGaps: true
                });
            }
            if (bikeData.some(v => v !== null)) {
                datasets.push({
                    label: 'Bike',
                    data: bikeData,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 6,
                    pointHoverRadius: 9,
                    pointBackgroundColor: pointColorsByPosition,
                    pointBorderColor: isDark ? '#171717' : '#ffffff',
                    pointBorderWidth: 2,
                    borderWidth: 2,
                    spanGaps: true
                });
            }
            if (runData.some(v => v !== null)) {
                datasets.push({
                    label: 'Run',
                    data: runData,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 6,
                    pointHoverRadius: 9,
                    pointBackgroundColor: pointColorsByPosition,
                    pointBorderColor: isDark ? '#171717' : '#ffffff',
                    pointBorderWidth: 2,
                    borderWidth: 2,
                    spanGaps: true
                });
            }
            
            // Update legend for relative chart
            const legendEl = document.getElementById('chart-legend');
            if (legendEl) {
                legendEl.innerHTML = datasets.map(d => 
                    `<div class="chart-legend-item"><span class="chart-legend-dot" style="background: ${d.borderColor};"></span> ${d.label}</div>`
                ).join('');
            }
        }

        // Common chart configuration
        currentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 20, bottom: 16, left: 8, right: 24 }
                },
                scales: {
                    y: {
                        ...yAxisConfig,
                        grid: {
                            color: borderColor,
                            lineWidth: 1,
                            drawTicks: false
                        },
                        border: { display: false }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Race Date',
                            color: textSecondary,
                            font: { size: 12, family: 'Plus Jakarta Sans', weight: 600 },
                            padding: { top: 8 }
                        },
                        ticks: {
                            color: textSecondary,
                            font: { size: 11, family: 'Plus Jakarta Sans', weight: 500 },
                            padding: 8,
                            maxRotation: 45,
                            minRotation: 0
                        },
                        grid: { display: false },
                        border: { display: false }
                    }
                },
                plugins: {
                    legend: { 
                        display: type === 'relative',
                        position: 'bottom',
                        labels: {
                            color: textSecondary,
                            font: { size: 11, family: 'Plus Jakarta Sans', weight: 500 },
                            usePointStyle: true,
                            padding: 12
                        }
                    },
                    tooltip: {
                        enabled: false // We'll use custom click tooltip
                    }
                },
                interaction: {
                    intersect: true,
                    mode: 'nearest'
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        showRaceTooltip(event, sortedResults[index], ctx);
                    }
                },
                onHover: (event, elements) => {
                    ctx.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                }
            }
        });
        
        // Restore position legend if not relative chart
        if (type !== 'relative') {
            const legendEl = document.getElementById('chart-legend');
            if (legendEl && !legendEl.querySelector('.chart-legend-item')) {
                legendEl.innerHTML = `
                    <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #f59e0b;"></span> 1st</div>
                    <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #6b7280;"></span> 2nd</div>
                    <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #ea580c;"></span> 3rd</div>
                    <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #10b981;"></span> Top 5</div>
                    <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #3b82f6;"></span> Top 10</div>
                `;
            }
        }
    }

    // Show race details modal with top 10 finishers
    let currentViewingAthleteId = null;

    async function showRaceTooltip(event, result, canvas) {
        // Get current athlete ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        currentViewingAthleteId = urlParams.get('athlete');

        // Check if we have event_id and prog_id to fetch results
        if (!result.event_id || !result.prog_id) {
            // Fallback to simple tooltip if no IDs available
            showSimpleTooltip(event, result, canvas);
            return;
        }

        // Check if this is a team/relay event (show simple tooltip instead)
        const progName = (result.prog_name || result.event_title || '').toLowerCase();
        const isTeamEvent = progName.includes('relay') ||
                           progName.includes('team') ||
                           progName.includes('mixed');

        if (isTeamEvent) {
            console.log('Team event detected, showing simple tooltip:', progName);
            showSimpleTooltip(event, result, canvas);
            return;
        }

        // Show modal with loading state
        showRaceDetailsModal(result);

        // Fetch race results (request more to ensure we get top 10 after filtering)
        try {
            const cacheKey = `${result.event_id}_${result.prog_id}`;
            
            // Check cache first
            if (splitDataCache[cacheKey]) {
                const cached = splitDataCache[cacheKey];
                const sortedResults = cached.allResults
                    .filter(r => r.position && !isNaN(parseInt(r.position)))
                    .sort((a, b) => parseInt(a.position) - parseInt(b.position))
                    .slice(0, 10);
                if (sortedResults.length > 0) {
                    updateRaceDetailsModal(result, sortedResults);
                }
                return;
            }

            const response = await fetch(`/api/triathlon?endpoint=/events/${result.event_id}/programs/${result.prog_id}/results`);
            const data = await response.json();

            // Log API structure for debugging
            logApiStructure(data, `for race ${result.event_id}/${result.prog_id}`);

            // Results are in data.data.results
            if (data.data && data.data.results && Array.isArray(data.data.results)) {
                const allResults = data.data.results;
                
                // Enhance all results with split data
                const enhancedResults = allResults.map(r => enhanceResultWithSplits(r, allResults));
                
                // Cache the enhanced results
                splitDataCache[cacheKey] = {
                    allResults: enhancedResults,
                    timestamp: Date.now()
                };

                // Sort by position and take top 10 (filter out non-numeric positions like DNF, DNS, LAP)
                const sortedResults = enhancedResults
                    .filter(r => r.position && !isNaN(parseInt(r.position)))
                    .sort((a, b) => parseInt(a.position) - parseInt(b.position))
                    .slice(0, 10);

                if (sortedResults.length > 0) {
                    updateRaceDetailsModal(result, sortedResults);
                } else {
                    // No numeric positions - show what we have
                    updateRaceDetailsModal(result, enhancedResults.slice(0, 10));
                }
            } else {
                console.log('No results array in response');
                showRaceDetailsError(result);
            }
        } catch (error) {
            console.error('Failed to fetch race results:', error);
            showRaceDetailsError(result);
        }
    }

    function showRaceDetailsModal(result) {
        // Remove any existing modal
        const existing = document.querySelector('.race-details-overlay');
        if (existing) existing.remove();

        const eventDate = new Date(result.event_date);
        const formattedDate = eventDate.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });

        const overlay = document.createElement('div');
        overlay.className = 'race-details-overlay';
        overlay.id = 'race-details-overlay';
        overlay.innerHTML = `
            <div class="race-details-modal">
                <div class="race-details-header">
                    <div>
                        <div class="race-details-title">${result.event_title || 'Race'}</div>
                        <div class="race-details-meta">
                            <span class="race-details-date">${formattedDate}</span>
                            ${result.prog_name ? `<span class="race-details-date"> ${result.prog_name}</span>` : ''}
                        </div>
                    </div>
                    <button class="race-details-close" onclick="closeRaceDetails()">&times;</button>
                </div>
                <div class="race-details-body">
                    <div class="race-details-loading">
                        <span class="loading-spinner" style="width: 24px; height: 24px;"></span>
                    </div>
                </div>
                ${result.result_listing ? `
                <div class="race-details-footer">
                    <a href="${result.result_listing}" target="_blank" class="race-details-link">
                        View Full Results on triathlon.org 
                    </a>
                </div>` : ''}
            </div>
        `;

        // Close on overlay click
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeRaceDetails();
        });

        document.body.appendChild(overlay);

        // Close on Escape key
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                closeRaceDetails();
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
    }

    function updateRaceDetailsModal(result, raceResults) {
        const body = document.querySelector('.race-details-body');
        if (!body) return;

        if (raceResults.length === 0) {
            body.innerHTML = `<div class="race-details-error">No results available for this race.</div>`;
            return;
        }

        const getPositionClass = (pos) => {
            if (pos === 1) return 'gold';
            if (pos === 2) return 'silver';
            if (pos === 3) return 'bronze';
            return '';
        };

        const resultsHtml = raceResults.map(r => {
            const rawPosition = r.position || r.result_position || '';
            const numericPosition = parseInt(rawPosition);
            const isNumeric = !isNaN(numericPosition);
            const displayPosition = isNumeric ? `#${numericPosition}` : rawPosition;
            const athleteId = r.athlete_id;
            const isCurrentAthlete = currentViewingAthleteId && athleteId == currentViewingAthleteId;
            const athleteName = r.athlete_title || `${r.athlete_first || ''} ${r.athlete_last || ''}`.trim() || 'Unknown';
            const totalTime = r.total_time || '';
            const flag = r.athlete_flag || '';

            return `
                <div class="race-details-item ${isCurrentAthlete ? 'current-athlete' : ''}">
                    <span class="race-details-position ${isNumeric ? getPositionClass(numericPosition) : ''}">${displayPosition}</span>
                    <div class="race-details-athlete">
                        ${flag ? `<img class="race-details-flag" src="${flag}" alt="" onerror="this.style.display='none'">` : ''}
                        <span class="race-details-athlete-name" onclick="viewAthleteFromRace(${athleteId})">${athleteName}</span>
                    </div>
                    ${totalTime ? `<span class="race-details-time">${totalTime}</span>` : ''}
                </div>
            `;
        }).join('');

        const count = raceResults.length;
        body.innerHTML = `
            <div class="race-details-subtitle">Top ${count} Finisher${count !== 1 ? 's' : ''}</div>
            <div class="race-details-list">${resultsHtml}</div>
        `;
    }

    function showRaceDetailsError(result) {
        const body = document.querySelector('.race-details-body');
        if (!body) return;

        const position = parseInt(result.position);
        const positionClass = position === 1 ? 'gold' : position === 2 ? 'silver' : position === 3 ? 'bronze' : '';

        body.innerHTML = `
            <div class="race-details-error">
                <div style="font-size: var(--text-xl); font-weight: 700; margin-bottom: var(--space-2);" class="${positionClass}">
                    #${position}
                </div>
                <p>Could not load detailed race results.</p>
            </div>
        `;
    }

    window.closeRaceDetails = function() {
        const overlay = document.querySelector('.race-details-overlay');
        if (overlay) overlay.remove();
    };

    window.viewAthleteFromRace = function(athleteId) {
        closeRaceDetails();
        // Navigate to athlete page
        window.location.href = `?athlete=${athleteId}`;
    };

    // Fallback simple tooltip for results without event_id/prog_id
    function showSimpleTooltip(event, result, canvas) {
        const existing = document.querySelector('.chart-race-tooltip');
        if (existing) existing.remove();

        const container = canvas.closest('.chart-container');
        if (!container) return;

        const containerRect = container.getBoundingClientRect();

        const position = parseInt(result.position);
        const positionClass = position === 1 ? 'gold' : position === 2 ? 'silver' : position === 3 ? 'bronze' : '';
        const eventDate = new Date(result.event_date);
        const formattedDate = eventDate.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });

        const tooltip = document.createElement('div');
        tooltip.className = 'chart-race-tooltip';
        tooltip.innerHTML = `
            <div class="chart-race-tooltip-title">${result.event_title || 'Race'}</div>
            <div class="chart-race-tooltip-meta">
                <span class="chart-race-tooltip-position ${positionClass}">#${position}</span>
                <span class="chart-race-tooltip-date">${formattedDate}</span>
            </div>
            ${result.result_listing ? `<a href="${result.result_listing}" target="_blank" class="chart-race-tooltip-link">View Full Results </a>` : ''}
        `;

        const x = event.native.clientX - containerRect.left;
        const y = event.native.clientY - containerRect.top;

        const tooltipWidth = 240;
        let left = x + 10;
        if (left + tooltipWidth > containerRect.width) {
            left = x - tooltipWidth - 10;
        }
        if (left < 0) left = 10;

        tooltip.style.left = left + 'px';
        tooltip.style.top = Math.max(10, y - 60) + 'px';

        container.appendChild(tooltip);

        const closeTooltip = (e) => {
            if (!tooltip.contains(e.target) && e.target !== canvas) {
                tooltip.remove();
                document.removeEventListener('click', closeTooltip);
            }
        };
        setTimeout(() => document.addEventListener('click', closeTooltip), 10);
    }

    // --- Toggle between recent and full race history ---
    async function toggleResultsView(athleteId) {
        const btn = document.getElementById('load-more-results-btn');
        if (!btn) return;

        const currentView = btn.getAttribute('data-view');

        if (currentView === 'recent') {
            // Switch to full history
            await loadFullHistory(athleteId, btn);
        } else {
            // Switch back to recent
            if (recentResultsCache[athleteId]) {
                renderResultsChart(recentResultsCache[athleteId]);
                btn.textContent = 'Load Full Race History';
                btn.setAttribute('data-view', 'recent');
            }
        }
    }

    async function loadFullHistory(athleteId, btn) {
        // Check cache first
        if (extendedResultsCache[athleteId]) {
            renderResultsChart(extendedResultsCache[athleteId]);
            btn.textContent = `Show Recent (${recentResultsCache[athleteId]?.length || 0} races)`;
            btn.setAttribute('data-view', 'full');
            return;
        }

        // Show loading state
        btn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 6px;"><span class="loading-spinner" style="width: 14px; height: 14px; border-width: 2px;"></span> Loading...</span>';
        btn.disabled = true;

        try {
            const response = await fetch(`/api/triathlon?endpoint=/athletes/${athleteId}/results`);
            const data = await response.json();

            if (data.data && Array.isArray(data.data)) {
                // Transform API results to match the format we need, preserving split data
                const results = data.data.map(r => {
                    const baseResult = {
                    event_title: r.event_title || r.prog_name || 'Race',
                    event_date: r.event_date || r.prog_date,
                    position: r.position || r.result_position,
                    result_listing: r.result_listing || r.event_listing,
                    event_id: r.event_id,
                    prog_id: r.prog_id,
                        prog_name: r.prog_name,
                        total_time: r.total_time || null
                    };
                    
                    // Extract and preserve split data
                    const splits = extractSplitData(r);
                    return { ...baseResult, ...splits };
                }).filter(r => r.event_date && r.position);

                if (results.length > 0) {
                    extendedResultsCache[athleteId] = results;
                    renderResultsChart(results);
                    btn.textContent = `Show Recent (${recentResultsCache[athleteId]?.length || 0} races)`;
                    btn.setAttribute('data-view', 'full');
                    btn.disabled = false;
                } else {
                    btn.textContent = 'No additional results found';
                    btn.disabled = false;
                }
            } else {
                btn.textContent = 'Could not load more results';
                btn.disabled = false;
            }
        } catch (error) {
            console.error('Failed to load more results:', error);
            btn.textContent = 'Failed to load results';
            btn.disabled = false;
        }
    }

    // --- Comparison functions ---
    window.startComparison = async function(athleteId) {
        const athlete = await getAthleteDetails(athleteId);
        if (!athlete) return;

        comparisonState.athlete1 = athlete;
        comparisonState.mode = 'selecting';

        // Create modal
        const hasImage = athlete.athlete_profile_image?.startsWith('http');
        const overlay = document.createElement('div');
        overlay.className = 'comparison-modal-overlay';
        overlay.id = 'comparison-modal-overlay';
        overlay.innerHTML = `
            <div class="comparison-modal">
                <div class="comparison-modal-header">
                    <span class="comparison-modal-title">Compare Athletes</span>
                    <button class="comparison-modal-close" onclick="cancelComparison()">&times;</button>
                </div>
                <div class="comparison-modal-body">
                    <div class="comparison-modal-athlete">
                        ${hasImage ?
                            `<img class="comparison-modal-athlete-photo" src="${athlete.athlete_profile_image}" alt="">` :
                            `<div class="comparison-modal-athlete-placeholder">${getInitials(athlete.athlete_full_name)}</div>`
                        }
                        <div class="comparison-modal-athlete-info">
                            <div class="comparison-modal-athlete-name">${athlete.athlete_full_name}</div>
                            <div class="comparison-modal-athlete-country">${athlete.athlete_country_name || ''}</div>
                        </div>
                    </div>
                    <div class="comparison-modal-search">
                        <input type="text" id="comparison-search-input" placeholder="Search for second athlete..." autocomplete="off">
                        <div id="comparison-search-results" class="comparison-modal-results" style="display: none;"></div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);

        // Close on overlay click
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) cancelComparison();
        });

        // Setup search
        const searchInput = document.getElementById('comparison-search-input');
        searchInput.focus();
        searchInput.addEventListener('input', debounce(handleComparisonSearch, 300));
    };

    async function handleComparisonSearch() {
        const query = document.getElementById('comparison-search-input').value;
        const resultsDiv = document.getElementById('comparison-search-results');

        if (query.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }

        resultsDiv.innerHTML = '<div class="comparison-modal-loading">Searching...</div>';
        resultsDiv.style.display = 'block';

        const response = await fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(query)}&per_page=6`);
        if (!response.ok) {
            resultsDiv.style.display = 'none';
            return;
        }

        const data = await response.json();
        const athletes = data.data || [];

        if (athletes.length === 0) {
            resultsDiv.innerHTML = '<div class="comparison-modal-loading">No athletes found</div>';
            return;
        }

        // Fetch details for photos
        const details = await Promise.all(athletes.map(a => getAthleteDetails(a.athlete_id)));

        resultsDiv.innerHTML = details.filter(a => a).map(athlete => {
            const hasImage = athlete.athlete_profile_image?.startsWith('http');
            return `
                <div class="comparison-modal-item" onclick="selectComparisonAthlete(${athlete.athlete_id})">
                    ${hasImage ?
                        `<img class="comparison-modal-item-photo" src="${athlete.athlete_profile_image}" alt="">` :
                        `<div class="comparison-modal-item-placeholder">${getInitials(athlete.athlete_full_name)}</div>`
                    }
                    <div class="comparison-modal-item-info">
                        <div class="comparison-modal-item-name">${athlete.athlete_full_name}</div>
                        <div class="comparison-modal-item-country">${athlete.athlete_country_name || ''}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    window.selectComparisonAthlete = async function(athleteId) {
        const athlete = await getAthleteDetails(athleteId);
        if (!athlete) return;

        comparisonState.athlete2 = athlete;
        comparisonState.mode = 'comparing';
        document.getElementById('comparison-modal-overlay')?.remove();
        showComparison();
    };

    window.cancelComparison = function() {
        comparisonState = { athlete1: null, athlete2: null, mode: 'idle' };
        document.getElementById('comparison-modal-overlay')?.remove();
        // Clean up chart instance
        if (comparisonChartInstance) {
            comparisonChartInstance.destroy();
            comparisonChartInstance = null;
        }
        comparisonResultsCache = null;
        comparisonFullHistory = false;
    };

    window.showComparison = function() {
        const { athlete1, athlete2 } = comparisonState;
        if (!athlete1 || !athlete2) return;

        document.getElementById('comparison-banner')?.remove();
        document.getElementById('athleteName').placeholder = 'Search athletes or events...';

        const resultsDiv = document.getElementById('results');
        const currentYear = new Date().getFullYear();

        // Check for pending AI response to prepend
        const aiResponseHtml = window.pendingAIResponse || '';
        window.pendingAIResponse = null; // Clear after using

        const createComparisonCard = (athlete, color) => {
            const hasImage = athlete.athlete_profile_image?.startsWith('http');
            const age = athlete.athlete_yob ? currentYear - parseInt(athlete.athlete_yob) : null;

            return `
                <div class="comparison-card">
                    <div class="comparison-card-color" style="background: ${color};"></div>
                    ${hasImage ?
                        `<img class="comparison-card-photo" src="${athlete.athlete_profile_image}" alt="" onerror="this.style.display='none'">` :
                        `<div class="comparison-card-photo" style="display:flex;align-items:center;justify-content:center;font-size:var(--text-xl);color:var(--text-tertiary)">${getInitials(athlete.athlete_full_name)}</div>`
                    }
                    <span class="comparison-card-name" onclick="viewAthleteFromComparison(${athlete.athlete_id})" style="cursor: pointer;">${athlete.athlete_full_name}</span>
                    <div class="comparison-card-country">
                        <img class="comparison-flag" src="${athlete.athlete_flag || ''}" alt="" onerror="this.style.display='none'">
                        ${athlete.athlete_country_name || ''}
                    </div>
                    ${athlete.world_rank ? `<div class="comparison-rank">World #${athlete.world_rank}</div>` : ''}
                    <div class="comparison-stats">
                        ${age ? `<div><div class="comparison-stat-label">Age</div><div class="comparison-stat-value">${age}</div></div>` : ''}
                        ${athlete.race_wins ? `<div><div class="comparison-stat-label">Wins</div><div class="comparison-stat-value">${athlete.race_wins}</div></div>` : ''}
                        ${athlete.race_podiums ? `<div><div class="comparison-stat-label">Podiums</div><div class="comparison-stat-value">${athlete.race_podiums}</div></div>` : ''}
                    </div>
                    <span class="comparison-profile-link" onclick="viewAthleteFromComparison(${athlete.athlete_id})" style="cursor: pointer;">View Full Profile </span>
                </div>
            `;
        };

        resultsDiv.innerHTML = `
            <section class="results-section">
                ${aiResponseHtml}
                <button class="back-btn" onclick="cancelComparison(); fetchTopRankings();"> Back</button>
                <div class="section-header">
                    <h2 class="section-title">Head to Head</h2>
                </div>
                <div class="comparison-grid">
                    ${createComparisonCard(athlete1, '#3b82f6')}
                    <div class="comparison-vs">VS</div>
                    ${createComparisonCard(athlete2, '#ef4444')}
                </div>
                <div class="athlete-section">
                    <div class="athlete-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Race Finishes</span>
                        <span style="font-size: var(--text-xs); font-weight: 400; text-transform: none; letter-spacing: 0; color: var(--text-tertiary);">Click points for details</span>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                    <div class="chart-legend" style="justify-content: center;">
                        <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #3b82f6;"></span> ${athlete1.athlete_full_name.split(' ').pop()}</div>
                        <div class="chart-legend-item"><span class="chart-legend-dot" style="background: #ef4444;"></span> ${athlete2.athlete_full_name.split(' ').pop()}</div>
                    </div>
                    <div style="text-align: center; margin-top: var(--space-3);">
                        <button id="comparison-history-btn" class="athlete-link athlete-link-secondary" onclick="toggleComparisonHistory()" style="font-size: var(--text-xs); height: 32px;" data-view="recent">
                            Load Full Race History
                        </button>
                    </div>
                </div>
                <div class="athlete-section">
                    <div class="athlete-section-title">Recent Results</div>
                    <div id="comparison-results-container" class="comparison-results-grid">
                    </div>
                </div>
            </section>
        `;

        // Cache results for toggle functionality
        comparisonResultsCache = {
            athlete1: { id: athlete1.athlete_id, data: athlete1, results: athlete1.latest_results || [] },
            athlete2: { id: athlete2.athlete_id, data: athlete2, results: athlete2.latest_results || [] }
        };
        comparisonFullHistory = false;

        // Render initial results table
        updateComparisonResultsTable();

        // Render comparison chart
        setTimeout(() => renderComparisonChart(athlete1, athlete2), 0);
    };

    // Navigate to athlete detail from comparison
    window.viewAthleteFromComparison = async function(athleteId) {
        cancelComparison();
        currentRankingsData = null;
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading athlete...</div>';
        const details = await getAthleteDetails(athleteId);
        if (details) {
            showAthleteDetail(details);
        } else {
            resultsDiv.innerHTML = '<div class="error-message">Unable to load athlete details.</div>';
        }
    };

    // Cache for comparison results
    let comparisonResultsCache = null;
    let comparisonFullHistory = false;
    let comparisonChartInstance = null;

    // Helper to get position class
    function getComparisonPositionClass(pos) {
        if (pos === 1) return 'gold';
        if (pos === 2) return 'silver';
        if (pos === 3) return 'bronze';
        return '';
    }

    // Update the results table
    function updateComparisonResultsTable() {
        const container = document.getElementById('comparison-results-container');
        if (!container || !comparisonResultsCache) return;

        const { athlete1, athlete2 } = comparisonState;
        const results1 = comparisonFullHistory ? (comparisonResultsCache.athlete1.fullResults || []) : (comparisonResultsCache.athlete1.results || []);
        const results2 = comparisonFullHistory ? (comparisonResultsCache.athlete2.fullResults || []) : (comparisonResultsCache.athlete2.results || []);

        const createResultsColumn = (athlete, results, color) => {
            const displayResults = results.slice(0, comparisonFullHistory ? 15 : 5);
            if (displayResults.length === 0) return '<div class="comparison-no-results">No results</div>';

            return displayResults.map((r, idx) => {
                const pos = parseInt(r.position) || 0;
                const posClass = getComparisonPositionClass(pos);
                const eventDate = r.event_date ? new Date(r.event_date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' }) : '';
                const isTeamRelay = r.prog_name && (r.prog_name.toLowerCase().includes('relay') || r.prog_name.toLowerCase().includes('team') || r.prog_name.toLowerCase().includes('mixed'));
                const clickHandler = isTeamRelay ? '' : `onclick="showComparisonRaceDetails(${athlete.athlete_id}, ${idx}, ${comparisonFullHistory})"`;
                return `
                    <div class="comparison-result-row ${isTeamRelay ? '' : 'clickable'}" ${clickHandler} ${isTeamRelay ? 'title="Team/Relay event"' : ''}>
                        <div class="comparison-result-info">
                            <div class="comparison-result-event">${r.event_title || 'Race'}</div>
                            <div class="comparison-result-date">${eventDate}</div>
                        </div>
                        <div class="comparison-result-position ${posClass}">${pos > 0 ? '#' + pos : ''}</div>
                    </div>
                `;
            }).join('');
        };

        container.innerHTML = `
            <div class="comparison-results-column">
                <div class="comparison-results-header" style="border-color: #3b82f6;">${athlete1.athlete_full_name.split(' ').pop()}</div>
                ${createResultsColumn(athlete1, results1, '#3b82f6')}
            </div>
            <div class="comparison-results-column">
                <div class="comparison-results-header" style="border-color: #ef4444;">${athlete2.athlete_full_name.split(' ').pop()}</div>
                ${createResultsColumn(athlete2, results2, '#ef4444')}
            </div>
        `;
    }

    // Show race details from comparison results table
    window.showComparisonRaceDetails = async function(athleteId, resultIndex, isFullHistory) {
        const cacheEntry = comparisonResultsCache.athlete1.id === athleteId ? comparisonResultsCache.athlete1 : comparisonResultsCache.athlete2;
        const results = isFullHistory ? (cacheEntry.fullResults || []) : (cacheEntry.results || []);
        const result = results[resultIndex];
        if (!result) return;

        // Reuse the existing showRaceTooltip function which shows the race details modal
        if (typeof showRaceTooltip === 'function') {
            showRaceTooltip(null, result, null);
        }
    };

    // Show race details from athlete details page results table
    window.showAthleteResultDetails = function(resultIndex) {
        if (!window.currentAthleteResults || !window.currentAthleteResults[resultIndex]) return;
        const result = window.currentAthleteResults[resultIndex];

        // Reuse the existing showRaceTooltip function which shows the race details modal
        if (typeof showRaceTooltip === 'function') {
            showRaceTooltip(null, result, null);
        }
    };

    // Toggle between recent and full history for comparison
    window.toggleComparisonHistory = async function() {
        const btn = document.getElementById('comparison-history-btn');
        if (!btn || !comparisonResultsCache) return;

        const { athlete1, athlete2 } = comparisonState;
        if (!athlete1 || !athlete2) return;

        if (!comparisonFullHistory) {
            // Load full history
            btn.textContent = 'Loading...';
            btn.disabled = true;

            try {
                const [fullResults1, fullResults2] = await Promise.all([
                    fetch(`${API_BASE}?endpoint=/athletes/${athlete1.athlete_id}/results`).then(r => r.json()),
                    fetch(`${API_BASE}?endpoint=/athletes/${athlete2.athlete_id}/results`).then(r => r.json())
                ]);

                comparisonResultsCache.athlete1.fullResults = fullResults1.data || [];
                comparisonResultsCache.athlete2.fullResults = fullResults2.data || [];
                comparisonFullHistory = true;

                // Re-render chart with full history
                renderComparisonChart(
                    { ...athlete1, latest_results: comparisonResultsCache.athlete1.fullResults },
                    { ...athlete2, latest_results: comparisonResultsCache.athlete2.fullResults }
                );

                // Update the results table
                updateComparisonResultsTable();

                btn.textContent = 'Show Recent Only';
                btn.disabled = false;
            } catch (e) {
                btn.textContent = 'Load Full Race History';
                btn.disabled = false;
            }
        } else {
            // Switch back to recent
            comparisonFullHistory = false;
            renderComparisonChart(athlete1, athlete2);
            updateComparisonResultsTable();
            btn.textContent = 'Load Full Race History';
        }
    };

    async function renderComparisonChart(athlete1, athlete2) {
        const ctx = document.getElementById('comparison-chart');
        if (!ctx) return;

        // Load Chart.js if not already loaded
        await loadChartJs();

        // Destroy existing chart before creating a new one
        if (comparisonChartInstance) {
            comparisonChartInstance.destroy();
            comparisonChartInstance = null;
        }

        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

        const prepareData = (results) => {
            if (!results) return { labels: [], data: [], results: [] };
            const sorted = [...results]
                .filter(r => r.event_date && r.position && !isNaN(parseInt(r.position)))
                .sort((a, b) => new Date(a.event_date) - new Date(b.event_date));
            return {
                labels: sorted.map(r => new Date(r.event_date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' })),
                data: sorted.map(r => parseInt(r.position)),
                results: sorted
            };
        };

        const data1 = prepareData(athlete1.latest_results);
        const data2 = prepareData(athlete2.latest_results);

        // Merge labels - use actual dates for proper sorting
        const allDates = new Map();
        [...data1.results, ...data2.results].forEach(r => {
            const label = new Date(r.event_date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            const date = new Date(r.event_date);
            if (!allDates.has(label) || date > allDates.get(label)) {
                allDates.set(label, date);
            }
        });
        const allLabels = [...allDates.entries()]
            .sort((a, b) => a[1] - b[1])
            .map(entry => entry[0]);

        const styles = getComputedStyle(document.documentElement);
        const textSecondary = styles.getPropertyValue('--text-secondary').trim();
        const borderColor = styles.getPropertyValue('--border-primary').trim();

        comparisonChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: allLabels,
                datasets: [
                    {
                        label: athlete1.athlete_full_name,
                        data: allLabels.map(l => {
                            const idx = data1.labels.indexOf(l);
                            return idx >= 0 ? data1.data[idx] : null;
                        }),
                        borderColor: '#3b82f6',
                        backgroundColor: 'transparent',
                        fill: false,
                        spanGaps: true,
                        tension: 0.3,
                        pointRadius: 8,
                        pointHoverRadius: 11,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: isDark ? '#171717' : '#ffffff',
                        pointBorderWidth: 2,
                        borderWidth: 2.5
                    },
                    {
                        label: athlete2.athlete_full_name,
                        data: allLabels.map(l => {
                            const idx = data2.labels.indexOf(l);
                            return idx >= 0 ? data2.data[idx] : null;
                        }),
                        borderColor: '#ef4444',
                        backgroundColor: 'transparent',
                        fill: false,
                        spanGaps: true,
                        tension: 0.3,
                        pointRadius: 8,
                        pointHoverRadius: 11,
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: isDark ? '#171717' : '#ffffff',
                        pointBorderWidth: 2,
                        borderWidth: 2.5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 20, bottom: 16, left: 8, right: 24 }
                },
                scales: {
                    y: {
                        reverse: true,
                        min: 0,
                        grace: '5%',
                        title: {
                            display: true,
                            text: 'Finish Position',
                            color: textSecondary,
                            font: { size: 12, family: 'Plus Jakarta Sans', weight: 600 },
                            padding: { bottom: 8 }
                        },
                        ticks: {
                            color: textSecondary,
                            font: { size: 11, family: 'Plus Jakarta Sans', weight: 500 },
                            padding: 12,
                            stepSize: 1,
                            callback: (value) => value >= 1 ? '#' + value : ''
                        },
                        grid: {
                            color: borderColor,
                            lineWidth: 1,
                            drawTicks: false
                        },
                        border: { display: false }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Race Date',
                            color: textSecondary,
                            font: { size: 12, family: 'Plus Jakarta Sans', weight: 600 },
                            padding: { top: 8 }
                        },
                        ticks: {
                            color: textSecondary,
                            font: { size: 11, family: 'Plus Jakarta Sans', weight: 500 },
                            padding: 8,
                            maxRotation: 45,
                            minRotation: 0
                        },
                        grid: { display: false },
                        border: { display: false }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        align: 'end',
                        labels: {
                            color: textSecondary,
                            font: { size: 12, family: 'Plus Jakarta Sans', weight: 500 },
                            boxWidth: 12,
                            boxHeight: 12,
                            padding: 16,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: isDark ? '#262626' : '#171717',
                        titleColor: '#fafafa',
                        bodyColor: '#fafafa',
                        titleFont: { size: 12, weight: 500, family: 'Plus Jakarta Sans' },
                        bodyFont: { size: 13, weight: 600, family: 'Plus Jakarta Sans' },
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: true,
                        boxWidth: 8,
                        boxHeight: 8,
                        boxPadding: 4
                    }
                },
                interaction: {
                    intersect: true,
                    mode: 'nearest'
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const element = elements[0];
                        const datasetIndex = element.datasetIndex;
                        const labelIndex = element.index;
                        const label = allLabels[labelIndex];

                        // Find which result this corresponds to
                        const targetData = datasetIndex === 0 ? data1 : data2;
                        const resultIndex = targetData.labels.indexOf(label);
                        if (resultIndex >= 0 && targetData.results[resultIndex]) {
                            const result = targetData.results[resultIndex];
                            // Check if it's a team/relay event
                            const isTeamRelay = result.prog_name && (result.prog_name.toLowerCase().includes('relay') || result.prog_name.toLowerCase().includes('team') || result.prog_name.toLowerCase().includes('mixed'));
                            if (!isTeamRelay && typeof showRaceTooltip === 'function') {
                                showRaceTooltip(event, result, ctx);
                            }
                        }
                    }
                },
                onHover: (event, elements) => {
                    ctx.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                }
            }
        });
    }

    // --- URL Routing ---
    function handleRouting() {
        const params = new URLSearchParams(window.location.search);

        const athleteId = params.get('athlete');
        if (athleteId) {
            loadAthleteFromUrl(athleteId);
            return;
        }

        const view = params.get('view');
        if (view === 'favorites') {
            showFavorites();
            return;
        }
        if (view === 'rankings') {
            fetchTopRankings();
            return;
        }

        fetchTopRankings();
    }

    async function loadAthleteFromUrl(athleteId) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading athlete...</div>';

        const details = await getAthleteDetails(parseInt(athleteId));
        if (details) {
            showAthleteDetail(details);
        } else {
            resultsDiv.innerHTML = '<div class="error-message">Athlete not found.</div>';
        }
    }

    // Handle browser back/forward
    window.addEventListener('popstate', handleRouting);

    // --- Load page based on URL ---
    handleRouting();

  </script>
</body>
</html>
