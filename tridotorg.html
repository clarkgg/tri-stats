<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tri Stats</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" href="favicon.svg">
  <meta name="theme-color" content="#171717">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* ============================================
       DESIGN SYSTEM - Inspired by PlanetScale/OpenAI
       ============================================ */

    :root {
      /* Colors - Light */
      --bg-primary: #ffffff;
      --bg-secondary: #fafafa;
      --bg-tertiary: #f5f5f5;
      --text-primary: #171717;
      --text-secondary: #525252;
      --text-tertiary: #a3a3a3;
      --border-primary: #e5e5e5;
      --border-secondary: #d4d4d4;

      /* Accent */
      --accent: #171717;
      --accent-hover: #404040;
      --accent-subtle: #f5f5f5;

      /* Semantic */
      --success: #22c55e;
      --warning: #eab308;
      --error: #ef4444;

      /* Shadows */
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
      --shadow-lg: 0 12px 32px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.06);

      /* Spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-16: 64px;

      /* Radii */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 9999px;

      /* Typography Scale */
      --text-xs: 12px;
      --text-sm: 14px;
      --text-base: 16px;
      --text-lg: 18px;
      --text-xl: 20px;
      --text-2xl: 24px;
      --text-3xl: 30px;
      --text-4xl: 36px;
    }

    [data-theme="dark"] {
      --bg-primary: #0a0a0a;
      --bg-secondary: #171717;
      --bg-tertiary: #262626;
      --text-primary: #fafafa;
      --text-secondary: #a3a3a3;
      --text-tertiary: #525252;
      --border-primary: #262626;
      --border-secondary: #404040;
      --accent: #fafafa;
      --accent-hover: #d4d4d4;
      --accent-subtle: #262626;
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.2);
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.2);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
      --shadow-lg: 0 12px 32px rgba(0,0,0,0.4);
    }

    /* Reset */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Base */
    html {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    body {
      font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: var(--text-base);
      line-height: 1.6;
      color: var(--text-primary);
      background: var(--bg-primary);
      min-height: 100vh;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    /* Layout */
    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-6);
      padding-top: calc(60px + var(--space-6));
    }

    /* Navigation */
    .nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-primary);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-4) var(--space-6);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-6);
    }

    .nav-brand {
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.02em;
      text-decoration: none;
      cursor: pointer;
    }

    .nav-brand:hover {
      opacity: 0.7;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    /* Theme Toggle */
    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-2);
      background: transparent;
      border: 1px solid var(--border-primary);
      cursor: pointer;
      transition: border-color 0.15s ease;
    }

    .theme-toggle:hover {
      border-color: var(--text-primary);
    }

    .theme-toggle svg {
      width: 18px;
      height: 18px;
      stroke: var(--text-primary);
      fill: none;
      stroke-width: 2;
    }

    .theme-toggle .icon-moon {
      display: none;
    }

    [data-theme="dark"] .theme-toggle .icon-sun {
      display: none;
    }

    [data-theme="dark"] .theme-toggle .icon-moon {
      display: block;
    }

    /* Search Toolbar */
    .search-toolbar {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4) 0;
      border-bottom: 1px solid var(--border-primary);
      margin-bottom: var(--space-6);
    }

    .toolbar-hint {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 12px;
      color: var(--text-tertiary);
      white-space: nowrap;
    }

    .toolbar-hint kbd {
      font-family: 'SF Mono', ui-monospace, monospace;
      font-size: 11px;
      padding: 2px 6px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      color: var(--text-tertiary);
    }

    /* Search */
    .search-wrapper {
      flex: 1;
      max-width: 480px;
      position: relative;
      z-index: 100;
    }

    .search-box {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      padding-right: 80px;
      font-family: inherit;
      font-size: 14px;
      color: var(--text-primary);
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      outline: none;
      transition: border-color 0.15s ease;
    }

    .search-input:focus {
      border-color: var(--text-primary);
    }

    .search-input::placeholder {
      color: var(--text-tertiary);
    }

    .search-btn {
      position: absolute;
      right: 1px;
      top: 1px;
      bottom: 1px;
      padding: 0 var(--space-4);
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      color: var(--bg-primary);
      background: var(--text-primary);
      border: none;
      cursor: pointer;
      transition: opacity 0.15s ease;
    }

    .search-btn:hover {
      opacity: 0.8;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: var(--space-2);
    }

    .quick-btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: 1px solid var(--border-primary);
      cursor: pointer;
      transition: all 0.15s ease;
      text-decoration: none;
    }

    .quick-btn:hover {
      color: var(--text-primary);
      border-color: var(--text-primary);
    }

    /* Autocomplete */
    .autocomplete-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-top: none;
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      z-index: 1000;
    }

    .autocomplete-item {
      padding: var(--space-3) var(--space-4);
      font-size: 14px;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.1s ease;
      border-bottom: 1px solid var(--border-primary);
      outline: none;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover {
      background: var(--bg-tertiary);
    }

    .autocomplete-item.is-active,
    .autocomplete-item:focus {
      background: var(--bg-tertiary);
      box-shadow: inset 2px 0 0 var(--accent);
    }

    .autocomplete-loading, .autocomplete-empty {
      padding: var(--space-4);
      text-align: center;
      color: var(--text-tertiary);
      font-size: 14px;
    }

    .autocomplete-loading::before {
      content: '';
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border-secondary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: var(--space-2);
      vertical-align: middle;
    }

    /* Photo Grid - Visual Home Display */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 2px;
    }

    .photo-card {
      display: block;
      position: relative;
      aspect-ratio: 4/3;
      overflow: hidden;
      cursor: pointer;
      background: var(--bg-secondary);
      text-decoration: none;
    }

    .photo-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .photo-card:hover img {
      transform: scale(1.05);
    }

    .photo-card-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%);
      opacity: 0;
      transition: opacity 0.2s ease;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: var(--space-4);
    }

    .photo-card:hover .photo-card-overlay {
      opacity: 1;
    }

    .photo-card-name {
      font-size: var(--text-base);
      font-weight: 600;
      color: white;
      margin-bottom: 2px;
    }

    .photo-card-country {
      font-size: var(--text-sm);
      color: rgba(255,255,255,0.7);
    }

    .photo-card-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 600;
      color: var(--text-tertiary);
      background: var(--bg-tertiary);
    }

    /* Video List */
    .video-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--space-2);
    }

    .video-item {
      display: block;
      padding: var(--space-3);
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      text-decoration: none;
      transition: border-color 0.15s ease, background 0.15s ease;
    }

    .video-item:hover {
      border-color: var(--text-tertiary);
      background: var(--bg-tertiary);
    }

    .video-item-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
      margin-bottom: var(--space-1);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .video-item-description {
      display: none;
    }

    .video-item-meta {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
    }

    .home-section {
      margin-bottom: var(--space-8);
    }

    .home-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
    }

    .home-section-title {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.01em;
    }

    .home-section-link {
      font-size: 13px;
      color: var(--text-secondary);
      text-decoration: none;
    }

    .home-section-link:hover {
      color: var(--text-primary);
    }

    /* Results Section */
    .results-section {
      padding-top: var(--space-8);
    }

    .section-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: var(--space-6);
      padding-bottom: var(--space-4);
      border-bottom: 1px solid var(--border-primary);
    }

    .section-title {
      font-size: var(--text-3xl);
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    .section-meta {
      font-size: 14px;
      color: var(--text-tertiary);
    }

    .athlete-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-4);
    }

    @media (min-width: 900px) {
      .athlete-list {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    /* Rankings Grid */
    .rankings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-8);
      align-items: start;
    }

    @media (max-width: 768px) {
      .rankings-grid {
        grid-template-columns: 1fr;
      }
    }

    .ranking-column-title {
      font-size: var(--text-xl);
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text-primary);
      margin-bottom: var(--space-4);
    }

    .ranking-column {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    /* Compact Ranking Items */
    .ranking-item {
      display: grid;
      grid-template-columns: 36px 72px 1fr auto;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-primary);
      cursor: pointer;
      transition: background 0.1s ease;
    }

    .ranking-item:first-child {
      border-top: 1px solid var(--border-primary);
    }

    .ranking-item:hover {
      background: var(--bg-secondary);
    }

    .ranking-item-rank {
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--text-tertiary);
      text-align: center;
    }

    .ranking-item-rank.top3 {
      color: var(--text-primary);
      font-weight: 800;
    }

    .ranking-item-photo {
      width: 72px;
      height: 72px;
      object-fit: cover;
      background: var(--bg-tertiary);
    }

    .ranking-item-placeholder {
      width: 72px;
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      color: var(--text-tertiary);
      font-size: var(--text-lg);
      font-weight: 600;
    }

    .ranking-item-info {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
      min-width: 0;
    }

    .ranking-item-name {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ranking-item-country {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      font-weight: 400;
    }

    .ranking-item-flag {
      height: 14px;
    }

    .ranking-item-arrow {
      color: var(--text-tertiary);
      font-size: 18px;
    }

    /* Back Button for Detail View */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: 1px solid var(--border-primary);
      cursor: pointer;
      margin-bottom: var(--space-4);
      transition: all 0.15s ease;
    }

    .back-btn:hover {
      color: var(--text-primary);
      border-color: var(--text-primary);
    }

    /* Athlete Cards - Profile Style */
    .athlete-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      overflow: hidden;
      margin-bottom: var(--space-6);
    }

    .athlete-hero {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: var(--space-6);
      padding: var(--space-6);
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-primary);
    }

    .athlete-photo {
      position: relative;
    }

    .athlete-avatar {
      width: 200px;
      height: 240px;
      object-fit: cover;
      background: var(--bg-tertiary);
    }

    .athlete-placeholder {
      width: 200px;
      height: 240px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      color: var(--text-tertiary);
      font-size: 48px;
      font-weight: 600;
    }

    .athlete-rank {
      position: absolute;
      top: var(--space-2);
      left: var(--space-2);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
    }

    .athlete-rank.gold {
      background: #fde68a;
      border-color: #f59e0b;
      color: #92400e;
    }

    .athlete-rank.silver {
      background: #e5e7eb;
      border-color: #9ca3af;
      color: #374151;
    }

    .athlete-rank.bronze {
      background: #fdba74;
      border-color: #f97316;
      color: #9a3412;
    }

    .athlete-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .athlete-header {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-2);
    }

    .athlete-name {
      font-size: var(--text-4xl);
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.02em;
      line-height: 1.1;
    }

    .athlete-flag {
      height: 24px;
    }

    .athlete-country {
      font-size: var(--text-lg);
      font-weight: 400;
      color: var(--text-secondary);
      margin-bottom: var(--space-4);
    }

    .athlete-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-4);
    }

    .athlete-stat {
      display: flex;
      flex-direction: column;
    }

    .athlete-stat-label {
      font-size: var(--text-xs);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      margin-bottom: 2px;
    }

    .athlete-stat-value {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--text-primary);
    }

    .athlete-actions {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-2);
    }

    .athlete-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: var(--space-2) var(--space-4);
      font-size: 13px;
      font-weight: 500;
      color: var(--bg-primary);
      background: var(--text-primary);
      text-decoration: none;
      transition: opacity 0.15s ease;
    }

    .athlete-link:hover {
      opacity: 0.8;
    }

    .athlete-link-secondary {
      color: var(--text-primary);
      background: transparent;
      border: 1px solid var(--border-primary);
    }

    .athlete-link-secondary:hover {
      border-color: var(--text-primary);
      opacity: 1;
    }

    /* Athlete Body - Results & Gallery */
    .athlete-body {
      padding: var(--space-6);
    }

    .athlete-section {
      margin-bottom: var(--space-6);
    }

    .athlete-section:last-child {
      margin-bottom: 0;
    }

    .athlete-section-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--border-primary);
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--space-3);
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4);
      background: var(--bg-secondary);
      text-decoration: none;
      color: var(--text-primary);
      transition: background 0.15s ease;
    }

    .result-item:hover {
      background: var(--bg-tertiary);
    }

    .result-event {
      font-size: 14px;
      font-weight: 500;
    }

    .result-year {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    .result-position {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-secondary);
    }

    .result-position.top3 {
      color: var(--text-primary);
    }

    /* Image Gallery */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 2px;
    }

    .gallery-grid a {
      aspect-ratio: 1;
      overflow: hidden;
    }

    .gallery-grid img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .gallery-grid a:hover img {
      transform: scale(1.05);
    }

    /* Responsive */
    @media (max-width: 640px) {
      .athlete-hero {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .athlete-photo {
        display: flex;
        justify-content: center;
      }

      .athlete-avatar, .athlete-placeholder {
        width: 160px;
        height: 200px;
      }

      .athlete-header {
        justify-content: center;
      }

      .athlete-name {
        font-size: 24px;
      }

      .athlete-actions {
        justify-content: center;
      }
    }

    /* Loading */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-16) 0;
      color: var(--text-tertiary);
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-secondary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-bottom: var(--space-4);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error */
    .error-message {
      padding: var(--space-4) var(--space-5);
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: var(--radius-md);
      color: #dc2626;
      font-size: 14px;
    }

    [data-theme="dark"] .error-message {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-12) 0;
      color: var(--text-tertiary);
    }

    /* Focus styles for accessibility */
    .quick-btn:focus, .search-btn:focus, .athlete-link:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .app {
        padding: var(--space-4);
        padding-top: calc(56px + var(--space-4));
      }

      .nav-inner {
        padding: var(--space-3) var(--space-4);
      }

      .search-toolbar {
        flex-wrap: wrap;
      }

      .search-wrapper {
        flex: 1 1 100%;
        max-width: none;
        order: 1;
      }

      .quick-actions {
        order: 2;
      }

      .toolbar-hint {
        order: 3;
        margin-left: auto;
      }

      .athlete-card {
        grid-template-columns: 1fr;
      }

      .athlete-main {
        grid-template-columns: 1fr;
      }
    }

    /* Smooth transitions for theme */
    .nav, .athlete-card, .search-input, .quick-btn, .autocomplete-results {
      transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    /* ============================================
       NEW FEATURES - Favorites, Charts, Comparison
       ============================================ */

    /* Favorite Button */
    .favorite-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: transparent;
      border: 1px solid var(--border-primary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .favorite-btn:hover {
      border-color: var(--text-primary);
    }

    .favorite-btn svg {
      width: 18px;
      height: 18px;
      stroke: var(--text-secondary);
      fill: none;
      transition: all 0.15s ease;
    }

    .favorite-btn.is-favorite svg {
      stroke: #f59e0b;
      fill: #f59e0b;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: var(--space-6);
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: var(--bg-primary);
      padding: var(--space-3) var(--space-6);
      font-size: 14px;
      z-index: 1000;
      animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    @keyframes toastOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Chart Container */
    .chart-container {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      padding: var(--space-6);
      margin-top: var(--space-4);
    }

    .chart-container canvas {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
    }

    /* Trend Summary */
    .trend-summary {
      display: flex;
      align-items: center;
      gap: var(--space-6);
      padding: var(--space-4);
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
    }

    .trend-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: var(--space-3);
      min-width: 80px;
    }

    .trend-indicator.improving { color: #22c55e; }
    .trend-indicator.declining { color: #ef4444; }
    .trend-indicator.stable { color: var(--text-secondary); }

    .trend-icon {
      font-size: 28px;
      font-weight: bold;
      line-height: 1;
    }

    .trend-label {
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: var(--space-1);
    }

    .trend-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-4);
      flex: 1;
    }

    .trend-stat {
      display: flex;
      flex-direction: column;
    }

    .trend-stat-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
    }

    .trend-stat-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Comparison Modal */
    .comparison-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.15s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .comparison-modal {
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      width: 100%;
      max-width: 480px;
      margin: var(--space-4);
      animation: slideUp 0.2s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .comparison-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4);
      border-bottom: 1px solid var(--border-primary);
    }

    .comparison-modal-title {
      font-size: 15px;
      font-weight: 600;
    }

    .comparison-modal-close {
      background: transparent;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      line-height: 1;
      padding: 0;
    }

    .comparison-modal-close:hover {
      color: var(--text-primary);
    }

    .comparison-modal-body {
      padding: var(--space-4);
    }

    .comparison-modal-athlete {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--bg-secondary);
      margin-bottom: var(--space-4);
    }

    .comparison-modal-athlete-photo {
      width: 48px;
      height: 48px;
      object-fit: cover;
      background: var(--bg-tertiary);
    }

    .comparison-modal-athlete-placeholder {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      color: var(--text-tertiary);
      font-size: 14px;
      font-weight: 600;
    }

    .comparison-modal-athlete-info {
      flex: 1;
    }

    .comparison-modal-athlete-name {
      font-size: 15px;
      font-weight: 500;
    }

    .comparison-modal-athlete-country {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .comparison-modal-search {
      position: relative;
    }

    .comparison-modal-search input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      font-family: inherit;
      font-size: 14px;
      color: var(--text-primary);
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      outline: none;
    }

    .comparison-modal-search input:focus {
      border-color: var(--text-primary);
    }

    .comparison-modal-results {
      max-height: 240px;
      overflow-y: auto;
      border: 1px solid var(--border-primary);
      border-top: none;
    }

    .comparison-modal-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      border-bottom: 1px solid var(--border-primary);
      transition: background 0.1s;
    }

    .comparison-modal-item:last-child {
      border-bottom: none;
    }

    .comparison-modal-item:hover {
      background: var(--bg-tertiary);
    }

    .comparison-modal-item-photo {
      width: 36px;
      height: 36px;
      object-fit: cover;
      background: var(--bg-tertiary);
    }

    .comparison-modal-item-placeholder {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      color: var(--text-tertiary);
      font-size: 12px;
      font-weight: 600;
    }

    .comparison-modal-item-info {
      flex: 1;
    }

    .comparison-modal-item-name {
      font-size: 14px;
      font-weight: 500;
    }

    .comparison-modal-item-country {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .comparison-modal-loading {
      padding: var(--space-4);
      text-align: center;
      color: var(--text-tertiary);
      font-size: 14px;
    }

    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: var(--space-4);
      align-items: start;
      margin-bottom: var(--space-6);
    }

    .comparison-vs {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-tertiary);
      padding: var(--space-8) var(--space-4);
    }

    .comparison-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      padding: var(--space-4);
      text-align: center;
    }

    .comparison-card-photo {
      width: 120px;
      height: 150px;
      object-fit: cover;
      margin: 0 auto var(--space-3);
      background: var(--bg-tertiary);
    }

    .comparison-card-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: var(--space-1);
    }

    .comparison-card-country {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: var(--space-3);
    }

    .comparison-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-2);
      text-align: left;
    }

    .comparison-stat-label {
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: uppercase;
    }

    .comparison-stat-value {
      font-size: 14px;
      font-weight: 500;
    }

    /* Mobile: hide comparison features */
    @media (max-width: 768px) {
      .compare-btn-wrapper {
        display: none;
      }

      .comparison-grid {
        grid-template-columns: 1fr;
      }

      .comparison-vs {
        padding: var(--space-4);
      }

      .trend-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .trend-summary {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-inner">
      <a href="#" class="nav-brand" onclick="fetchTopRankings(); return false;">Tri Stats</a>
      <div class="nav-actions">
        <button class="quick-btn" onclick="showFavorites()" aria-label="View favorites">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        </button>
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
          <svg class="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
          <svg class="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        </button>
      </div>
    </div>
  </nav>

  <div class="app">
    <div class="search-toolbar">
      <div class="search-wrapper">
        <div class="search-box">
          <input
            type="text"
            id="athleteName"
            class="search-input"
            placeholder="Search athlete name..."
            autocomplete="off"
          />
          <button class="search-btn" onclick="searchAthlete()">Search</button>
          <div id="autocomplete-results" class="autocomplete-results" role="listbox" aria-label="Athlete suggestions"></div>
        </div>
      </div>
      <div class="quick-actions">
        <button class="quick-btn" onclick="fetchTopRankings()">Rankings</button>
        <button class="quick-btn" onclick="showHomePage()">Featured Content</button>
        <a class="quick-btn" href="https://triathlon.org/news" target="_blank" rel="noopener">News ↗</a>
      </div>
      <div class="toolbar-hint">
        <kbd id="keyboard-hint"></kbd>
      </div>
    </div>

    <main id="results"></main>
  </div>

  <script>
    // API calls go through our serverless proxy (see /api/triathlon.js)
    // This keeps the API key secure on the server side
    const API_BASE = '/api/triathlon';

    // World Triathlon Championship Series rankings (IDs 15/16 for current WTCS)
    const RANKING_IDS = { male: 15, female: 16 };

    // Store current rankings data for navigation
    let currentRankingsData = null;

    // Store raw ranking IDs for progressive loading
    let rankingIds = { men: [], women: [] };
    let rankingsLoaded = 0;
    const RANKINGS_PER_PAGE = 10;
    const RANKINGS_MAX = 30;

    // Cache for athlete details to avoid redundant API calls
    const athleteCache = new Map();

    // Comparison state
    let comparisonState = {
      athlete1: null,
      athlete2: null,
      mode: 'idle' // 'idle' | 'selecting' | 'comparing'
    };

    // Favorites Manager (localStorage with try/catch for private browsing)
    const favoritesManager = (() => {
      const STORAGE_KEY = 'triathlon_favorites';

      const getFavorites = () => {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch { return []; }
      };

      const saveFavorites = (favorites) => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(favorites));
        } catch { /* ignore in private browsing */ }
      };

      return {
        getFavorites,
        addFavorite: (id) => {
          const favorites = getFavorites();
          if (!favorites.includes(id)) {
            favorites.push(id);
            saveFavorites(favorites);
          }
        },
        removeFavorite: (id) => {
          const favorites = getFavorites().filter(f => f !== id);
          saveFavorites(favorites);
        },
        isFavorite: (id) => getFavorites().includes(id),
        toggle: (id) => {
          const favorites = getFavorites();
          if (favorites.includes(id)) {
            favoritesManager.removeFavorite(id);
            return false;
          } else {
            favoritesManager.addFavorite(id);
            return true;
          }
        }
      };
    })();

    // Utility: Check if mobile device/screen
    function isMobile() {
      return window.innerWidth < 768;
    }

    // Toast notification
    function showToast(message) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // --- THEME TOGGLE LOGIC ---
    const themeToggle = document.getElementById('theme-toggle');
    const currentTheme = localStorage.getItem('theme');

    if (currentTheme) {
        document.documentElement.setAttribute('data-theme', currentTheme);
    }

    function switchTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const newTheme = isDark ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }

    themeToggle.addEventListener('click', switchTheme);

    // --- KEYBOARD SHORTCUT ---
    // Detect OS and show appropriate hint
    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
    document.getElementById('keyboard-hint').textContent = isMac ? '⌘K' : 'Ctrl+K';

    // Global keyboard shortcut to focus search
    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        const searchInput = document.getElementById('athleteName');
        searchInput.focus();
        searchInput.select();
      }
    });


    // --- UTILITY: Debounce function to limit API calls while typing ---
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // --- SETUP EVENT LISTENERS ---
    const searchInput = document.getElementById('athleteName');
    let selectedIndex = -1;
    
    searchInput.addEventListener('keydown', function(event) {
        const autocompleteResults = document.getElementById('autocomplete-results');
        const items = autocompleteResults.querySelectorAll('.autocomplete-item');
        
        if (event.key === 'ArrowDown') {
            event.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection(items);
        } else if (event.key === 'ArrowUp') {
            event.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(items);
        } else if (event.key === 'Enter') {
            event.preventDefault();
            if (selectedIndex >= 0 && items[selectedIndex]) {
                items[selectedIndex].click();
            } else {
                autocompleteResults.style.display = 'none';
                searchAthlete();
            }
        } else if (event.key === 'Escape') {
            autocompleteResults.style.display = 'none';
            selectedIndex = -1;
        }
    });

    function updateSelection(items) {
        items.forEach((item, index) => {
            const isActive = index === selectedIndex;
            item.classList.toggle('is-active', isActive);
            item.setAttribute('aria-selected', isActive ? 'true' : 'false');
            if (isActive) {
                item.scrollIntoView({ block: 'nearest' });
            }
        });
    }

    searchInput.addEventListener('input', debounce(handleAutocomplete, 300));

    document.addEventListener('click', function(event) {
      const searchBox = document.querySelector('.search-box');
      if (!searchBox.contains(event.target)) {
        document.getElementById('autocomplete-results').style.display = 'none';
      }
    });

    // --- Autocomplete handler (optimized - no detail fetches until click) ---
    async function handleAutocomplete() {
      const query = searchInput.value;
      const autocompleteResults = document.getElementById('autocomplete-results');

      if (query.length < 2) {
        autocompleteResults.style.display = 'none';
        return;
      }

      // Show loading state
      autocompleteResults.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
      autocompleteResults.style.display = 'block';

      const response = await fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(query)}&per_page=5`);

      if (!response.ok) {
        autocompleteResults.style.display = 'none';
        return;
      }

      const searchData = await response.json();
      const athletes = searchData.data || [];

      if (athletes.length === 0) {
        autocompleteResults.innerHTML = '<div class="autocomplete-empty">No athletes found</div>';
        return;
      }

      // Display results immediately using search data (no detail fetch needed)
      autocompleteResults.innerHTML = '';
      selectedIndex = -1;

      athletes.forEach(athlete => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.textContent = athlete.athlete_title;
        item.setAttribute('role', 'option');
        item.setAttribute('aria-selected', 'false');
        item.setAttribute('data-athlete-id', athlete.athlete_id);
        item.tabIndex = -1;
        item.onclick = async () => {
          searchInput.value = athlete.athlete_title;
          autocompleteResults.style.display = 'none';
          selectedIndex = -1;
          // Clear rankings context
          currentRankingsData = null;
          // Fetch full details
          const resultsDiv = document.getElementById('results');
          resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading athlete...</div>';
          const details = await getAthleteDetails(athlete.athlete_id);
          if (details) {
            showAthleteDetail(details);
          } else {
            resultsDiv.innerHTML = '<div class="error-message">Unable to load athlete details.</div>';
          }
        };
        autocompleteResults.appendChild(item);
      });
      autocompleteResults.style.display = 'block';
    }

    // --- Function to create initials from name for placeholders ---
    function getInitials(name) {
      if (!name) return '';
      return name
        .split(' ')
        .map(word => word[0])
        .join('')
        .toUpperCase();
    }
    
    // --- Fetches full details for a single athlete (with caching) ---
    async function getAthleteDetails(athleteId) {
      // Return cached data if available
      if (athleteCache.has(athleteId)) {
        return athleteCache.get(athleteId);
      }

      const response = await fetch(`${API_BASE}?endpoint=/athletes/${athleteId}`);
      if (!response.ok) return null;
      const data = await response.json();

      // Cache the result for future use
      athleteCache.set(athleteId, data.data);
      return data.data;
    }

    // --- UPDATED: Renders athlete cards with premium design ---
    function displayAthletes(athleteData, title = "Search Results") {
        const resultsDiv = document.getElementById('results');

        // Helper to get rank class
        const getRankClass = (rank) => {
            if (rank === 1) return 'athlete-rank gold';
            if (rank === 2) return 'athlete-rank silver';
            if (rank === 3) return 'athlete-rank bronze';
            return 'athlete-rank';
        };

        // Function to generate the HTML for a single athlete card
        const createAthleteCardHtml = (athlete, rank = null) => {
            const hasValidImage = athlete.athlete_profile_image && athlete.athlete_profile_image.startsWith('http');
            const imageHtml = hasValidImage ?
                `<img class="athlete-avatar" src="${athlete.athlete_profile_image}" alt="${athlete.athlete_full_name}" onerror="this.onerror=null; this.outerHTML='<div class=\\'athlete-placeholder\\'>${getInitials(athlete.athlete_full_name)}</div>'">` :
                `<div class="athlete-placeholder">${getInitials(athlete.athlete_full_name)}</div>`;

            const rankHtml = rank ? `<div class="${getRankClass(rank)}">${rank}</div>` : '';

            // Calculate age from year of birth
            const currentYear = new Date().getFullYear();
            const age = athlete.athlete_yob ? currentYear - parseInt(athlete.athlete_yob) : null;

            // Build results HTML
            const resultsHtml = (athlete.latest_results && athlete.latest_results.length > 0) ?
                `<div class="athlete-section">
                    <div class="athlete-section-title">Recent Results</div>
                    <div class="results-grid">${athlete.latest_results.slice(0, 6).map(result => {
                        const year = result.event_date ? new Date(result.event_date).getFullYear() : '';
                        const eventTitle = result.event_title || 'Race';
                        const position = parseInt(result.position) || 0;
                        const positionClass = position <= 3 ? 'result-position top3' : 'result-position';
                        const resultUrl = result.result_listing || '#';
                        return `<a href="${resultUrl}" target="_blank" class="result-item">
                            <div>
                                <div class="result-event">${eventTitle}</div>
                                <div class="result-year">${year}</div>
                            </div>
                            <div class="${positionClass}">${position > 0 ? '#' + position : '—'}</div>
                        </a>`;
                    }).join('')}</div>
                </div>` : '';

            // Build gallery HTML
            const galleryHtml = (athlete.latest_images && athlete.latest_images.length > 0) ?
                `<div class="athlete-section">
                    <div class="athlete-section-title">Photos</div>
                    <div class="gallery-grid">${athlete.latest_images.slice(0, 8).map(img => {
                        const imageUrl = img.thumbnail || img.image_url || '';
                        const fullUrl = img.image_url || '#';
                        return `<a href="${fullUrl}" target="_blank"><img src="${imageUrl}" alt="" loading="lazy" onerror="this.parentElement.style.display='none'"></a>`;
                    }).join('')}</div>
                </div>` : '';

            // Check if we have any body content
            const hasBodyContent = resultsHtml || galleryHtml;

            return `
              <article class="athlete-card">
                <div class="athlete-hero">
                  <div class="athlete-photo">
                    ${imageHtml}
                    ${rankHtml}
                  </div>
                  <div class="athlete-info">
                    <div class="athlete-header">
                      <span class="athlete-name">${athlete.athlete_full_name}</span>
                      <img class="athlete-flag" src="${athlete.athlete_flag || ''}" alt="" onerror="this.style.display='none'">
                    </div>
                    <div class="athlete-country">${athlete.athlete_country_name || ''}</div>
                    <div class="athlete-stats">
                      ${age ? `<div class="athlete-stat"><span class="athlete-stat-label">Age</span><span class="athlete-stat-value">${age}</span></div>` : ''}
                      ${athlete.athlete_yob ? `<div class="athlete-stat"><span class="athlete-stat-label">Born</span><span class="athlete-stat-value">${athlete.athlete_yob}</span></div>` : ''}
                      ${athlete.athlete_categories ? `<div class="athlete-stat"><span class="athlete-stat-label">Category</span><span class="athlete-stat-value">${athlete.athlete_categories[0] || 'Athlete'}</span></div>` : ''}
                    </div>
                    <div class="athlete-actions">
                      <a href="${athlete.athlete_listing}" class="athlete-link" target="_blank">View on triathlon.org</a>
                      <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(athlete.athlete_full_name + ' triathlon')}" class="athlete-link athlete-link-secondary" target="_blank" rel="noopener">Videos ↗</a>
                      ${athlete.athlete_media_listing ? `<a href="${athlete.athlete_media_listing}" class="athlete-link athlete-link-secondary" target="_blank">Media Gallery</a>` : ''}
                    </div>
                  </div>
                </div>
                ${hasBodyContent ? `<div class="athlete-body">${resultsHtml}${galleryHtml}</div>` : ''}
              </article>`;
        };

        // Determine count for meta
        let count = 0;
        if (Array.isArray(athleteData)) {
            count = athleteData.filter(a => a).length;
        } else if (athleteData.men && athleteData.women) {
            count = athleteData.men.filter(a => a).length + athleteData.women.filter(a => a).length;
        }

        let contentHtml = `
          <section class="results-section">
            <div class="section-header">
              <h2 class="section-title">${title}</h2>
              <span class="section-meta">${count} athlete${count !== 1 ? 's' : ''}</span>
            </div>`;

        // Check if we need to render columns or a single list
        if (Array.isArray(athleteData)) {
            const cardsHtml = athleteData.filter(a => a).map(a => createAthleteCardHtml(a)).join('');
            contentHtml += `<div class="athlete-list">${cardsHtml}</div>`;
        } else if (typeof athleteData === 'object' && athleteData.men && athleteData.women) {
            const menHtml = athleteData.men.filter(a => a).map((a, i) => createAthleteCardHtml(a, i + 1)).join('');
            const womenHtml = athleteData.women.filter(a => a).map((a, i) => createAthleteCardHtml(a, i + 1)).join('');
            contentHtml += `
              <div class="rankings-grid">
                <div class="ranking-column">
                  <div class="ranking-column-title">Men</div>
                  ${menHtml}
                </div>
                <div class="ranking-column">
                  <div class="ranking-column-title">Women</div>
                  ${womenHtml}
                </div>
              </div>`;
        }

        contentHtml += '</section>';

        resultsDiv.innerHTML = contentHtml;
        if (!resultsDiv.innerHTML.includes('athlete-card')) {
            resultsDiv.innerHTML = '<div class="empty-state">No matching athletes found.</div>';
        }

        // Smooth scroll to results
        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- Show athlete detail view with back button ---
    function showAthleteDetail(athlete, rank = null) {
        const resultsDiv = document.getElementById('results');

        // Update URL for sharing
        const newUrl = `?athlete=${athlete.athlete_id}`;
        history.pushState({ athleteId: athlete.athlete_id }, '', newUrl);

        // Helper to get rank class
        const getRankClass = (rank) => {
            if (rank === 1) return 'athlete-rank gold';
            if (rank === 2) return 'athlete-rank silver';
            if (rank === 3) return 'athlete-rank bronze';
            return 'athlete-rank';
        };

        const hasValidImage = athlete.athlete_profile_image && athlete.athlete_profile_image.startsWith('http');
        const imageHtml = hasValidImage ?
            `<img class="athlete-avatar" src="${athlete.athlete_profile_image}" alt="${athlete.athlete_full_name}" onerror="this.onerror=null; this.outerHTML='<div class=\\'athlete-placeholder\\'>${getInitials(athlete.athlete_full_name)}</div>'">` :
            `<div class="athlete-placeholder">${getInitials(athlete.athlete_full_name)}</div>`;

        const rankHtml = rank ? `<div class="${getRankClass(rank)}">${rank}</div>` : '';

        // Calculate age
        const currentYear = new Date().getFullYear();
        const age = athlete.athlete_yob ? currentYear - parseInt(athlete.athlete_yob) : null;

        // Favorite button
        const isFav = favoritesManager.isFavorite(athlete.athlete_id);
        const favoriteBtn = `
            <button class="favorite-btn ${isFav ? 'is-favorite' : ''}" onclick="toggleFavorite(${athlete.athlete_id}, this)" aria-label="Toggle favorite">
                <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            </button>`;

        // Compare button (hidden on mobile via CSS)
        const compareBtn = `
            <span class="compare-btn-wrapper">
                <button class="athlete-link athlete-link-secondary" onclick="startComparison(${athlete.athlete_id})">Compare</button>
            </span>`;

        // Share button
        const shareBtn = `<button class="athlete-link athlete-link-secondary" onclick="shareAthlete(${athlete.athlete_id}, '${athlete.athlete_full_name.replace(/'/g, "\\'")}')">Share</button>`;

        // Build results HTML
        const resultsHtml = (athlete.latest_results && athlete.latest_results.length > 0) ?
            `<div class="athlete-section">
                <div class="athlete-section-title">Recent Results</div>
                <div class="results-grid">${athlete.latest_results.slice(0, 6).map(result => {
                    const year = result.event_date ? new Date(result.event_date).getFullYear() : '';
                    const eventTitle = result.event_title || 'Race';
                    const position = parseInt(result.position) || 0;
                    const positionClass = position <= 3 ? 'result-position top3' : 'result-position';
                    const resultUrl = result.result_listing || '#';
                    return `<a href="${resultUrl}" target="_blank" class="result-item">
                        <div>
                            <div class="result-event">${eventTitle}</div>
                            <div class="result-year">${year}</div>
                        </div>
                        <div class="${positionClass}">${position > 0 ? '#' + position : '—'}</div>
                    </a>`;
                }).join('')}</div>
            </div>` : '';

        // Chart HTML - shows recent race finishes (no trend analysis)
        const chartHtml = (athlete.latest_results && athlete.latest_results.length >= 2) ?
            `<div class="athlete-section">
                <div class="athlete-section-title">Recent Race Finishes</div>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="results-chart"></canvas>
                </div>
            </div>` : '';

        // Build gallery HTML
        const galleryHtml = (athlete.latest_images && athlete.latest_images.length > 0) ?
            `<div class="athlete-section">
                <div class="athlete-section-title">Photos</div>
                <div class="gallery-grid">${athlete.latest_images.slice(0, 8).map(img => {
                    const imageUrl = img.thumbnail || img.image_url || '';
                    const fullUrl = img.image_url || '#';
                    return `<a href="${fullUrl}" target="_blank"><img src="${imageUrl}" alt="" loading="lazy" onerror="this.parentElement.style.display='none'"></a>`;
                }).join('')}</div>
            </div>` : '';

        const hasBodyContent = resultsHtml || chartHtml || galleryHtml;

        // Show back button only if we came from rankings
        const backBtnHtml = currentRankingsData ?
            `<button class="back-btn" onclick="displayRankings()">← Back to Rankings</button>` : '';

        resultsDiv.innerHTML = `
            <section class="results-section">
                ${backBtnHtml}
                <article class="athlete-card">
                    <div class="athlete-hero">
                        <div class="athlete-photo">
                            ${imageHtml}
                            ${rankHtml}
                        </div>
                        <div class="athlete-info">
                            <div class="athlete-header">
                                <span class="athlete-name">${athlete.athlete_full_name}</span>
                                <img class="athlete-flag" src="${athlete.athlete_flag || ''}" alt="" onerror="this.style.display='none'">
                                ${favoriteBtn}
                            </div>
                            <div class="athlete-country">${athlete.athlete_country_name || ''}</div>
                            <div class="athlete-stats">
                                ${age ? `<div class="athlete-stat"><span class="athlete-stat-label">Age</span><span class="athlete-stat-value">${age}</span></div>` : ''}
                                ${athlete.athlete_yob ? `<div class="athlete-stat"><span class="athlete-stat-label">Born</span><span class="athlete-stat-value">${athlete.athlete_yob}</span></div>` : ''}
                                ${athlete.athlete_categories ? `<div class="athlete-stat"><span class="athlete-stat-label">Category</span><span class="athlete-stat-value">${athlete.athlete_categories[0] || 'Athlete'}</span></div>` : ''}
                            </div>
                            <div class="athlete-actions">
                                <a href="${athlete.athlete_listing}" class="athlete-link" target="_blank">View on triathlon.org</a>
                                <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(athlete.athlete_full_name + ' triathlon')}" class="athlete-link athlete-link-secondary" target="_blank" rel="noopener">Videos ↗</a>
                                ${shareBtn}
                                ${compareBtn}
                            </div>
                        </div>
                    </div>
                    ${hasBodyContent ? `<div class="athlete-body">${chartHtml}${resultsHtml}${galleryHtml}</div>` : ''}
                </article>
            </section>`;

        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Render chart after DOM update
        if (athlete.latest_results && athlete.latest_results.length >= 2) {
            setTimeout(() => renderResultsChart(athlete.latest_results), 0);
        }
    }

    // --- Display rankings using compact rows ---
    function displayRankings() {
        if (!currentRankingsData) return;

        const resultsDiv = document.getElementById('results');
        const { men, women, title } = currentRankingsData;

        const count = men.filter(a => a).length + women.filter(a => a).length;

        // Function to generate compact ranking item
        const createRankingItem = (athlete, rank) => {
            const hasValidImage = athlete.athlete_profile_image && athlete.athlete_profile_image.startsWith('http');
            const photoHtml = hasValidImage ?
                `<img class="ranking-item-photo" src="${athlete.athlete_profile_image}" alt="" onerror="this.onerror=null; this.outerHTML='<div class=\\'ranking-item-placeholder\\'>${getInitials(athlete.athlete_full_name)}</div>'">` :
                `<div class="ranking-item-placeholder">${getInitials(athlete.athlete_full_name)}</div>`;

            const rankClass = rank <= 3 ? 'ranking-item-rank top3' : 'ranking-item-rank';
            const athleteIndex = rank - 1;
            const gender = men.includes(athlete) ? 'men' : 'women';

            return `
                <div class="ranking-item" onclick="showAthleteFromRankings('${gender}', ${athleteIndex}, ${rank})">
                    <span class="${rankClass}">${rank}</span>
                    ${photoHtml}
                    <div class="ranking-item-info">
                        <span class="ranking-item-name">${athlete.athlete_full_name}</span>
                        <div class="ranking-item-country">
                            <img class="ranking-item-flag" src="${athlete.athlete_flag || ''}" alt="" onerror="this.style.display='none'">
                            <span>${athlete.athlete_country_name || ''}</span>
                        </div>
                    </div>
                    <span class="ranking-item-arrow">›</span>
                </div>`;
        };

        const menHtml = men.filter(a => a).map((a, i) => createRankingItem(a, i + 1)).join('');
        const womenHtml = women.filter(a => a).map((a, i) => createRankingItem(a, i + 1)).join('');

        // Show "Load more" button if there are more rankings to load
        const hasMore = rankingsLoaded < RANKINGS_MAX;
        const loadMoreHtml = hasMore ? `
            <div style="text-align: center; margin-top: var(--space-6);">
                <button id="load-more-btn" class="quick-btn" onclick="loadMoreRankings()" style="padding: var(--space-3) var(--space-6);">
                    Load More (${rankingsLoaded}/${RANKINGS_MAX})
                </button>
            </div>
        ` : '';

        resultsDiv.innerHTML = `
            <section class="results-section">
                <div class="section-header">
                    <h2 class="section-title">${title}</h2>
                    <span class="section-meta">Showing ${count} of ${RANKINGS_MAX * 2} athletes</span>
                </div>
                <div class="rankings-grid">
                    <div class="ranking-column">
                        <div class="ranking-column-title">Men</div>
                        ${menHtml}
                    </div>
                    <div class="ranking-column">
                        <div class="ranking-column-title">Women</div>
                        ${womenHtml}
                    </div>
                </div>
                ${loadMoreHtml}
            </section>`;
    }

    // --- Show athlete from rankings data ---
    window.showAthleteFromRankings = function(gender, index, rank) {
        if (!currentRankingsData) return;
        const athlete = currentRankingsData[gender][index];
        if (athlete) {
            showAthleteDetail(athlete, rank);
        }
    }

    // --- Main search function ---
    window.searchAthlete = async function() {
      const name = document.getElementById('athleteName').value;
      if (!name.trim()) return;

      // Clear rankings context when doing a search
      currentRankingsData = null;

      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Searching athletes...</div>';

      const searchResponse = await fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(name)}`);

      if (!searchResponse.ok) {
        resultsDiv.innerHTML = `<div class="error-message">Error fetching athlete data. Please try again later.</div>`;
        return;
      }

      const searchData = await searchResponse.json();
      const athleteIds = (searchData.data || []).map(item => item.athlete_id);

      if (athleteIds.length === 0) {
        resultsDiv.innerHTML = '<div class="empty-state">No athletes found matching your search.</div>';
        return;
      }

      const athleteDetails = await Promise.all(
        athleteIds.map(id => getAthleteDetails(id))
      );

      // Use detailed view for single result, grid for multiple
      const validAthletes = athleteDetails.filter(a => a);
      if (validAthletes.length === 1) {
        showAthleteDetail(validAthletes[0]);
      } else {
        displayAthletes(validAthletes, `Search Results for "${name}"`);
      }
    }

    // --- Fetches top ranked athletes for both genders ---
    window.fetchTopRankings = async function() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Fetching top rankings...</div>';

      try {
        const [menResponse, womenResponse] = await Promise.all([
          fetch(`${API_BASE}?endpoint=/rankings/${RANKING_IDS.male}`),
          fetch(`${API_BASE}?endpoint=/rankings/${RANKING_IDS.female}`)
        ]);

        if (!menResponse.ok || !womenResponse.ok) {
            throw new Error('Unable to load rankings. Please try again later.');
        }

        const menData = await menResponse.json();
        const womenData = await womenResponse.json();

        // Store all ranking IDs for progressive loading
        rankingIds.men = (menData.data?.rankings?.slice(0, RANKINGS_MAX) || []).map(a => a.athlete_id);
        rankingIds.women = (womenData.data?.rankings?.slice(0, RANKINGS_MAX) || []).map(a => a.athlete_id);
        rankingsLoaded = 0;

        // Initialize rankings data
        currentRankingsData = {
            men: [],
            women: [],
            title: "WTCS Rankings"
        };

        // Load first batch
        await loadMoreRankings();

      } catch (error) {
          resultsDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
      }
    }

    // --- Load more rankings progressively ---
    window.loadMoreRankings = async function() {
      const resultsDiv = document.getElementById('results');
      const start = rankingsLoaded;
      const end = Math.min(rankingsLoaded + RANKINGS_PER_PAGE, RANKINGS_MAX);

      // Show loading indicator on button if it exists
      const loadMoreBtn = document.getElementById('load-more-btn');
      if (loadMoreBtn) {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'Loading...';
      }

      try {
        const menIdsToLoad = rankingIds.men.slice(start, end);
        const womenIdsToLoad = rankingIds.women.slice(start, end);

        const [menDetails, womenDetails] = await Promise.all([
            Promise.all(menIdsToLoad.map(id => getAthleteDetails(id))),
            Promise.all(womenIdsToLoad.map(id => getAthleteDetails(id)))
        ]);

        // Append to existing data
        currentRankingsData.men.push(...menDetails);
        currentRankingsData.women.push(...womenDetails);
        rankingsLoaded = end;

        // Update display
        displayRankings();

      } catch (error) {
        if (loadMoreBtn) {
          loadMoreBtn.disabled = false;
          loadMoreBtn.textContent = 'Load More';
        }
      }
    }

    // --- Home Page Function ---
    window.showHomePage = async function() {
        // Clear rankings context when going home
        currentRankingsData = null;

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading featured content...</div>';

        try {
            // Fetch photos and videos in parallel
            const [menResponse, womenResponse, videosResponse] = await Promise.all([
              fetch(`${API_BASE}?endpoint=/rankings/${RANKING_IDS.male}`),
              fetch(`${API_BASE}?endpoint=/rankings/${RANKING_IDS.female}`),
              fetch('/api/youtube?action=channelVideos&maxResults=2').catch(() => null)
            ]);

            if (!menResponse.ok || !womenResponse.ok) {
                throw new Error('Unable to load athlete data. Please try again later.');
            }

            const menData = await menResponse.json();
            const womenData = await womenResponse.json();

            // Process videos
            let videoGridHtml = '';
            if (videosResponse && videosResponse.ok) {
                const videosData = await videosResponse.json();
                if (videosData.items && videosData.items.length > 0) {
                    videoGridHtml = videosData.items.map(video => {
                        const videoId = video.id?.videoId;
                        const title = video.snippet?.title || 'Untitled';
                        const description = video.snippet?.description || '';
                        const channelName = video.channelName || video.snippet?.channelTitle || '';

                        return `
                            <a class="video-item" href="https://www.youtube.com/watch?v=${videoId}" target="_blank" rel="noopener">
                                <div class="video-item-title">${title}</div>
                                ${description ? `<div class="video-item-description">${description}</div>` : ''}
                                <div class="video-item-meta">${channelName} · YouTube</div>
                            </a>
                        `;
                    }).join('');
                }
            }

            const menRankings = menData.data?.rankings || [];
            const womenRankings = womenData.data?.rankings || [];

            // Get a random selection of ranked athletes to pull action photos from
            const allRanked = [...menRankings, ...womenRankings];
            const shuffledAthletes = allRanked.sort(() => 0.5 - Math.random()).slice(0, 12);

            const athleteDetails = await Promise.all(
                shuffledAthletes.map(a => getAthleteDetails(a.athlete_id))
            );

            // Collect action photos from athletes' latest_images
            const actionPhotos = [];
            athleteDetails.forEach(athlete => {
                if (athlete && athlete.latest_images && athlete.latest_images.length > 0) {
                    // Take 1-2 images per athlete for variety
                    const images = athlete.latest_images.slice(0, 2);
                    images.forEach(img => {
                        if (img.image_url || img.thumbnail) {
                            actionPhotos.push({
                                url: img.image_url || img.thumbnail,
                                thumbnail: img.thumbnail || img.image_url,
                                athleteName: athlete.athlete_full_name,
                                athleteCountry: athlete.athlete_country_name || '',
                                profileUrl: athlete.athlete_listing || '#'
                            });
                        }
                    });
                }
            });

            // Shuffle action photos for a fresh look each time
            const shuffledPhotos = actionPhotos.sort(() => 0.5 - Math.random()).slice(0, 12);

            // Build photo grid HTML with action shots
            const photoGridHtml = shuffledPhotos.length > 0
                ? shuffledPhotos.map(photo => `
                    <a class="photo-card" href="${photo.profileUrl}" target="_blank" rel="noopener">
                        <img src="${photo.thumbnail}" alt="Race photo - ${photo.athleteName}" onerror="this.parentElement.style.display='none'">
                        <div class="photo-card-overlay">
                            <div class="photo-card-name">${photo.athleteName}</div>
                            <div class="photo-card-country">${photo.athleteCountry}</div>
                        </div>
                    </a>
                `).join('')
                : '<p style="color: var(--text-secondary); padding: var(--space-4);">No recent race images available</p>';

            // Build the watch section - show videos if available, otherwise show channel links
            const watchSectionContent = videoGridHtml
                ? `<div class="video-list">${videoGridHtml}</div>
                   <div style="display: flex; gap: var(--space-3); flex-wrap: wrap; margin-top: var(--space-4);">
                       <a href="https://www.youtube.com/@worldtriathlon" target="_blank" rel="noopener" class="quick-btn">World Triathlon ↗</a>
                       <a href="https://www.youtube.com/@ironmantriathlon" target="_blank" rel="noopener" class="quick-btn">Ironman ↗</a>
                       <a href="https://www.youtube.com/@T100Triathlon" target="_blank" rel="noopener" class="quick-btn">T100 / PTO ↗</a>
                   </div>`
                : `<div style="display: flex; gap: var(--space-3); flex-wrap: wrap;">
                       <a href="https://www.youtube.com/@worldtriathlon" target="_blank" rel="noopener" class="quick-btn">World Triathlon ↗</a>
                       <a href="https://www.youtube.com/@ironmantriathlon" target="_blank" rel="noopener" class="quick-btn">Ironman ↗</a>
                       <a href="https://www.youtube.com/@T100Triathlon" target="_blank" rel="noopener" class="quick-btn">T100 / PTO ↗</a>
                   </div>`;

            resultsDiv.innerHTML = `
                <section class="home-section">
                    <div class="home-section-header">
                        <span class="home-section-title">Watch</span>
                    </div>
                    ${watchSectionContent}
                </section>
                <section class="home-section">
                    <div class="home-section-header">
                        <span class="home-section-title">Race Photos</span>
                        <a href="#" class="home-section-link" onclick="showHomePage(); return false;">Refresh ↻</a>
                    </div>
                    <div class="photo-grid">${photoGridHtml}</div>
                </section>
                <section class="home-section">
                    <div class="home-section-header">
                        <span class="home-section-title">External Rankings</span>
                    </div>
                    <div style="display: flex; gap: var(--space-3); flex-wrap: wrap;">
                        <a href="https://proseries.ironman.com/standings/2025" target="_blank" rel="noopener" class="quick-btn">Ironman Pro Series ↗</a>
                        <a href="https://stats.protriathletes.org/rankings" target="_blank" rel="noopener" class="quick-btn">PTO Rankings ↗</a>
                    </div>
                </section>
                <section class="home-section">
                    <div class="home-section-header">
                        <span class="home-section-title">Latest News</span>
                        <a href="https://triathlon.org/news" target="_blank" rel="noopener" class="home-section-link">triathlon.org/news ↗</a>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 14px;">Visit World Triathlon for the latest race results, athlete stories, and event coverage.</p>
                </section>
            `;

        } catch (error) {
            resultsDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
        }
    }

    // Helper to search and display a single athlete by name
    async function searchAndDisplayAthlete(name) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading athlete...</div>';
        try {
            const response = await fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(name)}&per_page=1`);
            if (!response.ok) throw new Error('Search failed');
            const data = await response.json();
            if (data.data && data.data.length > 0) {
                const details = await getAthleteDetails(data.data[0].athlete_id);
                if (details) {
                    displayAthletes([details], details.athlete_full_name);
                    return;
                }
            }
            resultsDiv.innerHTML = '<div class="error-message">Athlete not found</div>';
        } catch (error) {
            resultsDiv.innerHTML = `<div class="error-message">${error.message}</div>`;
        }
    }

    // --- Toggle favorite ---
    window.toggleFavorite = function(athleteId, btnElement) {
        const isNowFavorite = favoritesManager.toggle(athleteId);
        btnElement.classList.toggle('is-favorite', isNowFavorite);
        showToast(isNowFavorite ? 'Added to favorites' : 'Removed from favorites');
    };

    // --- Show favorites (consistent with rankings view) ---
    window.showFavorites = async function() {
        const favoriteIds = favoritesManager.getFavorites();
        const resultsDiv = document.getElementById('results');

        // Clear URL
        history.pushState({}, '', '?view=favorites');

        if (favoriteIds.length === 0) {
            resultsDiv.innerHTML = `
                <section class="results-section">
                    <div class="section-header">
                        <h2 class="section-title">Favorites</h2>
                    </div>
                    <div class="empty-state">No favorites yet. Click the star on any athlete to save them.</div>
                </section>`;
            return;
        }

        resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading favorites...</div>';

        const athletes = await Promise.all(favoriteIds.map(id => getAthleteDetails(id)));
        const validAthletes = athletes.filter(a => a);

        if (validAthletes.length === 0) {
            resultsDiv.innerHTML = '<div class="empty-state">No favorites found.</div>';
            return;
        }

        // Store for navigation
        window.favoritesData = validAthletes;

        // Create compact list view like rankings
        const createFavoriteItem = (athlete, index) => {
            const hasValidImage = athlete.athlete_profile_image && athlete.athlete_profile_image.startsWith('http');
            const photoHtml = hasValidImage ?
                `<img class="ranking-item-photo" src="${athlete.athlete_profile_image}" alt="" onerror="this.onerror=null; this.outerHTML='<div class=\\'ranking-item-placeholder\\'>${getInitials(athlete.athlete_full_name)}</div>'">` :
                `<div class="ranking-item-placeholder">${getInitials(athlete.athlete_full_name)}</div>`;

            return `
                <div class="ranking-item" onclick="showAthleteFromFavorites(${index})">
                    <span class="ranking-item-rank" style="color: #f59e0b;">★</span>
                    ${photoHtml}
                    <div class="ranking-item-info">
                        <span class="ranking-item-name">${athlete.athlete_full_name}</span>
                        <div class="ranking-item-country">
                            <img class="ranking-item-flag" src="${athlete.athlete_flag || ''}" alt="" onerror="this.style.display='none'">
                            <span>${athlete.athlete_country_name || ''}</span>
                        </div>
                    </div>
                    <span class="ranking-item-arrow">›</span>
                </div>`;
        };

        const favoritesHtml = validAthletes.map((a, i) => createFavoriteItem(a, i)).join('');

        resultsDiv.innerHTML = `
            <section class="results-section">
                <div class="section-header">
                    <h2 class="section-title">Favorites</h2>
                    <span class="section-meta">${validAthletes.length} athlete${validAthletes.length !== 1 ? 's' : ''}</span>
                </div>
                <div class="ranking-column" style="max-width: 600px;">
                    ${favoritesHtml}
                </div>
            </section>`;

        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    // --- Show athlete from favorites data ---
    window.showAthleteFromFavorites = function(index) {
        if (!window.favoritesData || !window.favoritesData[index]) return;
        showAthleteDetail(window.favoritesData[index]);
    };

    // --- Share athlete ---
    window.shareAthlete = function(athleteId, athleteName) {
        const url = `${window.location.origin}${window.location.pathname}?athlete=${athleteId}`;
        if (navigator.share) {
            navigator.share({ url, title: `${athleteName} - Triathlon Stats` });
        } else {
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard');
            });
        }
    };

    // --- Analyze trend ---
    function analyzeTrend(results) {
        if (!results || results.length < 4) return null;

        const sorted = [...results]
            .filter(r => r.event_date && r.position)
            .sort((a, b) => new Date(a.event_date) - new Date(b.event_date))
            .map(r => parseInt(r.position));

        if (sorted.length < 4) return null;

        // Split into halves
        const mid = Math.floor(sorted.length / 2);
        const firstHalf = sorted.slice(0, mid);
        const secondHalf = sorted.slice(mid);

        const avgFirst = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
        const avgSecond = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;

        // Calculate linear regression slope
        const n = sorted.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        sorted.forEach((pos, i) => {
            sumX += i;
            sumY += pos;
            sumXY += i * pos;
            sumX2 += i * i;
        });
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);

        return {
            avgFirst: avgFirst.toFixed(1),
            avgSecond: avgSecond.toFixed(1),
            slope,
            trend: slope < -0.3 ? 'improving' : slope > 0.3 ? 'declining' : 'stable',
            bestFinish: Math.min(...sorted),
            avgFinish: (sorted.reduce((a, b) => a + b, 0) / sorted.length).toFixed(1)
        };
    }

    // --- Render results chart (ultra-clean styling) ---
    function renderResultsChart(results) {
        const ctx = document.getElementById('results-chart');
        if (!ctx || results.length < 2) return;

        // Sort by date ascending
        const sortedResults = [...results]
            .filter(r => r.event_date && r.position)
            .sort((a, b) => new Date(a.event_date) - new Date(b.event_date));

        if (sortedResults.length < 2) return;

        // Get theme colors
        const styles = getComputedStyle(document.documentElement);
        const textColor = styles.getPropertyValue('--text-primary').trim();
        const textSecondary = styles.getPropertyValue('--text-secondary').trim();
        const borderColor = styles.getPropertyValue('--border-primary').trim();
        const bgSecondary = styles.getPropertyValue('--bg-secondary').trim();

        const positions = sortedResults.map(r => parseInt(r.position));
        const labels = sortedResults.map(r => {
            const date = new Date(r.event_date);
            return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        });

        new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Finish Position',
                    data: positions,
                    borderColor: textColor,
                    backgroundColor: bgSecondary,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: textColor,
                    pointBorderColor: textColor,
                    pointBorderWidth: 0,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 8, bottom: 8 }
                },
                scales: {
                    y: {
                        reverse: true,
                        min: 1,
                        ticks: {
                            color: textSecondary,
                            font: { size: 11, family: 'Inter' },
                            padding: 8,
                            stepSize: 1
                        },
                        grid: {
                            color: borderColor,
                            lineWidth: 1,
                            drawTicks: false
                        },
                        border: { display: false }
                    },
                    x: {
                        ticks: {
                            color: textSecondary,
                            font: { size: 11, family: 'Inter' },
                            padding: 8
                        },
                        grid: { display: false },
                        border: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: textColor,
                        titleColor: bgSecondary,
                        bodyColor: bgSecondary,
                        titleFont: { size: 12, weight: 500, family: 'Inter' },
                        bodyFont: { size: 13, weight: 600, family: 'Inter' },
                        padding: 12,
                        cornerRadius: 0,
                        displayColors: false,
                        callbacks: {
                            title: (items) => sortedResults[items[0].dataIndex]?.event_title || '',
                            label: (item) => `#${item.raw}`
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    // --- Comparison functions ---
    window.startComparison = async function(athleteId) {
        const athlete = await getAthleteDetails(athleteId);
        if (!athlete) return;

        comparisonState.athlete1 = athlete;
        comparisonState.mode = 'selecting';

        // Create modal
        const hasImage = athlete.athlete_profile_image?.startsWith('http');
        const overlay = document.createElement('div');
        overlay.className = 'comparison-modal-overlay';
        overlay.id = 'comparison-modal-overlay';
        overlay.innerHTML = `
            <div class="comparison-modal">
                <div class="comparison-modal-header">
                    <span class="comparison-modal-title">Compare Athletes</span>
                    <button class="comparison-modal-close" onclick="cancelComparison()">&times;</button>
                </div>
                <div class="comparison-modal-body">
                    <div class="comparison-modal-athlete">
                        ${hasImage ?
                            `<img class="comparison-modal-athlete-photo" src="${athlete.athlete_profile_image}" alt="">` :
                            `<div class="comparison-modal-athlete-placeholder">${getInitials(athlete.athlete_full_name)}</div>`
                        }
                        <div class="comparison-modal-athlete-info">
                            <div class="comparison-modal-athlete-name">${athlete.athlete_full_name}</div>
                            <div class="comparison-modal-athlete-country">${athlete.athlete_country_name || ''}</div>
                        </div>
                    </div>
                    <div class="comparison-modal-search">
                        <input type="text" id="comparison-search-input" placeholder="Search for second athlete..." autocomplete="off">
                        <div id="comparison-search-results" class="comparison-modal-results" style="display: none;"></div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);

        // Close on overlay click
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) cancelComparison();
        });

        // Setup search
        const searchInput = document.getElementById('comparison-search-input');
        searchInput.focus();
        searchInput.addEventListener('input', debounce(handleComparisonSearch, 300));
    };

    async function handleComparisonSearch() {
        const query = document.getElementById('comparison-search-input').value;
        const resultsDiv = document.getElementById('comparison-search-results');

        if (query.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }

        resultsDiv.innerHTML = '<div class="comparison-modal-loading">Searching...</div>';
        resultsDiv.style.display = 'block';

        const response = await fetch(`${API_BASE}?endpoint=/search/athletes&query=${encodeURIComponent(query)}&per_page=6`);
        if (!response.ok) {
            resultsDiv.style.display = 'none';
            return;
        }

        const data = await response.json();
        const athletes = data.data || [];

        if (athletes.length === 0) {
            resultsDiv.innerHTML = '<div class="comparison-modal-loading">No athletes found</div>';
            return;
        }

        // Fetch details for photos
        const details = await Promise.all(athletes.map(a => getAthleteDetails(a.athlete_id)));

        resultsDiv.innerHTML = details.filter(a => a).map(athlete => {
            const hasImage = athlete.athlete_profile_image?.startsWith('http');
            return `
                <div class="comparison-modal-item" onclick="selectComparisonAthlete(${athlete.athlete_id})">
                    ${hasImage ?
                        `<img class="comparison-modal-item-photo" src="${athlete.athlete_profile_image}" alt="">` :
                        `<div class="comparison-modal-item-placeholder">${getInitials(athlete.athlete_full_name)}</div>`
                    }
                    <div class="comparison-modal-item-info">
                        <div class="comparison-modal-item-name">${athlete.athlete_full_name}</div>
                        <div class="comparison-modal-item-country">${athlete.athlete_country_name || ''}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    window.selectComparisonAthlete = async function(athleteId) {
        const athlete = await getAthleteDetails(athleteId);
        if (!athlete) return;

        comparisonState.athlete2 = athlete;
        comparisonState.mode = 'comparing';
        document.getElementById('comparison-modal-overlay')?.remove();
        showComparison();
    };

    window.cancelComparison = function() {
        comparisonState = { athlete1: null, athlete2: null, mode: 'idle' };
        document.getElementById('comparison-modal-overlay')?.remove();
    };

    window.showComparison = function() {
        const { athlete1, athlete2 } = comparisonState;
        if (!athlete1 || !athlete2) return;

        document.getElementById('comparison-banner')?.remove();
        document.getElementById('athleteName').placeholder = 'Search athlete name...';

        const resultsDiv = document.getElementById('results');

        const createComparisonCard = (athlete) => {
            const hasImage = athlete.athlete_profile_image?.startsWith('http');
            const currentYear = new Date().getFullYear();
            const age = athlete.athlete_yob ? currentYear - parseInt(athlete.athlete_yob) : null;

            return `
                <div class="comparison-card">
                    ${hasImage ?
                        `<img class="comparison-card-photo" src="${athlete.athlete_profile_image}" alt="" onerror="this.style.display='none'">` :
                        `<div class="comparison-card-photo" style="display:flex;align-items:center;justify-content:center;font-size:24px;color:var(--text-tertiary)">${getInitials(athlete.athlete_full_name)}</div>`
                    }
                    <div class="comparison-card-name">${athlete.athlete_full_name}</div>
                    <div class="comparison-card-country">${athlete.athlete_country_name || ''}</div>
                    <div class="comparison-stats">
                        ${age ? `<div><div class="comparison-stat-label">Age</div><div class="comparison-stat-value">${age}</div></div>` : ''}
                        ${athlete.athlete_yob ? `<div><div class="comparison-stat-label">Born</div><div class="comparison-stat-value">${athlete.athlete_yob}</div></div>` : ''}
                        ${athlete.athlete_categories ? `<div><div class="comparison-stat-label">Category</div><div class="comparison-stat-value">${athlete.athlete_categories[0] || ''}</div></div>` : ''}
                    </div>
                </div>
            `;
        };

        resultsDiv.innerHTML = `
            <section class="results-section">
                <button class="back-btn" onclick="cancelComparison(); fetchTopRankings();">← Back</button>
                <div class="section-header">
                    <h2 class="section-title">Head to Head</h2>
                </div>
                <div class="comparison-grid">
                    ${createComparisonCard(athlete1)}
                    <div class="comparison-vs">VS</div>
                    ${createComparisonCard(athlete2)}
                </div>
                <div class="athlete-section">
                    <div class="athlete-section-title">Recent Race Finishes</div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                </div>
            </section>
        `;

        // Render comparison chart
        setTimeout(() => renderComparisonChart(athlete1, athlete2), 0);
    };

    function renderComparisonChart(athlete1, athlete2) {
        const ctx = document.getElementById('comparison-chart');
        if (!ctx) return;

        const prepareData = (results) => {
            if (!results) return { labels: [], data: [], titles: [] };
            const sorted = [...results]
                .filter(r => r.event_date && r.position)
                .sort((a, b) => new Date(a.event_date) - new Date(b.event_date));
            return {
                labels: sorted.map(r => new Date(r.event_date).toLocaleDateString('en-US', { month: 'short', year: '2-digit' })),
                data: sorted.map(r => parseInt(r.position)),
                titles: sorted.map(r => r.event_title)
            };
        };

        const data1 = prepareData(athlete1.latest_results);
        const data2 = prepareData(athlete2.latest_results);

        // Merge labels
        const allLabels = [...new Set([...data1.labels, ...data2.labels])].sort((a, b) => {
            const parseDate = (str) => new Date(str.replace(/(\w+) '(\d+)/, '$1 20$2'));
            return parseDate(a) - parseDate(b);
        });

        const styles = getComputedStyle(document.documentElement);
        const textSecondary = styles.getPropertyValue('--text-secondary').trim();
        const borderColor = styles.getPropertyValue('--border-primary').trim();
        const bgSecondary = styles.getPropertyValue('--bg-secondary').trim();

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: allLabels,
                datasets: [
                    {
                        label: athlete1.athlete_full_name,
                        data: allLabels.map(l => {
                            const idx = data1.labels.indexOf(l);
                            return idx >= 0 ? data1.data[idx] : null;
                        }),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.08)',
                        fill: true,
                        spanGaps: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderWidth: 0,
                        borderWidth: 2
                    },
                    {
                        label: athlete2.athlete_full_name,
                        data: allLabels.map(l => {
                            const idx = data2.labels.indexOf(l);
                            return idx >= 0 ? data2.data[idx] : null;
                        }),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.08)',
                        fill: true,
                        spanGaps: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#ef4444',
                        pointBorderWidth: 0,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 8, bottom: 8 }
                },
                scales: {
                    y: {
                        reverse: true,
                        min: 1,
                        ticks: {
                            color: textSecondary,
                            font: { size: 11, family: 'Inter' },
                            padding: 8,
                            stepSize: 1
                        },
                        grid: {
                            color: borderColor,
                            lineWidth: 1,
                            drawTicks: false
                        },
                        border: { display: false }
                    },
                    x: {
                        ticks: {
                            color: textSecondary,
                            font: { size: 11, family: 'Inter' },
                            padding: 8
                        },
                        grid: { display: false },
                        border: { display: false }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        align: 'end',
                        labels: {
                            color: textSecondary,
                            font: { size: 12, family: 'Inter' },
                            boxWidth: 12,
                            boxHeight: 12,
                            padding: 16,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: '#171717',
                        titleColor: '#fafafa',
                        bodyColor: '#fafafa',
                        titleFont: { size: 12, weight: 500, family: 'Inter' },
                        bodyFont: { size: 13, weight: 600, family: 'Inter' },
                        padding: 12,
                        cornerRadius: 0,
                        displayColors: true,
                        boxWidth: 8,
                        boxHeight: 8,
                        boxPadding: 4
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    // --- URL Routing ---
    function handleRouting() {
        const params = new URLSearchParams(window.location.search);

        const athleteId = params.get('athlete');
        if (athleteId) {
            loadAthleteFromUrl(athleteId);
            return;
        }

        const view = params.get('view');
        if (view === 'favorites') {
            showFavorites();
            return;
        }
        if (view === 'rankings') {
            fetchTopRankings();
            return;
        }

        fetchTopRankings();
    }

    async function loadAthleteFromUrl(athleteId) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>Loading athlete...</div>';

        const details = await getAthleteDetails(parseInt(athleteId));
        if (details) {
            showAthleteDetail(details);
        } else {
            resultsDiv.innerHTML = '<div class="error-message">Athlete not found.</div>';
        }
    }

    // Handle browser back/forward
    window.addEventListener('popstate', handleRouting);

    // --- Load page based on URL ---
    handleRouting();

  </script>
</body>
</html>
